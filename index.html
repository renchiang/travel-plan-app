<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÊóÖÈÅäË®àÁï´ | Travel Plan</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #020617; /* Ê∑±Ëâ≤ËÉåÊôØ */
        }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        #map-container { z-index: 1; }
        .gps-pulse {
            width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%;
            background-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in-up 0.4s ease-out forwards; }
    </style>
</head>
<body class="text-slate-100 bg-slate-900 h-screen flex flex-col overflow-hidden">

    <div id="app" class="relative flex flex-col h-full max-w-md mx-auto w-full bg-slate-900/90 backdrop-blur shadow-2xl sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-800">

        <!-- HeaderÔºö‰∏äÊñπÂ§ßÊ®ô + Êó•Êúü + ÂÄíÊï∏ -->
        <header class="bg-gradient-to-b from-slate-900 via-slate-900/95 to-slate-900 text-white shrink-0 z-20">
            <div class="px-4 pt-4 pb-3 flex items-start justify-center relative">
                <!-- Â∑¶‰∏äËßíÔºöÊóÖÁ®ãÈÅ∏ÂñÆÊåâÈàï -->
                <button
                    @click="showTripMenu = true"
                    class="absolute left-4 top-4 text-slate-300 hover:text-white transition">
                    <i class="ph-bold ph-list text-2xl"></i>
                </button>
        
                <!-- ‰∏≠ÈñìÔºöÁõÆÁöÑÂú∞ + Êó•Êúü + ÂÄíÊï∏ -->
                <div class="overflow-hidden text-center">
                    <div class="flex items-center justify-center gap-2">
                        <h1 class="text-2xl font-bold tracking-wide truncate">
                            {{ setup.destination || 'ÊóÖÈÅäË®àÁï´' }}
                        </h1>
                        <i class="ph-fill ph-airplane-tilt text-lg opacity-70"></i>
                    </div>
                    <p class="text-xs text-slate-400 mt-1 truncate">
                        {{ tripDateRange || 'Ë´ãÂú®ÊóÖÁ®ãË®≠ÂÆö‰∏≠ÈÅ∏ÊìáÊó•ÊúüËàáÂ§©Êï∏' }}
                    </p>
                    <p v-if="daysToTrip !== null" class="text-[11px] text-teal-200 mt-0.5">
                        <span v-if="daysToTrip > 0">Ë∑ùÈõ¢Âá∫ÁôºÈÇÑÊúâ <span class="font-bold">{{ daysToTrip }}</span> Â§©</span>
                        <span v-else-if="daysToTrip === 0">‰ªäÂ§©Â∞±ÊòØÂá∫ÁôºÊó• üöÄ</span>
                        <span v-else>ÊóÖÁ®ãÂ∑≤ÈñãÂßãÁ¨¨ <span class="font-bold">{{ Math.abs(daysToTrip) + 1 }}</span> Â§©</span>
                    </p>
                </div>
            </div>

            <!-- Êó•ÊúüÂàó -->
            <div class="border-t border-slate-800/80 pt-2 pb-3 px-2 bg-slate-900/90">
                <div class="flex overflow-x-auto hide-scroll space-x-3 snap-x">
                    <div
                        v-for="(day, index) in days"
                        :key="index"
                        @click="currentDayIdx = index"
                        class="snap-center shrink-0 flex flex-col items-center justify-center w-[4.2rem] h-16 rounded-xl cursor-pointer transition-all border"
                        :class="currentDayIdx === index
                            ? 'bg-emerald-500/90 text-slate-900 border-emerald-300 shadow-lg scale-105'
                            : 'bg-slate-800/80 text-slate-200 border-slate-700 hover:bg-slate-700'">
                        <span class="text-[11px] font-medium opacity-80">{{ day.shortDate }}</span>
                        <span class="text-lg font-bold">D{{ index + 1 }}</span>
                    </div>
                    <button
                        @click="addDay"
                        class="shrink-0 w-14 h-16 rounded-xl flex items-center justify-center border border-dashed border-slate-600 text-slate-300 hover:border-emerald-300 hover:text-emerald-200 transition">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </div>
            </div>
        </header>        

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 relative hide-scroll pb-24">

            <!-- Ë°åÁ®ãË°® (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 space-y-6">
                    <!-- ‰ªäÊó•ÊëòË¶Å + Â§©Ê∞£ -->
                    <div class="bg-slate-800/90 p-4 rounded-2xl shadow-sm border border-slate-700 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <!-- Èö±ÂΩ¢Êó•ÊúüÈÅ∏ÊìáÂô® -->
                            <input type="date" :value="currentDay.fullDate" @change="updateDate($event, currentDay)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <!-- Êó•ÊúüÈ°ØÁ§∫ -->
                            <input
                                v-model="currentDay.date"
                                class="text-lg font-bold text-slate-50 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none"
                                placeholder="Day 1 (ÈªûÊìäË®≠ÂÆö)">
                            <input
                                v-model="currentDay.title"
                                class="text-sm text-slate-300 bg-transparent border-b border-dashed border-slate-500 focus:border-teal-400 focus:outline-none w-full mt-1"
                                placeholder="Ëº∏ÂÖ•Áï∂Êó•‰∏ªÈ°å (‰æãÂ¶ÇÔºöÊñ∞ÂÆøÈÄõË°ó / Ê≤≥Âè£Êπñ‰∏ÄÊó•ÈÅä)">
                        </div>
                        <!-- Â§©Ê∞£È°ØÁ§∫ -->
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-amber-300">
                                    <i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i>
                                    <span class="text-xl font-bold font-mono whitespace-nowrap">{{ weatherDisplay.temp }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                    <i :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>
                                    {{ weatherDisplay.label }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ëà™Áè≠Âç°Áâá -->
                    <div>
                        <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-sky-600 via-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden">
                            <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-900 rounded-full z-10"></div>
                            <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-900 rounded-full z-10"></div>
                            <div class="p-4 relative z-0">
                                <button @click="toggleFlightCard" class="absolute top-2 right-2 text-white/60 hover:text-white hover:bg-white/20 rounded-full p-1 transition">
                                    <i class="ph-bold ph-x"></i>
                                </button>
                                <div class="flex justify-between items-center mb-1 pt-2">
                                    <!-- Âá∫Áôº -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.startTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/40 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="text-[9px] opacity-70 mt-1">Ëµ∑È£õ (Áï∂Âú∞ÊôÇÈñì)</div>
                                        <input v-model="currentDay.flight.startAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-emerald-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="TPE">
                                    </div>
                                    <!-- Ë≥áË®ä -->
                                    <div class="flex flex-col items-center justify-center w-1/3 px-2">
                                        <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                                        <input v-model="currentDay.flight.number" class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="BR198">
                                        <div class="w-full h-0.5 bg-white/40 rounded-full mt-1"></div>
                                    </div>
                                    <!-- ÊäµÈÅî -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.endTime" type="time" class="text-2xl font-black bg-transparent border-b border-white/40 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="relative w-full mt-0.5">
                                            <select v-model="currentDay.flight.arrivalOffset" class="appearance-none bg-black/30 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center focus:ring-0 cursor-pointer hover:bg-black/40">
                                                <option value="0" class="text-slate-800">ÂêåÊó•ÊäµÈÅî</option>
                                                <option value="1" class="text-slate-800">+1Â§© (ÈöîÊó•)</option>
                                                <option value="-1" class="text-slate-800">-1Â§© (ÂâçÊó•)</option>
                                            </select>
                                            <div v-if="currentDay.flight.arrivalOffset != 0" class="absolute -top-8 right-0 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow font-bold animate-pulse">
                                                {{ currentDay.flight.arrivalOffset > 0 ? '+1' : '-1' }}
                                            </div>
                                        </div>
                                        <input v-model="currentDay.flight.endAirport" class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-emerald-100 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="NRT">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button
                            v-else
                            @click="toggleFlightCard"
                            class="mt-1 w-full py-3 border border-dashed border-slate-600 rounded-2xl text-slate-300 hover:border-teal-400 hover:text-teal-200 hover:bg-slate-800/70 transition flex items-center justify-center gap-2 group">
                            <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-bold">Êñ∞Â¢ûÁï∂Êó•Ëà™Áè≠Ë≥áË®ä</span>
                        </button>
                    </div>

                    <!-- Ë°åÁ®ã Timeline -->
                    <div class="relative pl-4 border-l border-slate-700 space-y-6">
                        <div
                            v-for="(item, idx) in currentDay.items"
                            :key="idx"
                            class="relative group">
                            <!-- ÁØÄÈªû -->
                            <div class="absolute -left-[21px] top-3 w-3 h-3 rounded-full border-2 border-slate-900 shadow-sm" :class="getDotColor(item.type)"></div>

                            <div class="bg-slate-800/90 p-3 rounded-xl shadow-sm border border-slate-700 hover:shadow-lg transition-shadow">
                                <div class="grid grid-cols-[auto,1fr,auto] gap-3 items-start">
                                    <!-- ÊôÇÈñì + È°ûÂà• -->
                                    <div class="flex flex-col items-center w-20 gap-2">
                                        <div class="relative flex flex-col items-center justify-center bg-slate-900/80 border border-slate-700 rounded-xl p-1 w-full h-16 cursor-pointer hover:bg-teal-950 hover:border-teal-500/60 transition group/time">
                                            <span class="text-[10px] font-medium text-slate-400 group-hover/time:text-teal-300">{{ getTimePeriod(item.time) }}</span>
                                            <span class="text-xl font-bold text-slate-50 group-hover/time:text-teal-200 leading-none font-mono tracking-tight">{{ item.time || '--:--' }}</span>
                                            <input v-model="item.time" type="time" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                        </div>
                                        <select v-model="item.type" class="text-[10px] bg-slate-900 border border-slate-700 rounded-md py-1 px-1 w-full text-center text-slate-100">
                                            <option value="spot">üìç ÊôØÈªû</option>
                                            <option value="food">üç¥ ÁæéÈ£ü</option>
                                            <option value="shop">üõçÔ∏è Ë≥ºÁâ©</option>
                                            <option value="transport">üöá ‰∫§ÈÄö</option>
                                            <option value="flight">‚úàÔ∏è Ëà™Áè≠</option>
                                        </select>
                                    </div>

                                    <!-- ÂÖßÂÆπ -->
                                    <div class="flex-1 min-w-0 pt-1 space-y-1">
                                        <input v-model="item.activity" class="block w-full font-bold text-slate-50 bg-transparent border-none p-0 focus:ring-0" placeholder="Ë°åÁ®ãÂêçÁ®±...">
                                        <div class="flex items-center gap-1">
                                            <i class="ph-fill ph-map-pin text-teal-400 text-xs"></i>
                                            <input v-model="item.location" class="flex-1 text-xs text-slate-300 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="Ëº∏ÂÖ•Âú∞Èªû (‰æãÂ¶Ç: Êñ∞ÂÆøÁ´ô„ÄÅÊ∑∫ËçâÂØ∫)">
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <i class="ph-bold ph-info text-orange-400 text-xs"></i>
                                            <input v-model="item.note" class="flex-1 text-xs text-orange-200/90 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="ÂÇôË®ª (‰æãÂ¶Ç: ÈúÄÈ†êÁ¥Ñ„ÄÅ‰∫§ÈÄöÊñπÂºè)">
                                        </div>

                                        <!-- ‰∫§ÈÄöÊñπÂºè -->
                                        <div class="flex items-center gap-1 mt-1">
                                            <i class="ph-bold ph-train text-sky-400 text-xs"></i>
                                            <select
                                                v-model="item.transport"
                                                class="flex-1 text-xs text-slate-300 bg-transparent border border-slate-600 rounded px-1 py-0.5 focus:ring-0">
                                                <option value="">ÈÅ∏Êìá‰∫§ÈÄöÊñπÂºè</option>
                                                <option value="walk">Ëµ∞Ë∑Ø</option>
                                                <option value="bus">ÂÖ¨Ëªä</option>
                                                <option value="train">ÈõªËªä</option>
                                                <option value="taxi">Ë®àÁ®ãËªä</option>
                                            </select>
                                        </div>

                                        <!-- È†ê‰º∞ÊâÄÈúÄÊôÇÈñìÔºàËá™Âãï / ÊâãÂãïÔºâ -->
                                        <div class="flex items-center gap-1">
                                            <i class="ph-bold ph-clock text-sky-300 text-xs"></i>
                                            <input
                                                v-model="item.duration"
                                                class="flex-1 text-xs text-slate-300 bg-transparent border-none p-0 focus:ring-0 truncate"
                                                placeholder="È†ê‰º∞ÊôÇÈñìÔºå‰æãÂ¶Ç 15 ÂàÜÈêò (ÂèØËá™ÂãïË®àÁÆóÊàñÊâãÂãïËº∏ÂÖ•)">
                                            <button
                                                v-if="idx > 0 && item.location && currentDay.items[idx-1].location"
                                                @click="estimateDuration(idx)"
                                                class="text-[10px] text-teal-300 border border-teal-500/60 px-1.5 py-0.5 rounded-lg hover:bg-teal-500/10">
                                                Ëá™Âãï
                                            </button>
                                        </div>

                                        <!-- ÁæéÈ£üÊé®Ëñ¶ -->
                                        <div v-if="item.type === 'food'" class="mt-2 p-2 bg-amber-500/10 rounded-lg border border-amber-500/30">
                                            <div class="flex items-center justify-between mb-1">
                                                <p class="text-[10px] font-bold text-amber-300 flex items-center gap-1">
                                                    <i class="ph-fill ph-fork-knife"></i> ÁæéÈ£üÊé®Ëñ¶
                                                </p>
                                                <button
                                                    @click="searchNearby(item, idx)"
                                                    class="text-[10px] text-teal-200 hover:text-teal-50 flex items-center gap-1 bg-slate-900/80 px-2 py-0.5 rounded border border-teal-500/40 shadow-sm"
                                                    :disabled="!item.location">
                                                    <i v-if="isSearchingRecs && searchTargetIndex === `${currentDayIdx}-${idx}`" class="ph-bold ph-spinner animate-spin"></i>
                                                    <i v-else class="ph-bold ph-magnifying-glass"></i>
                                                    ÊêúÂ∞ã
                                                </button>
                                            </div>
                                            
                                            <div v-if="recommendationsMap[`${currentDayIdx}-${idx}`] && recommendationsMap[`${currentDayIdx}-${idx}`].length > 0" class="flex flex-wrap gap-2 mt-1">
                                                <button
                                                    v-for="rec in recommendationsMap[`${currentDayIdx}-${idx}`]"
                                                    :key="rec.name"
                                                    @click="applyRecommendation(item, rec)"
                                                    class="text-[10px] px-2 py-1.5 bg-slate-900/80 border border-amber-300/40 rounded-lg text-slate-100 hover:bg-amber-500 hover:text-slate-900 hover:border-amber-500 transition shadow-sm flex flex-col items-start gap-0.5 max-w-[140px] truncate">
                                                    <span class="font-bold truncate w-full text-left">{{ rec.name }}</span>
                                                </button>
                                            </div>
                                            <div v-else-if="!item.location" class="text-[9px] text-slate-400 italic">
                                                Ë´ãÂÖàËº∏ÂÖ•Âú∞Èªû (‰æãÂ¶Ç: ÊæÄË∞∑)ÔºåÂÜçÈªûÊìäÊêúÂ∞ã
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Êìç‰Ωú -->
                                    <div class="flex flex-col gap-2 items-center pt-1">
                                        <a :href="getGoogleMapLink(item.location)" target="_blank" class="text-teal-300 hover:bg-slate-900/70 p-1 rounded">
                                            <i class="ph-bold ph-navigation-arrow"></i>
                                        </a>
                                        <button @click="removeItem(idx)" class="text-red-300 hover:text-red-500 p-1 rounded">
                                            <i class="ph-bold ph-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="addItem" class="flex items-center gap-2 text-teal-300 hover:text-teal-100 text-sm font-medium px-2 py-1">
                            <div class="w-2 h-2 bg-teal-400 rounded-full"></div>
                            <i class="ph-bold ph-plus"></i> Êñ∞Â¢ûË°åÁ®ã
                        </button>
                    </div>

                    <div class="pt-4 border-t border-slate-800 text-center">
                        <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto">
                            <i class="ph-bold ph-trash"></i> Âà™Èô§ÈÄô‰∏ÄÂ§©
                        </button>
                    </div>
                </div>
            </transition>

            <!-- Âú∞ÂúñË¶ñÂúñ -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                <div id="map" class="flex-1 w-full h-full bg-slate-800 z-0"></div>
                <div v-if="isMapLoading" class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-teal-200">
                    <i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i>
                    <span class="text-xs font-bold">ËÆÄÂèñ‰∏≠...</span>
                </div>
                <div class="absolute bottom-24 left-4 right-4 bg-slate-900/85 backdrop-blur rounded-xl p-3 shadow-lg border border-slate-700 z-10 flex justify-between items-center">
                    <div class="text-sm font-bold text-slate-100">üìç {{ currentDay.items.filter(i=>i.location).length }} ÂÄãÂú∞Èªû</div>
                    <div class="flex gap-2">
                        <button @click="initMap" class="p-2 bg-slate-800 text-teal-200 rounded-lg border border-slate-600 hover:bg-slate-700">
                            <i class="ph-bold ph-arrows-clockwise"></i>
                        </button>
                        <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-400">
                            <i class="ph-bold ph-crosshair"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÂàÜÂ∏≥Ë¶ñÂúñ -->
            <div v-if="viewMode === 'money'" class="p-4 space-y-4">
                <div class="bg-gradient-to-br from-teal-700 via-emerald-600 to-cyan-600 text-white rounded-2xl p-6 shadow-lg text-center relative">
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-teal-100 mb-1">ÂåØÁéá ({{ currencyLabel }})</label>
                        <input v-model.number="exchangeRate" type="number" step="0.001" class="w-20 text-right text-xs text-teal-900 rounded px-1 py-0.5">
                    </div>
                    <div class="text-sm opacity-80 mb-1">Á∏ΩÊîØÂá∫ Total</div>
                    <div class="text-4xl font-bold font-mono">{{ currencySymbol }} {{ totalExpense.toLocaleString() }}</div>
                    <div class="text-lg font-bold text-teal-100 mt-1">
                        ‚âà NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}
                    </div>
                </div>

                <!-- Âø´ÈÄüÊèõÁÆó -->
                <div class="bg-slate-800/90 rounded-xl shadow-sm p-4 border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs font-bold text-slate-300 flex items-center gap-1">
                            <i class="ph-bold ph-currency-circle-dollar"></i> Âø´ÈÄüÂåØÁéáÊèõÁÆó
                        </div>
                        <div class="text-[10px] text-slate-400">
                            {{ currencySymbol }} ‚Üí NT$
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input
                            v-model.number="convertAmount"
                            type="number"
                            :placeholder="currencySymbol + ' ÈáëÈ°ç'"
                            class="w-1/2 bg-slate-900 border border-slate-600 rounded-lg text-sm px-3 py-2 font-mono text-slate-100">
                        <span class="text-slate-300 text-xs">‚âà</span>
                        <div class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 flex items-center justify-between">
                            <span class="text-xs text-slate-400">NT$</span>
                            <span class="font-mono font-bold text-emerald-300">{{ convertToTwd.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>

                <!-- ÊàêÂì°Ë®≠ÂÆöÔºöÂèØ‰∏≠ÈÄîÊñ∞Â¢û / Âà™Èô§ / ÊîπÂêç -->
                <div class="bg-slate-800/90 p-4 rounded-xl border border-slate-700 shadow-sm space-y-3">
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-xs font-bold text-slate-300 flex items-center gap-1">
                            <i class="ph-bold ph-users-three"></i> ÂàÜÂ∏≥ÊàêÂì°
                        </div>
                        <button
                            @click="addParticipant"
                            class="text-[11px] text-teal-300 border border-teal-500/60 px-2 py-0.5 rounded-lg hover:bg-teal-500/10 flex items-center gap-1">
                            <i class="ph-bold ph-plus-circle"></i> Êñ∞Â¢ûÊàêÂì°
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div
                            v-for="(p, idx) in participants"
                            :key="idx"
                            class="flex items-center gap-2 bg-slate-900/80 rounded-xl px-3 py-2 border border-slate-700">
                            <div class="w-7 h-7 rounded-full bg-teal-900 flex items-center justify-center text-teal-200 text-xs font-bold">
                                {{ p.charAt(0) || 'Êàê' }}
                            </div>
                            <input
                                :value="p"
                                @change="renameParticipant(idx, $event.target.value)"
                                class="flex-1 bg-transparent border-none text-sm text-slate-100 focus:ring-0"
                                placeholder="Ëº∏ÂÖ•ÊàêÂì°ÂêçÁ®±">
                            <button
                                @click="removeParticipant(idx)"
                                class="text-slate-500 hover:text-red-400"
                                :disabled="participants.length <= 1">
                                <i class="ph-bold ph-minus-circle text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÊØèÂÄã‰∫∫ÁõÆÂâçÁ∏ΩÂ¢ä‰ªò -->
                <div class="grid grid-cols-2 gap-2">
                    <div v-for="p in participants" :key="p" class="bg-slate-800/90 p-3 rounded-xl border border-slate-700 text-center shadow-sm">
                        <div class="text-xs text-slate-400 mb-1">{{ p }} Â¢ä‰ªò</div>
                        <div class="text-sm font-bold text-teal-300">{{ currencySymbol }}{{ paidByPerson[p]?.toLocaleString() || 0 }}</div>
                    </div>
                </div>

                <!-- ÁµêÂ∏≥Âª∫Ë≠∞ -->
                <div v-if="settlementPlan.length > 0" class="bg-emerald-900/40 rounded-xl p-4 border border-emerald-500/40">
                    <h3 class="text-xs font-bold text-emerald-200 uppercase tracking-wide mb-3 flex items-center gap-1">
                        <i class="ph-bold ph-handshake"></i> ÁµêÂ∏≥Âª∫Ë≠∞
                    </h3>
                    <div class="space-y-2">
                        <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between text-sm bg-slate-900/80 p-2 rounded-lg shadow-sm border border-slate-700">
                            <span class="font-bold text-slate-100">
                                {{ plan.from }} <i class="ph-bold ph-arrow-right text-xs"></i> {{ plan.to }}
                            </span>
                            <span class="font-mono font-bold text-emerald-300">{{ currencySymbol }}{{ plan.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>

                <!-- Êñ∞Â¢ûÊîØÂá∫ -->
                <div class="bg-slate-800/90 rounded-xl shadow-sm p-4 border border-slate-700">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newExpense.item" placeholder="È†ÖÁõÆ" class="w-[45%] bg-slate-900 border-none rounded-lg text-sm px-3 py-2 text-slate-100">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-900 border-none rounded-lg text-sm px-2 py-2 min-w-0 text-slate-100">
                            <option v-for="p in participants" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input v-model.number="newExpense.amount" type="number" :placeholder="currencySymbol + ' ÈáëÈ°ç'" class="w-full bg-slate-900 border-none rounded-lg text-sm pl-3 pr-3 py-2 font-mono text-slate-100">
                        <button @click="addExpense" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 rounded-lg font-bold">
                            <i class="ph-bold ph-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- ÊîØÂá∫ÂàóË°® -->
                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-slate-800/90 p-3 rounded-xl border border-slate-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-teal-900 flex items-center justify-center text-teal-300 text-xs font-bold">
                                {{ exp.payer.charAt(0) }}
                            </div>
                            <div>
                                <div class="font-bold text-slate-100 text-sm">{{ exp.item }}</div>
                                <div class="text-[11px] text-slate-400">{{ exp.payer }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-bold text-slate-100">{{ currencySymbol }}{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-500 hover:text-red-400">
                                <i class="ph-fill ph-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊóÖÈÅäÊ∏ÖÂñÆË¶ñÂúñ -->
            <div v-if="viewMode === 'checklist'" class="p-4 space-y-4">
                <!-- Êï¥È´îÂÆåÊàêÂ∫¶ -->
                <div class="bg-slate-800/90 rounded-2xl p-4 border border-slate-700 shadow-sm flex items-center justify-between">
                    <div>
                        <div class="text-xs text-slate-300 mb-1 flex items-center gap-1">
                            <i class="ph-bold ph-checks"></i> ÊóÖÈÅäÊ∏ÖÂñÆÁ∏ΩÂÆåÊàêÂ∫¶
                        </div>
                        <div class="text-lg font-bold text-slate-50">
                            {{ checklistStats.done }} / {{ checklistStats.total }} È†Ö
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="w-24 h-2 rounded-full bg-slate-900 overflow-hidden">
                            <div class="h-full bg-emerald-400" :style="{ width: checklistStats.percent + '%' }"></div>
                        </div>
                        <div class="text-xs text-emerald-200 font-mono">
                            {{ checklistStats.percent }}%
                        </div>
                    </div>
                </div>

                <!-- ÊØèÂÄãÂçÄÂ°ä‰∏ÄÂÄãÂÆåÊàêÂ∫¶Ê¢ù -->
                <div v-for="section in checklistSections" :key="section.id" class="bg-slate-800/90 rounded-2xl p-4 border border-slate-700 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center">
                                <i :class="['ph-bold', section.icon, 'text-lg text-teal-300']"></i>
                            </div>
                            <div>
                                <div class="text-sm font-bold text-slate-50">{{ section.title }}</div>
                                <div class="text-[11px] text-slate-400">
                                    {{ sectionProgress(section).done }} / {{ sectionProgress(section).total }} È†Ö
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="w-24 h-2 rounded-full bg-slate-900 overflow-hidden">
                                <div class="h-full bg-emerald-400" :style="{ width: sectionProgress(section).percent + '%' }"></div>
                            </div>
                            <div class="text-[11px] text-emerald-200 font-mono">
                                {{ sectionProgress(section).percent }}%
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <button @click="addChecklistItem(section.id)" class="text-xs text-teal-300 hover:text-teal-100 flex items-center gap-1">
                            <i class="ph-bold ph-plus-circle"></i> Êñ∞Â¢û
                        </button>
                    </div>

                    <div class="space-y-2">
                        <div
                            v-for="(item, idx) in section.items"
                            :key="idx"
                            class="flex items-center gap-2 bg-slate-900/80 rounded-xl px-2 py-2 border border-slate-700">
                            <button
                                @click="toggleChecklistItem(section.id, idx)"
                                class="w-6 h-6 rounded-full flex items-center justify-center border"
                                :class="item.done ? 'bg-emerald-500 border-emerald-400 text-slate-900' : 'border-slate-600 text-slate-500'">
                                <i v-if="item.done" class="ph-bold ph-check text-xs"></i>
                            </button>
                            <input
                                v-model="item.text"
                                class="flex-1 bg-transparent border-none text-sm text-slate-100 focus:ring-0"
                                :class="item.done ? 'line-through text-slate-500' : ''"
                                placeholder="Ëº∏ÂÖ•‰∫ãÈ†ÖÔºå‰æãÂ¶ÇÔºöÁ¢∫Ë™çË≠∑ÁÖßÊúâÊïàÊúüÈôê">
                            <button @click="removeChecklistItem(section.id, idx)" class="text-slate-500 hover:text-red-400">
                                <i class="ph-bold ph-trash text-xs"></i>
                            </button>
                        </div>
                        <div v-if="section.items.length === 0" class="text-[11px] text-slate-500 italic">
                            ÈÇÑÊ≤íÊúâÈ†ÖÁõÆÔºåÈªû„ÄåÊñ∞Â¢û„ÄçÈñãÂßãÂª∫Á´ãÊ∏ÖÂñÆ„ÄÇ
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÁøªË≠ØÂäüËÉΩ -->
            <div v-if="viewMode === 'translate'" class="p-6 h-full flex flex-col justify-center items-center">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-slate-50 mb-2">Google ÁøªË≠ØÊç∑Âæë</h2>
                    <p class="text-sm text-slate-400">Ë´ãÈÅ∏ÊìáÊÇ®ÈúÄË¶ÅÁöÑÁøªË≠ØÊ®°Âºè</p>
                </div>
                <div class="w-full mb-4">
                    <a href="https://translate.google.com/?op=images" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs opacity-80 mb-1 tracking-wider">ËèúÂñÆ / ÁúãÊùø</div>
                                    <div class="text-2xl font-bold">ÁÖßÁõ∏ÁøªË≠Ø <i class="ph-bold ph-camera text-sm"></i></div>
                                </div>
                                <i class="ph-duotone ph-camera-plus text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full mb-4">
                    <a :href="`https://translate.google.com/?sl=zh-TW&tl=${setup.langCode}&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-gradient-to-br from-indigo-500 to-blue-600 text-white rounded-2xl p-6 shadow-lg active:scale-95 transition-transform relative overflow-hidden group">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs opacity-80 mb-1 tracking-wider">ÊàëË™™‰∏≠Êñá (ËΩâ{{ setup.langName }})</div>
                                    <div class="text-2xl font-bold">
                                        CH <i class="ph-bold ph-arrow-right text-sm"></i> {{ setup.langCode.toUpperCase() }}
                                    </div>
                                </div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl opacity-60 group-hover:opacity-100"></i>
                            </div>
                        </button>
                    </a>
                </div>
                <div class="w-full">
                    <a :href="`https://translate.google.com/?sl=${setup.langCode}&tl=zh-TW&op=translate`" target="_blank" class="block w-full">
                        <button class="w-full bg-slate-900 border-2 border-slate-600 text-slate-100 rounded-2xl p-6 shadow-sm active:scale-95 transition-transform relative overflow-hidden group hover:border-indigo-300">
                            <div class="relative z-10 flex items-center justify-between">
                                <div class="text-left">
                                    <div class="text-xs text-slate-400 mb-1 tracking-wider">Â∞çÊñπË™™{{ setup.langName }} (ËΩâ‰∏≠Êñá)</div>
                                    <div class="text-2xl font-bold font-jp">
                                        {{ setup.langCode.toUpperCase() }} <i class="ph-bold ph-arrow-right text-sm"></i> CH
                                    </div>
                                </div>
                                <i class="ph-duotone ph-arrow-square-out text-3xl text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                            </div>
                        </button>
                    </a>
                </div>
            </div>
        </main>

        <!-- Â∫ïÈÉ®Âõ∫ÂÆöÂ∞éËà™Âàó -->
        <nav class="absolute bottom-0 left-0 right-0 pb-3 px-4 z-30">
            <div class="max-w-md mx-auto bg-slate-950/95 border border-slate-700 rounded-2xl shadow-[0_8px_30px_rgba(0,0,0,0.7)] px-2 py-1 flex justify-between">
                <button
                    @click="viewMode = 'plan'"
                    class="flex-1 flex flex-col items-center py-1 rounded-xl mx-1 text-[11px]"
                    :class="viewMode === 'plan' ? 'bg-slate-800 text-emerald-300' : 'text-slate-400 hover:text-slate-100'">
                    <i class="ph-bold ph-calendar-check text-lg mb-0.5"></i>
                    Ë°åÁ®ã
                </button>
                <button
                    @click="viewMode = 'map'"
                    class="flex-1 flex flex-col items-center py-1 rounded-xl mx-1 text-[11px]"
                    :class="viewMode === 'map' ? 'bg-slate-800 text-emerald-300' : 'text-slate-400 hover:text-slate-100'">
                    <i class="ph-bold ph-map-trifold text-lg mb-0.5"></i>
                    Âú∞Âúñ
                </button>
                <button
                    @click="viewMode = 'money'"
                    class="flex-1 flex flex-col items-center py-1 rounded-xl mx-1 text-[11px]"
                    :class="viewMode === 'money' ? 'bg-slate-800 text-emerald-300' : 'text-slate-400 hover:text-slate-100'">
                    <i class="ph-bold ph-currency-dollar text-lg mb-0.5"></i>
                    ÂàÜÂ∏≥
                </button>
                <button
                    @click="viewMode = 'checklist'"
                    class="flex-1 flex flex-col items-center py-1 rounded-xl mx-1 text-[11px]"
                    :class="viewMode === 'checklist' ? 'bg-slate-800 text-emerald-300' : 'text-slate-400 hover:text-slate-100'">
                    <i class="ph-bold ph-check-square-offset text-lg mb-0.5"></i>
                    Ê∏ÖÂñÆ
                </button>
                <button
                    @click="viewMode = 'translate'"
                    class="flex-1 flex flex-col items-center py-1 rounded-xl mx-1 text-[11px]"
                    :class="viewMode === 'translate' ? 'bg-slate-800 text-emerald-300' : 'text-slate-400 hover:text-slate-100'">
                    <i class="ph-bold ph-translate text-lg mb-0.5"></i>
                    ÁøªË≠Ø
                </button>
            </div>
        </nav>
        
        <!-- ÂÅ¥ÈÇäÊ¨Ñ (ÊóÖÁ®ãÈÅ∏ÂñÆ) -->
        <transition name="slide">
            <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                <div class="bg-slate-900 w-4/5 max-w-xs h-full shadow-2xl flex flex-col relative z-50 p-6 border-r border-slate-800">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-50">ÊàëÁöÑÊóÖÁ®ã</h2>
                        <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-100">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>
                    <button @click="createNewTrip" class="w-full py-3 mb-6 border-2 border-dashed border-teal-400 text-teal-200 rounded-xl font-bold hover:bg-slate-800 flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus-circle"></i> Âª∫Á´ãÊñ∞ÊóÖÁ®ã
                    </button>
                    <div class="flex-1 overflow-y-auto space-y-3 hide-scroll">
                        <div
                            v-for="trip in tripList"
                            :key="trip.id" 
                            @click="switchTrip(trip.id)"
                            class="p-4 rounded-xl border transition cursor-pointer relative group"
                            :class="currentTripId === trip.id ? 'bg-teal-900/70 border-teal-400 shadow-sm' : 'bg-slate-800 border-transparent hover:bg-slate-700'">
                            <div class="font-bold text-slate-50">{{ trip.destination || 'Êú™ÂëΩÂêçË°åÁ®ã' }}</div>
                            <div class="text-xs text-slate-400 mt-1">{{ trip.startDate }} ‚Ä¢ {{ trip.daysCount }} Â§©</div>
                            <button
                                v-if="tripList.length > 1"
                                @click.stop="deleteTrip(trip.id)"
                                class="absolute right-3 top-3 text-slate-500 hover:text-red-400 p-1">
                                <i class="ph-bold ph-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-black/50 backdrop-blur-sm z-40" @click="showTripMenu = false"></div>
            </div>
        </transition>

        <!-- ÂàùÂßãË®≠ÂÆöË¶ñÁ™ó -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-6 animate-fade-in">
            <div class="bg-slate-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative border border-slate-700">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-teal-900 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="ph-duotone ph-airplane-tilt text-3xl text-teal-300"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-50">Âª∫Á´ãÊñ∞ÊóÖÁ®ã</h2>
                    <p class="text-sm text-slate-400">Á∞°ÂñÆÂπæÊ≠•ÔºåÈñãÂßãË¶èÂäÉÊÇ®ÁöÑÂÜíÈö™ÔºÅ</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ÁõÆÁöÑÂú∞ (Ëã±Êñá/‰∏≠Êñá)</label>
                        <div class="relative">
                            <input v-model="setup.destination" @blur="detectRate" type="text" placeholder="‰æãÂ¶Ç: Tokyo, Osaka" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-slate-100 focus:ring-2 focus:ring-teal-500 font-bold">
                            <button @click="detectRate" class="absolute right-3 top-3 text-teal-400 hover:text-teal-200">
                                <i class="ph-bold ph-magnifying-glass"></i>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ÈñãÂßãÊó•Êúü</label>
                            <input v-model="setup.startDate" type="date" class="h-12 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 text-slate-100 focus:ring-2 focus:ring-teal-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">Â§©Êï∏</label>
                            <input v-model.number="setup.days" type="number" min="1" max="30" class="h-12 w-full bg-slate-900 border border-slate-700 rounded-xl px-3 text-slate-100 focus:ring-2 focus:ring-teal-500 text-center font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1 ml-1 flex justify-between">
                            <span>ÂåØÁéá ({{ setup.currency || 'Â§ñÂπ£' }}:Âè∞Âπ£)</span>
                            <span v-if="isRateLoading" class="text-teal-400 animate-pulse">ÊäìÂèñ‰∏≠...</span>
                        </label>
                        <input v-model.number="setup.rate" type="number" step="0.001" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-slate-100 focus:ring-2 focus:ring-teal-500 font-mono text-right">
                    </div>
                    <button @click="initTrip" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2 mt-2">
                        ÈñãÂßãË¶èÂäÉ <i class="ph-bold ph-arrow-right"></i>
                    </button>
                    <button v-if="tripList.length>0" @click="showSetupModal = false" class="w-full text-slate-400 text-xs py-2 hover:text-slate-200">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        
        const useFirebase = false; 
        const firebaseConfig = { /* apiKey: "...", ... */ };

        let appInstance, db;
        let mapInstance = null;
        let userMarker = null;

        if (useFirebase) {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(m => {
                appInstance = m.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(f => {
                    db = f.getFirestore(appInstance);
                });
            });
        }

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isOnline = ref(false);
                const isFirebaseReady = ref(false);
                let geoWatchId = null;

                const showTripMenu = ref(false);
                const tripList = ref([]);
                const currentTripId = ref(null);
                const showSetupModal = ref(false);

                const days = ref([]);
                const expenses = ref([]);
                const participants = ref(['Êàë', 'ÊóÖ‰º¥A']);
                const participantsStr = ref('Êàë, ÊóÖ‰º¥A');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'Êàë' });

                const convertAmount = ref(0);

                const isRateLoading = ref(false);
                const isMapLoading = ref(false);
                const userLocation = ref(null);
                const weather = ref({ temp: null, icon: 'ph-sun', code: 0, location: '', daily: [] });
                const setup = ref({
                    destination: 'Tokyo',
                    startDate: new Date().toISOString().split('T')[0],
                    days: 5,
                    rate: 0.215,
                    currency: 'JPY',
                    langCode: 'ja',
                    langName: 'Êó•Êñá'
                });

                const checklistSections = ref([
                    {
                        id: 'pre',
                        title: 'Ë°åÂâçÊ∏ÖÂñÆ',
                        icon: 'ph-clipboard-text',
                        items: [
                            { text: 'Á¢∫Ë™çË≠∑ÁÖßÊúâÊïàÊúüÈôê', done: false },
                            { text: 'Á¢∫Ë™çÊ©üÁ•® / È£ØÂ∫óË®ÇÂñÆ', done: false },
                            { text: '‰∏ãËºâÈõ¢Á∑öÂú∞Âúñ / ‰∫§ÈÄö App', done: false }
                        ]
                    },
                    {
                        id: 'shop',
                        title: 'Ë≥ºÁâ©Ê∏ÖÂñÆ',
                        icon: 'ph-bag',
                        items: [
                            { text: 'Ëó•Â¶ù / ‰øùÈ§äÂìÅ', done: false },
                            { text: '‰º¥ÊâãÁ¶Æ / Á¶ÆÁâ©', done: false },
                            { text: 'Áï∂Âú∞ÈôêÂÆöÂïÜÂìÅ', done: false }
                        ]
                    }
                ]);

                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');

                const currentDay = computed(() => days.value[currentDayIdx.value] || {items:[], flight:null, date:'', title:''});
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (item.amount || 0), 0));

                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => {
                        if (map[e.payer] === undefined) map[e.payer] = 0;
                        map[e.payer] += (e.amount || 0);
                    });
                    return map;
                });

                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0 || participants.value.length === 0) return [];
                    const average = totalExpense.value / participants.value.length;
                    let balances = participants.value.map(p => ({
                        name: p,
                        val: (paidByPerson.value[p] || 0) - average
                    }));
                    let debtors = balances.filter(b => b.val < -1).sort((a, b) => a.val - b.val);
                    let creditors = balances.filter(b => b.val > 1).sort((a, b) => b.val - a.val);
                    const result = [];
                    let i = 0; let j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let debtor = debtors[i];
                        let creditor = creditors[j];
                        let amount = Math.min(Math.abs(debtor.val), creditor.val);
                        amount = Math.round(amount);
                        if (amount > 0) result.push({ from: debtor.name, to: creditor.name, amount: amount });
                        debtor.val += amount; creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (creditor.val < 1) j++;
                    }
                    return result;
                });

                const currencyLabel = computed(() => setup.value.currency || 'Â§ñÂπ£');
                const currencySymbol = computed(() => {
                    const map = { 'JPY': '¬•', 'CNY': '¬•', 'USD': '$', 'EUR': '‚Ç¨', 'KRW': '‚Ç©', 'GBP': '¬£', 'TWD': 'NT$', 'HKD': 'HK$', 'THB': '‡∏ø', 'VND': '‚Ç´' };
                    return map[setup.value.currency] || '$';
                });

                const convertToTwd = computed(() => {
                    const v = Number(convertAmount.value || 0);
                    if (!v || !exchangeRate.value) return 0;
                    return Math.round(v * exchangeRate.value);
                });

                const weatherDisplay = computed(() => {
                    if (!currentDay.value || !currentDay.value.fullDate || weather.value.daily.length === 0) {
                        return {
                            temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                            icon: weather.value.icon || 'ph-sun',
                            label: `${setup.value.destination || 'Áï∂Âú∞'} (ÁõÆÂâç)`,
                            isForecast: false
                        };
                    }
                    const targetDate = currentDay.value.fullDate;
                    const idx = weather.value.daily.time.indexOf(targetDate);
                    if (idx !== -1) {
                        const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                        const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                        return {
                            temp: `${min}¬∞ - ${max}¬∞`,
                            icon: getWeatherIcon(weather.value.daily.weathercode[idx]),
                            label: `${setup.value.destination} (È†êÂ†±)`,
                            isForecast: true
                        };
                    }
                    return {
                        temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                        icon: weather.value.icon || 'ph-sun',
                        label: `${setup.value.destination} (ÁõÆÂâç)`,
                        isForecast: false
                    };
                });

                const daysToTrip = computed(() => {
                    if (!setup.value.startDate) return null;
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const start = new Date(setup.value.startDate);
                    start.setHours(0,0,0,0);
                    const diffMs = start - today;
                    return Math.round(diffMs / (1000 * 60 * 60 * 24));
                });

                const tripDateRange = computed(() => {
                    if (!setup.value.startDate || !setup.value.days) return '';
                    const start = new Date(setup.value.startDate);
                    const end = new Date(start);
                    end.setDate(start.getDate() + (setup.value.days - 1));

                    const fmt = (d) => {
                        const m = d.getMonth() + 1;
                        const day = d.getDate();
                        return `${m}/${day}`;
                    };
                    return `${fmt(start)} - ${fmt(end)} ‚Ä¢ ${setup.value.days} Â§©`;
                });

                const checklistStats = computed(() => {
                    let total = 0;
                    let done = 0;
                    checklistSections.value.forEach(sec => {
                        sec.items.forEach(i => {
                            if (!i.text) return;
                            total++;
                            if (i.done) done++;
                        });
                    });
                    const percent = total ? Math.round(done / total * 100) : 0;
                    return { total, done, percent };
                });

                const sectionProgress = (section) => {
                    let total = 0;
                    let done = 0;
                    section.items.forEach(i => {
                        if (!i.text) return;
                        total++;
                        if (i.done) done++;
                    });
                    const percent = total ? Math.round(done / total * 100) : 0;
                    return { total, done, percent };
                };

                const generateId = () => 'trip_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                const getWeatherIcon = (c) => {
                    if (c === 0) return 'ph-sun';
                    if (c < 4) return 'ph-cloud-sun';
                    if (c < 50) return 'ph-cloud-fog';
                    if (c < 70) return 'ph-cloud-rain';
                    return 'ph-cloud';
                };
                const getTimePeriod = (t) => {
                    if(!t) return 'ÊôÇÈñì';
                    const h = parseInt(t.split(':')[0]);
                    return h<5?'ÂáåÊô®':h<11?'‰∏äÂçà':h<14?'‰∏≠Âçà':h<18?'‰∏ãÂçà':'Êôö‰∏ä';
                };
                const toggleFlightCard = () => {
                     if (currentDay.value.flight) {
                        if(confirm('ÁßªÈô§Ëà™Áè≠?')) currentDay.value.flight = null;
                     } else {
                        currentDay.value.flight = {
                            type: 'arrival',
                            startTime: '10:00',
                            startAirport: 'TPE',
                            number: 'FLIGHT',
                            endTime: '14:00',
                            endAirport: 'DEST',
                            arrivalOffset: 0
                        };
                     }
                };
                const getDotColor = (t) => t==='food'
                    ? 'bg-orange-400'
                    : t==='shop'
                        ? 'bg-pink-400'
                        : t==='flight'
                            ? 'bg-blue-500'
                            : 'bg-teal-400';

                const updateDate = (e, day) => {
                    const val = e.target.value;
                    if(!val) return;
                    day.fullDate = val;
                    const d = new Date(val);
                    if(isNaN(d.getTime())) return;
                    const w = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][d.getDay()];
                    const mm = d.getMonth()+1; const dd = d.getDate();
                    day.date = `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${w})`;
                    day.shortDate = `${mm}/${dd}`;
                };

                const addItem = () => currentDay.value.items.push({
                    time: '',
                    type: 'spot',
                    activity: '',
                    location: '',
                    note: '',
                    transport: '',
                    duration: ''
                });

                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => {
                    const idx = days.value.length + 1;
                    days.value.push({ date: `Day ${idx}`, shortDate: `D${idx}`, title: '', items: [], flight: null });
                };
                const removeCurrentDay = () => {
                    if(days.value.length>1 && confirm('Âà™Èô§?')) {
                        days.value.splice(currentDayIdx.value, 1);
                        if (currentDayIdx.value >= days.value.length) currentDayIdx.value = days.value.length - 1;
                    }
                };
                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const addExpense = () => {
                    if (!newExpense.value.item || !newExpense.value.amount) return;
                    expenses.value.unshift({...newExpense.value});
                    newExpense.value.item='';
                    newExpense.value.amount='';
                };
                const removeExpense = (idx) => expenses.value.splice(idx, 1);

                const addChecklistItem = (sectionId) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items.push({ text: '', done: false });
                };
                const removeChecklistItem = (sectionId, idx) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items.splice(idx, 1);
                };
                const toggleChecklistItem = (sectionId, idx) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    const item = sec.items[idx];
                    if (!item) return;
                    item.done = !item.done;
                };

                const searchNearby = async (item, idx) => {
                    if (!item.location || item.type !== 'food') return;
                    const key = `${currentDayIdx.value}-${idx}`;
                    searchTargetIndex.value = key;
                    isSearchingRecs.value = true;
                    recommendationsMap[key] = [];
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData && geoData.length > 0) {
                            const query = `restaurant near ${item.location}`;
                            const searchRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=4`);
                            const searchData = await searchRes.json();
                            recommendationsMap[key] = searchData.map(place => ({
                                name: place.name || place.display_name.split(',')[0], 
                                location: place.name || place.display_name.split(',')[0],
                                note: 'Êé®Ëñ¶Âú∞Èªû'
                            }));
                            if (recommendationsMap[key].length === 0) {
                                recommendationsMap[key] = [{
                                    name: 'Êâæ‰∏çÂà∞Êé®Ëñ¶ÔºåË´ãÂòóË©¶Êõ¥Á≤æÁ¢∫Âú∞Èªû',
                                    location: item.location,
                                    note: ''
                                }];
                            }
                        }
                    } catch (e) {
                        console.error("Êé®Ëñ¶ÊêúÂ∞ãÂ§±Êïó", e);
                    } finally {
                        isSearchingRecs.value = false;
                        searchTargetIndex.value = '';
                    }
                };
                
                const applyRecommendation = (item, rec) => {
                    item.activity = rec.name;
                    item.location = rec.name;
                };

                const estimateDuration = async (idx) => {
                    const prev = currentDay.value.items[idx - 1];
                    const curr = currentDay.value.items[idx];
                    if (!prev.location || !curr.location) return;
                    const modeMap = {
                        walk: 'walking',
                        bus: 'driving',    // Ëøë‰ºº
                        train: 'transit',
                        taxi: 'driving'
                    };
                    const mode = modeMap[curr.transport] || 'walking';
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(prev.location)}&destination=${encodeURIComponent(curr.location)}&travelmode=${mode}`;
                    // ‰∏çËÉΩÁõ¥Êé•Âú®ÂâçÁ´ØÂëºÂè´ Google Directions APIÔºåÊâÄ‰ª•ÈÄôË£°Áî®„ÄåÊâìÈñã Google Maps„ÄçÁöÑÊñπÂºèËºîÂä©Ôºå
                    // ‰∏¶Âú®Ê¨Ñ‰ΩçÊîæ‰∏ÄÂÄãÊèêÁ§∫Â≠ó‰∏≤ÔºåÊèêÈÜí‰ΩøÁî®ËÄÖËá™Â∑±ÁúãÊôÇÈñìÂ°´„ÄÇ
                    curr.duration = 'Ë´ãÂú® Google Maps ‰∏≠Êü•ÁúãÊôÇÈñìÂæåÂ°´ÂØ´';
                    window.open(url, '_blank');
                };

                const countryInfoMap = {
                    'jp': {c:'JPY',l:'ja',n:'Êó•Êñá'},
                    'kr': {c:'KRW',l:'ko',n:'ÈüìÊñá'},
                    'us': {c:'USD',l:'en',n:'Ëã±Êñá'},
                    'cn': {c:'CNY',l:'zh-CN',n:'Á∞°‰∏≠'},
                    'th': {c:'THB',l:'th',n:'Ê≥∞Êñá'},
                    'tw': {c:'TWD',l:'zh-TW',n:'‰∏≠Êñá'}
                };

                const detectRate = async () => {
                    if(!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1&addressdetails=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]?.address?.country_code) {
                            const info = countryInfoMap[geoData[0].address.country_code.toLowerCase()] || {c:'USD',l:'en',n:'Ëã±Êñá'};
                            setup.value.currency = info.c;
                            setup.value.langCode = info.l;
                            setup.value.langName = info.n;
                            if(info.c === 'TWD') {
                                setup.value.rate = 1;
                            } else {
                                const rRes = await fetch(`https://api.exchangerate-api.com/v4/latest/${info.c}`);
                                const rData = await rRes.json();
                                if(rData?.rates?.TWD) setup.value.rate = rData.rates.TWD;
                            }
                            exchangeRate.value = setup.value.rate;
                        }
                    } catch(e) {
                        console.error(e);
                    } finally {
                        isRateLoading.value = false;
                    }
                };

                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]) {
                            const {lat, lon} = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if(wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch(e) {
                        console.error(e);
                        weather.value.temp = '--';
                    }
                };

                const loadTripList = () => {
                    const list = localStorage.getItem('travel_app_index');
                    tripList.value = list ? JSON.parse(list) : [];
                };
                const saveTripList = () => {
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                };
                const createNewTrip = () => {
                    setup.value = {
                        destination: '',
                        startDate: new Date().toISOString().split('T')[0],
                        days: 5,
                        rate: 0.215,
                        currency: 'JPY',
                        langCode: 'ja',
                        langName: 'Êó•Êñá'
                    };
                    showSetupModal.value = true;
                    showTripMenu.value = false;
                };

                const updateParticipants = () => {
                    const arr = participantsStr.value
                        .split(',')
                        .map(s => s.trim())
                        .filter(Boolean);
                    if (arr.length > 0) {
                        participants.value = arr;
                    } else {
                        participants.value = ['Êàë'];
                    }
                    if (!participants.value.includes(newExpense.value.payer)) {
                        newExpense.value.payer = participants.value[0] || 'Êàë';
                    }
                };

                // ÂàÜÂ∏≥ÊàêÂì°Êìç‰ΩúÔºöÊñ∞Â¢û / Âà™Èô§ / ÊîπÂêç
                const addParticipant = () => {
                    const baseName = 'ÊàêÂì°';
                    let idx = participants.value.length + 1;
                    let name = `${baseName}${idx}`;
                    while (participants.value.includes(name)) {
                        idx++;
                        name = `${baseName}${idx}`;
                    }
                    participants.value.push(name);
                };

                const removeParticipant = (idx) => {
                    if (participants.value.length <= 1) return;
                    const name = participants.value[idx];
                    if (!confirm(`Ë¶ÅÁßªÈô§ÊàêÂì°„Äå${name}„Äç‰ª•Âèä‰ªñ/Â•πÁöÑÊâÄÊúâÊîØÂá∫ÂóéÔºü`)) return;
                    participants.value.splice(idx, 1);
                    expenses.value = expenses.value.filter(e => e.payer !== name);
                    if (!participants.value.includes(newExpense.value.payer)) {
                        newExpense.value.payer = participants.value[0] || '';
                    }
                };

                const renameParticipant = (idx, newName) => {
                    const oldName = participants.value[idx];
                    if (!newName || newName === oldName) return;
                    participants.value[idx] = newName;
                    expenses.value.forEach(e => {
                        if (e.payer === oldName) e.payer = newName;
                    });
                };

                // participants ËÆäÂãïÊôÇÔºåÂêåÊ≠• participantsStr ‰ª•Âèä newExpense.payer
                watch(participants, (val) => {
                    participantsStr.value = val.join(', ');
                    if (!val.includes(newExpense.value.payer)) {
                        newExpense.value.payer = val[0] || '';
                    }
                }, { deep: true });

                const initTrip = () => {
                    if(!setup.value.destination) { alert('Ë´ãËº∏ÂÖ•ÁõÆÁöÑÂú∞'); return; }
                    const newId = generateId();
                    const newTripMeta = {
                        id: newId,
                        destination: setup.value.destination,
                        startDate: setup.value.startDate,
                        daysCount: setup.value.days
                    };
                    
                    const newDays = [];
                    const start = new Date(setup.value.startDate);
                    const dNames = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start);
                        curr.setDate(start.getDate()+i);
                        const mm = curr.getMonth()+1; const dd = curr.getDate();
                        const yyyy = curr.getFullYear();
                        const fullDate = `${yyyy}-${mm < 10 ? '0'+mm : mm}-${dd < 10 ? '0'+dd : dd}`;
                        newDays.push({
                            date: `${mm < 10 ? '0'+mm : mm}/${dd < 10 ? '0'+dd : dd} (${dNames[curr.getDay()]})`,
                            shortDate: `${mm}/${dd}`,
                            fullDate: fullDate,
                            title: i===0?'ÊäµÈÅî & Êé¢Á¥¢':'Ë°åÁ®ãË¶èÂäÉ',
                            items: [],
                            flight: null
                        });
                    }

                    localStorage.setItem(`${newId}_days`, JSON.stringify(newDays));
                    localStorage.setItem(`${newId}_exp`, '[]');
                    localStorage.setItem(`${newId}_users`, participantsStr.value);
                    localStorage.setItem(`${newId}_rate`, setup.value.rate.toString());
                    localStorage.setItem(`${newId}_config`, JSON.stringify(setup.value));

                    tripList.value.unshift(newTripMeta);
                    saveTripList();
                    
                    switchTrip(newId);
                    showSetupModal.value = false;
                };
                const deleteTrip = (id) => {
                    if(!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Ë°åÁ®ãÔºüÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) return;
                    tripList.value = tripList.value.filter(t => t.id !== id);
                    saveTripList();
                    localStorage.removeItem(`${id}_days`);
                    localStorage.removeItem(`${id}_exp`);
                    localStorage.removeItem(`${id}_users`);
                    localStorage.removeItem(`${id}_rate`);
                    localStorage.removeItem(`${id}_config`);
                    if(currentTripId.value === id) {
                        if(tripList.value.length > 0) switchTrip(tripList.value[0].id);
                        else { days.value=[]; currentTripId.value=null; showSetupModal.value=true; }
                    }
                };
                const switchTrip = (id) => {
                    currentTripId.value = id;
                    showTripMenu.value = false;
                    const lDays = localStorage.getItem(`${id}_days`);
                    const lExp = localStorage.getItem(`${id}_exp`);
                    const lUsers = localStorage.getItem(`${id}_users`);
                    const lRate = localStorage.getItem(`${id}_rate`);
                    const lConf = localStorage.getItem(`${id}_config`);

                    if(lDays) days.value = JSON.parse(lDays);
                    if(lExp) expenses.value = JSON.parse(lExp);
                    if(lUsers) { participantsStr.value = lUsers; updateParticipants(); }
                    if(lRate) exchangeRate.value = parseFloat(lRate);
                    if(lConf) {
                        const conf = JSON.parse(lConf);
                        setup.value = conf;
                        exchangeRate.value = conf.rate || exchangeRate.value;
                        fetchWeather(conf.destination);
                    }
                };

                const initMap = async () => { 
                    isMapLoading.value = true;
                    await nextTick();
                    if (!document.getElementById('map')) return;
                    if (mapInstance) { mapInstance.remove(); mapInstance = null; }
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(mapInstance);

                    if ("geolocation" in navigator) {
                        if (geoWatchId !== null) navigator.geolocation.clearWatch(geoWatchId);
                        geoWatchId = navigator.geolocation.watchPosition(pos => {
                            userLocation.value = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            const icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: "<div class='gps-pulse'></div>",
                                iconSize: [14, 14]
                            });
                            if (userMarker) userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                            else userMarker = L.marker([pos.coords.latitude, pos.coords.longitude], { icon: icon }).addTo(mapInstance);
                        }, err => {
                            console.warn(err);
                        }, { enableHighAccuracy: true });
                    }

                    const locs = currentDay.value.items.filter(i => i.location);
                    const bounds = L.latLngBounds();
                    for (const item of locs) {
                        try {
                            await new Promise(r => setTimeout(r, 400));
                            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`);
                            const d = await res.json();
                            if (d && d.length > 0) {
                                const lat = parseFloat(d[0].lat);
                                const lon = parseFloat(d[0].lon);
                                L.marker([lat, lon]).addTo(mapInstance).bindPopup(`<b>${item.activity || ''}</b><br>${item.location}`);
                                bounds.extend([lat, lon]);
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    }
                    isMapLoading.value = false; 
                    if(locs.length > 0) mapInstance.fitBounds(bounds, { padding: [50, 50] });
                };

                const centerOnUser = () => {
                    if(userLocation.value && mapInstance) {
                        mapInstance.flyTo([userLocation.value.lat, userLocation.value.lng], 15);
                    }
                };

                onMounted(() => {
                    loadTripList();
                    if (tripList.value.length > 0) {
                        switchTrip(tripList.value[0].id);
                    } else {
                        showSetupModal.value = true;
                    }
                    
                    watch([days, expenses, exchangeRate, participantsStr], () => {
                        if (!currentTripId.value) return;
                        localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(days.value));
                        localStorage.setItem(`${currentTripId.value}_exp`, JSON.stringify(expenses.value));
                        localStorage.setItem(`${currentTripId.value}_rate`, exchangeRate.value.toString());
                        localStorage.setItem(`${currentTripId.value}_users`, participantsStr.value);
                    }, { deep: true });
                });

                watch(viewMode, (v) => { if(v === 'map') initMap(); });
                watch(currentDayIdx, () => { if(viewMode.value === 'map') initMap(); });

                return {
                    viewMode, currentDayIdx, days, currentDay,
                    participants, participantsStr,
                    addParticipant, removeParticipant, renameParticipant,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    paidByPerson, settlementPlan, exchangeRate,
                    isOnline, getTimePeriod, weather,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    updateDate, showSetupModal, setup, initTrip, weatherDisplay, detectRate, isRateLoading,
                    currencyLabel, currencySymbol, toggleFlightCard, getDotColor,
                    showTripMenu, tripList, createNewTrip, switchTrip, deleteTrip, currentTripId,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    convertAmount, convertToTwd,
                    daysToTrip, tripDateRange,
                    checklistSections, checklistStats, sectionProgress,
                    addChecklistItem, removeChecklistItem, toggleChecklistItem,
                    estimateDuration
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
