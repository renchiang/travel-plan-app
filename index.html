<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘çš„æ—…éŠè¨ˆç•« | Travel Plan</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <!-- Leaflet for map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Google Font -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
  />

  <style>
    body {
      font-family: 'Noto Sans TC', system-ui, -apple-system, BlinkMacSystemFont,
        'Segoe UI', sans-serif;
    }
    .hide-scroll::-webkit-scrollbar {
      display: none;
    }
    .hide-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.2s ease;
    }
    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }

    /* ä½¿ç”¨è€… GPS å°åœ“é»å‹•ç•«ï¼ˆLeaflet divIcon ç”¨ï¼‰ */
    .custom-div-icon .gps-pulse {
      width: 14px;
      height: 14px;
      border-radius: 9999px;
      background: #38bdf8;
      box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.4);
      animation: gps-pulse 1.5s infinite;
    }

    @keyframes gps-pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.8);
        opacity: 0;
      }
    }

    /* åœ°åœ–ä¸€å®šè¦æœ‰é«˜åº¦ï¼Œä¸ç„¶çœ‹èµ·ä¾†æœƒæ˜¯ç©ºç™½ */
    #map {
      width: 100%;
      height: calc(100vh - 110px); /* æ‰£æ‰ header + bottom nav */
      min-height: 420px;
    }

    /* é˜²æ­¢ iPhone è¼¸å…¥æ™‚ç•«é¢è‡ªå‹•æ”¾å¤§ï¼šå°è¢å¹•æ™‚ï¼Œè¡¨å–®å­—é«”ä¸€å¾‹ >= 16px */
    @media (max-width: 640px) {
        input,
        textarea,
        select {
            font-size: 16px !important;
        }

        /* === å…¨ç«™å­—é«”åœ¨æ‰‹æ©Ÿä¸Šæ•´é«”æ”¾å¤§ä¸€ç´š === */

        /* åŸºæœ¬å­—é«”ç¨å¾®æ”¾å¤§ä¸€é»ï¼Œæ•´é«”æ¯”è¼ƒå¥½è®€ */
        body {
            font-size: 15px;
        }

        /* Tailwind çš„å­—ç´šå¾€ä¸Šä¸€éšèª¿æ•´ */
        .text-xs   { font-size: 1rem;  }  /* ç´„ 14.4px */
        .text-sm   { font-size: 1.05rem;    }  /* ç´„ 16px   */
        .text-base { font-size: 1.1rem; }  /* ç´„ 16.8px */

        .text-\[10px\] { font-size: 0.85rem; }  /* ç´„ 13.6px */
        .text-\[11px\] { font-size: 0.9rem;  }  /* ç´„ 14.4px */
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-50">
  <div id="app" class="min-h-screen flex flex-col max-w-md mx-auto bg-slate-950 text-slate-50">
    <!-- Header -->
    <header class="px-4 pt-4 pb-2 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-900 border-b border-slate-800 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-teal-500/10 border border-teal-400/40">
            <i class="ph-bold ph-suitcase-rolling text-teal-300 text-xl"></i>
          </span>
          <div>
            <h1 class="text-base font-bold tracking-tight flex items-center gap-1.5">
              æˆ‘çš„æ—…éŠè¨ˆç•«
              <span
                v-if="tripDateRange"
                class="text-[11px] font-medium text-teal-300 bg-teal-500/10 px-1.5 py-0.5 rounded-full border border-teal-500/30"
              >
                {{ tripDateRange }}
              </span>
            </h1>
          </div>
        </div>
        <div class="flex flex-col items-end gap-1">
          <button
            @click="showTripMenu = !showTripMenu"
            class="flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/80 hover:bg-slate-800 border border-slate-700 text-[11px]"
          >
            <i class="ph-bold ph-map-trifold text-xs text-emerald-300"></i>
            <span v-if="tripList.length" class="truncate max-w-[90px]">
                {{ tripList[0]?.name || 'æ—…ç¨‹åˆ—è¡¨' }}
            </span>
            <span v-else>å»ºç«‹æ—…ç¨‹</span>
            <i class="ph-bold ph-caret-down text-[10px] text-slate-400"></i>
          </button>
        
          <span
            class="inline-flex items-center gap-1 text-[10px]"
            :class="isOnline ? 'text-emerald-300' : 'text-amber-300'"
          >
            <span
              class="w-1.5 h-1.5 rounded-full"
              :class="isOnline ? 'bg-emerald-400' : 'bg-amber-400'"
            ></span>
            {{ isOnline ? 'å·²é€£ç·š' : 'é›¢ç·šæ¨¡å¼' }}
          </span>
        
          <!-- æ–°å¢ï¼šåˆ†äº«è¡Œç¨‹æŒ‰éˆ• -->
          <button
            @click="openShareModal"
            class="flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 hover:bg-emerald-500/20 border border-emerald-400/60 text-[11px] text-emerald-200 mt-1"
          >
            <i class="ph-bold ph-share-network text-xs"></i>
            åˆ†äº«è¡Œç¨‹
          </button>
        </div>        
      </div>

      <!-- Share Modal -->
      <transition name="fade">
        <div
          v-if="showShareModal"
          class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 px-4"
        >
          <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-2xl p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-emerald-500/10 border border-emerald-400/40">
                  <i class="ph-bold ph-share-network text-emerald-300 text-lg"></i>
                </span>
                <div>
                  <h2 class="text-sm font-bold text-slate-50">åˆ†äº«è¡Œç¨‹çµ¦å¥½å‹</h2>
                  <p class="text-[10px] text-slate-400">
                    å¯ä»¥ç›´æ¥ç”¨ç³»çµ±åˆ†äº«ï¼Œæˆ–è¤‡è£½ä¸‹æ–¹æ–‡å­—è²¼åˆ° Line / Messengerã€‚
                  </p>
                </div>
              </div>
              <button
                @click="closeShareModal"
                class="text-slate-500 hover:text-slate-100"
              >
                <i class="ph-bold ph-x text-base"></i>
              </button>
            </div>

            <!-- ç°¡çŸ­æ‘˜è¦æ–‡å­— -->
            <div class="mb-2 text-[11px] text-slate-200 whitespace-pre-line">
              {{ shareSummary }}
            </div>

            <!-- JSON åŒ¯å‡ºï¼ˆçµ¦å·¥ç¨‹æ›ï¼å‚™ä»½ç”¨ï¼‰ -->
            <div class="mb-2">
              <label class="block text-[10px] text-slate-400 mb-1">
                è¡Œç¨‹ JSONï¼ˆé€²éšå‚™ä»½æˆ–çµ¦å·¥ç¨‹æœ‹å‹åŒ¯å…¥ç”¨ï¼‰
              </label>
              <textarea
                :value="shareJson"
                readonly
                class="w-full h-40 text-[10px] rounded-xl bg-slate-950 border border-slate-700 px-2 py-2 text-slate-100 break-all"
              ></textarea>
            </div>

            <div class="flex justify-end gap-2 mt-2 text-[11px]">
              <button
                @click="systemShare"
                class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800 flex items-center gap-1"
              >
                <i class="ph-bold ph-share-fat text-xs"></i>
                ç³»çµ±åˆ†äº«
              </button>
              <button
                @click="copyShare"
                class="px-3 py-1.5 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 flex items-center gap-1"
              >
                <i class="ph-bold ph-copy-simple text-xs"></i>
                è¤‡è£½æ–‡å­—
              </button>
            </div>
          </div>
        </div>
      </transition>

      <!-- Trip dropdown -->
      <transition name="fade">
        <div
          v-if="showTripMenu"
          class="mt-2 bg-slate-900/95 border border-slate-700 rounded-2xl shadow-lg p-2 max-h-60 overflow-y-auto hide-scroll"
        >
          <div class="flex items-center justify-between mb-1 px-1">
            <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
              <i class="ph-bold ph-map-pin-line text-teal-300"></i>
              æˆ‘çš„æ—…ç¨‹
            </p>
            <div class="flex items-center gap-2">
              <!-- æ–°å¢ï¼šåŒ¯å…¥æŒ‰éˆ• -->
              <button
                @click="openImportModal"
                class="flex items-center gap-1 text-[11px] text-slate-300 hover:text-emerald-200"
              >
                <i class="ph-bold ph-upload-simple text-xs"></i> åŒ¯å…¥
              </button>
              <button
                @click="createNewTrip"
                class="flex items-center gap-1 text-[11px] text-teal-300 hover:text-teal-100"
              >
                <i class="ph-bold ph-plus-circle text-xs"></i> æ–°å¢
              </button>
            </div>
          </div>        
          <div v-if="!tripList.length" class="text-[11px] text-slate-400 px-1 py-2">
            é‚„æ²’æœ‰æ—…ç¨‹ï¼Œé»å³ä¸Šè§’ã€Œæ–°å¢ã€é–‹å§‹å§ï¼
          </div>
          <div
            v-for="trip in tripList"
            :key="trip.id"
            class="flex items-center justify-between px-2 py-1.5 rounded-xl hover:bg-slate-800 cursor-pointer group"
          >
            <div
              class="flex-1 min-w-0"
              @click="switchTrip(trip.id)"
            >
              <p class="text-xs font-medium truncate">
                {{ trip.name || 'æœªå‘½åæ—…ç¨‹' }}
              </p>
              <p class="text-[10px] text-slate-400">
                <span v-if="trip.startDate && trip.endDate">
                  {{ trip.startDate }} ~ {{ trip.endDate }}
                </span>
                <span v-else class="italic">æœªè¨­å®šæ—¥æœŸ</span>
              </p>
            </div>
            <button
              @click.stop="deleteTrip(trip.id)"
              class="ml-2 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-rose-400"
            >
              <i class="ph-bold ph-trash text-xs"></i>
            </button>
          </div>
        </div>
      </transition>

      <!-- Day tabs -->
      <div class="mt-3 flex items-center gap-1 overflow-x-auto hide-scroll pb-1">
        <button
          v-for="(d, idx) in days"
          :key="idx"
          @click="currentDayIdx = idx"
          class="px-2 py-1 rounded-xl border text-[11px] flex flex-col items-start min-w-[64px]"
          :class="currentDayIdx === idx
            ? 'border-teal-400/70 bg-teal-500/10 text-teal-200'
            : 'border-slate-700 bg-slate-900/60 text-slate-300 hover:bg-slate-800/80'"
        >
          <span class="font-bold text-xs tracking-tight">
            D{{ idx + 1 }}
          </span>
          <span class="text-[10px]">
            {{ d.shortDate || d.date || `ç¬¬ ${idx+1} å¤©` }}
          </span>
        </button>
        <button
          @click="addDay"
          class="ml-1 px-2 py-1 rounded-xl border border-dashed border-slate-600 text-[11px] flex items-center gap-1 text-slate-300 hover:border-teal-400 hover:text-teal-200"
        >
          <i class="ph-bold ph-plus text-xs"></i>
          æ–°å¢
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 relative hide-scroll pb-24">
      <!-- è¡Œç¨‹è¡¨ (Plan View) -->
      <transition name="fade" mode="out-in">
        <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 space-y-6">
          <!-- ä»Šæ—¥æ‘˜è¦ + å¤©æ°£ -->
          <div class="bg-slate-800/90 p-4 rounded-2xl shadow-sm border border-slate-700 flex justify-between items-start">
            <div class="flex-1 relative pt-0.5">
              <!-- éš±å½¢æ—¥æœŸé¸æ“‡å™¨ -->
              <input type="date" :value="currentDay.date?.length === 10 ? currentDay.date : ''" @change="updateDate"
                class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
              <!-- æ—¥æœŸé¡¯ç¤º -->
              <input
                v-model="currentDay.date"
                class="text-lg font-bold text-slate-50 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none"
                placeholder="Day 1 (é»æ“Šè¨­å®š)">
              <input
                v-model="currentDay.title"
                class="text-sm text-slate-200 bg-transparent border-b border-dotted border-slate-500 focus:border-teal-400 focus:outline-none w-full mt-1"
                placeholder="å¹«é€™ä¸€å¤©å–å€‹æ¨™é¡Œå§ï¼Œä¾‹å¦‚ï¼šä¸Šé‡ & é˜¿ç¾æ©«ç”º">
            </div>
            <div class="flex flex-col items-end gap-1">
              <div class="flex items-center gap-2 text-xs text-slate-200">
                <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-900 text-lg">
                  {{ weather.icon }}
                </span>
                <div class="flex flex-col items-end">
                  <span class="font-bold text-sm" v-if="weather.temp !== null">
                    {{ weather.temp }}Â°C
                  </span>
                  <span class="text-[10px] text-slate-400">
                    {{ weather.location || 'å°šæœªè¨­å®šåŸå¸‚' }}
                  </span>
                </div>
              </div>
              <button
                @click="handleWeatherUpdate"
                class="mt-1 px-2 py-1 text-[10px] rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200 flex items-center gap-1"
              >
                <i class="ph-bold ph-cloud-sun text-xs"></i>
                æ›´æ–°å¤©æ°£
              </button>
            </div>
          </div>

          <!-- å¤©æ°£é å ± -->
          <div v-if="weatherDisplay" class="bg-slate-800/80 rounded-2xl p-3 border border-slate-700">
            <div class="flex items-center justify-between mb-2">
              <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                <i class="ph-bold ph-calendar-blank text-teal-300 text-sm"></i>
                5 æ—¥å¤©æ°£é å ±
              </p>
              <span class="text-[10px] text-slate-400">
                è³‡æ–™ä¾†æºï¼šOpen-Meteo
              </span>
            </div>
            <div class="flex gap-2 justify-between">
              <div
                v-for="(d, idx) in weatherDisplay"
                :key="idx"
                class="flex-1 flex flex-col items-center gap-1 rounded-xl bg-slate-900/60 border border-slate-700 px-1.5 py-1.5"
              >
                <span class="text-[10px] text-slate-400">
                  {{ new Date(d.date).toLocaleDateString('zh-TW', { weekday: 'short' }) }}
                </span>
                <span class="text-lg">
                  {{ getWeatherIcon(d.code) }}
                </span>
                <span class="text-[10px] text-slate-200">
                  {{ Math.round(d.tmin) }}Â° - {{ Math.round(d.tmax) }}Â°
                </span>
              </div>
            </div>
          </div>

          <!-- èˆªç­å¡ç‰‡ (ç™»æ©Ÿè­‰æ¨£å¼) -->
          <div class="mb-6">
            <div
              v-if="currentDay.flight"
              class="relative bg-gradient-to-r from-blue-600 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden"
            >
              <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
              <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-50 rounded-full z-10"></div>
              <div class="p-4 relative z-0">
                <!-- é€™é¡† X = åˆªæ‰ç•¶æ—¥èˆªç­ -->
                <button
                  @click="toggleFlightCard"
                  class="absolute top-2 right-2 text-white/50 hover:text-white hover:bg-white/20 rounded-full p-1 transition"
                >
                  <i class="ph-bold ph-x"></i>
                </button>

                <div class="flex justify-between items-center mb-1 pt-2">
                  <!-- å‡ºç™¼ -->
                  <div class="flex flex-col items-center w-1/3">
                    <input
                      v-model="currentDay.flight.startTime"
                      type="time"
                      class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0"
                    >
                    <div class="text-[9px] opacity-60 mt-1">èµ·é£› (ç•¶åœ°æ™‚é–“)</div>
                    <input
                      v-model="currentDay.flight.startAirport"
                      class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0"
                      placeholder="TPE"
                    >
                  </div>

                  <!-- ä¸­é–“è³‡è¨Š -->
                  <div class="flex flex-col items-center justify-center w-1/3 px-2">
                    <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                    <input
                      v-model="currentDay.flight.number"
                      class="text-[10px] font-mono tracking-widest opacity-80 bg-transparent border-none text-center w-full text-white placeholder-white/50 focus:ring-0 uppercase p-0"
                      placeholder="BR198"
                    >
                    <div class="w-full h-0.5 bg-white/30 rounded-full mt-1"></div>
                  </div>

                  <!-- æŠµé” -->
                  <div class="flex flex-col items-center w-1/3">
                    <input
                      v-model="currentDay.flight.endTime"
                      type="time"
                      class="text-2xl font-black bg-transparent border-b border-white/30 w-full text-center text-white placeholder-white/50 focus:outline-none focus:border-white font-mono p-0"
                    >
                    <div class="relative w-full mt-0.5">
                      <select
                        v-model="currentDay.flight.arrivalOffset"
                        class="appearance-none bg-black/20 text-white text-[9px] rounded border-none w-full py-0.5 px-1 text-center focus:ring-0 cursor-pointer hover:bg-black/30"
                      >
                        <option value="0" class="text-slate-800">åŒæ—¥æŠµé”</option>
                        <option value="1" class="text-slate-800">+1å¤© (éš”æ—¥)</option>
                        <option value="-1" class="text-slate-800">-1å¤© (å‰æ—¥)</option>
                      </select>
                      <div
                        v-if="currentDay.flight.arrivalOffset != 0"
                        class="absolute -top-8 right-0 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow font-bold animate-pulse"
                      >
                        {{ currentDay.flight.arrivalOffset > 0 ? '+1' : '-1' }}
                      </div>
                    </div>
                    <input
                      v-model="currentDay.flight.endAirport"
                      class="text-sm font-bold opacity-90 bg-transparent border-none text-center w-full text-teal-100 placeholder-white/50 focus:ring-0 uppercase p-0"
                      placeholder="NRT"
                    >
                  </div>
                </div>
              </div>
            </div>

            <!-- æ²’æœ‰ flight æ™‚é¡¯ç¤ºã€Œæ–°å¢ã€ -->
            <button
              v-else
              @click="toggleFlightCard"
              class="w-full py-3 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 hover:border-teal-400 hover:text-teal-500 hover:bg-teal-50/50 transition flex items-center justify-center gap-2 group"
            >
              <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i>
              <span class="text-sm font-bold">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</span>
            </button>
          </div>


          <!-- è¡Œç¨‹ Timelineï¼ˆæ‹–æ›³æ’åº + Modal ç·¨è¼¯ï¼‰ -->
          <div class="space-y-4 mt-4">
            <!-- ä¸Šæ–¹ï¼šæ“ä½œåˆ— -->
            <div class="flex items-center justify-between gap-2 mb-1">
              <!-- <div class="text-xs text-slate-400">
                æ‹–æ›³å¡ç‰‡å¯èª¿æ•´é †åºï¼Œé»ä¸€ä¸‹å¯ç·¨è¼¯è©³ç´°å…§å®¹
              </div> -->
              <div class="flex items-center gap-2">
                <button
                  @click="addItem"
                  class="flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-teal-700/30 text-teal-200 border border-teal-500/60 hover:bg-teal-600/40"
                >
                  <i class="ph-bold ph-plus"></i>
                  æ–°å¢è¡Œç¨‹
                </button>
                <button
                  @click="removeCurrentDay"
                  class="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-slate-800 text-slate-300 border border-slate-600 hover:border-red-400 hover:text-red-300"
                >
                  <i class="ph-bold ph-trash"></i>
                  åˆªé™¤é€™ä¸€å¤©
                </button>
              </div>
            </div>

            <!-- Timeline ä¸»é«” -->
            <div class="relative pl-4 border-l border-slate-700 space-y-3">
              <div
                v-for="(item, idx) in currentDay.items"
                :key="idx"
                class="relative group"
                draggable="true"
                @dragstart="onDragStart(idx)"
                @dragover.prevent
                @drop="onDrop(idx)"
              >
                <!-- ç¯€é» -->
                <div
                  class="absolute -left-[21px] top-1/2 -translate-y-1/2 w-3 h-3 rounded-full border-2 border-slate-900 shadow-sm"
                  :class="getDotColor(item.type)"
                ></div>

                <!-- è¡Œç¨‹å¡ç‰‡ -->
                <div
                  class="bg-slate-800/90 hover:bg-slate-800 rounded-2xl border border-slate-700/80 hover:border-teal-400/70 shadow-sm hover:shadow-lg transition flex items-center gap-3 px-3 py-2 cursor-pointer"
                  @click="openEditModal(idx)"
                >
                  <!-- å·¦ï¼šæ™‚é–“ -->
                  <div class="flex flex-col items-center justify-center w-[3.5rem]">
                    <div class="text-[10px] text-slate-400 mb-0.5">
                      {{ getTimePeriod(item.time) }}
                    </div>
                    <div class="text-lg font-mono font-semibold text-slate-50">
                      {{ item.time || '--:--' }}
                    </div>
                  </div>

                  <!-- ä¸­ï¼šæ¨™é¡Œ + åœ°é» -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <p class="text-base font-semibold text-slate-50 truncate">
                        {{ item.activity || 'è¡Œç¨‹å…§å®¹' }}
                      </p>
                      <span
                        v-if="item.transport"
                        class="inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded-full bg-slate-900/70 text-slate-300 border border-slate-600"
                      >
                        <i class="ph-bold ph-route text-[11px]"></i>
                        {{ item.transport }}
                      </span>
                    </div>
                    <p
                      v-if="item.location"
                      class="text-[11px] text-slate-300 mt-0.5 truncate"
                    >
                      {{ item.location }}
                    </p>
                    <p
                      v-if="item.note"
                      class="text-[11px] text-slate-400 mt-0.5 overflow-hidden text-ellipsis whitespace-nowrap"
                    >
                      {{ item.note }}
                    </p>
                  </div>

                  <!-- å³ï¼šæ“ä½œ -->
                  <div class="flex flex-col items-end gap-1">
                    <button
                      class="p-1 rounded-full hover:bg-slate-700"
                      @click.stop="openEditModal(idx)"
                      title="ç·¨è¼¯"
                    >
                      <i class="ph-bold ph-note-pencil text-xs"></i>
                    </button>
                    <button
                      class="p-1 rounded-full hover:bg-slate-700"
                      @click.stop="removeItem(idx)"
                      title="åˆªé™¤"
                    >
                      <i class="ph-bold ph-trash text-xs text-rose-400"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- æ²’æœ‰è¡Œç¨‹ -->
              <div
                v-if="currentDay.items.length === 0"
                class="text-xs text-slate-400 text-center py-6"
              >
                é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸Šæ–¹ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹è¦åŠƒå§ï¼
              </div>
            </div>
          </div>
        </div>
      </transition>

      <!-- ç·¨è¼¯è¡Œç¨‹ Modal -->
      <transition name="fade">
        <div
          v-if="viewMode === 'plan' && editModalVisible"
          class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4"
        >
          <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-xl p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-slate-50 flex items-center gap-1">
                <i class="ph-bold ph-map-pin text-teal-400"></i>
                ç·¨è¼¯è¡Œç¨‹
              </h2>
              <button
                @click="closeEditModal"
                class="text-slate-400 hover:text-slate-100"
              >
                <i class="ph-bold ph-x text-lg"></i>
              </button>
            </div>

            <div class="space-y-3 text-sm">
              <div>
                <label class="block mb-1 text-slate-300 text-xs">æ™‚é–“</label>
                <input
                  v-model="editForm.time"
                  type="time"
                  class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                />
              </div>

              <div>
                <label class="block mb-1 text-slate-300 text-xs">è¡Œç¨‹æ¨™é¡Œ</label>
                <input
                  v-model="editForm.activity"
                  type="text"
                  placeholder="ä¾‹å¦‚ï¼šä¸Šé‡å…¬åœ’æ•£æ­¥"
                  class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                />
              </div>

              <div>
                <label class="block mb-1 text-slate-300 text-xs">åœ°é»åç¨± / åœ°å€</label>
                <input
                  v-model="editForm.location"
                  type="text"
                  placeholder="è¼¸å…¥åœ°é»ï¼Œæ–¹ä¾¿ä¹‹å¾Œé–‹åœ°åœ–æˆ–æŸ¥é¤å»³"
                  class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                />
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block mb-1 text-slate-300 text-xs">é¡å‹</label>
                  <select
                    v-model="editForm.type"
                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                  >
                    <option value="spot">ğŸ“ æ™¯é»</option>
                    <option value="food">ğŸ´ ç¾é£Ÿ</option>
                    <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-300 text-xs">äº¤é€šæ–¹å¼</label>
                  <input
                    v-model="editForm.transport"
                    type="text"
                    placeholder="æ­¥è¡Œ / åœ°éµ / å·´å£«..."
                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                  />
                </div>
              </div>

              <div>
                <label class="block mb-1 text-slate-300 text-xs">å‚™è¨»</label>
                <textarea
                  v-model="editForm.note"
                  rows="3"
                  placeholder="å¯ä»¥è£œå……é›†åˆåœ°é»ã€è¨‚ä½è³‡è¨Šã€ç¥¨åˆ¸ç·¨è™Ÿç­‰"
                  class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                ></textarea>
              </div>

              <div>
                <label class="block mb-1 text-slate-300 text-xs">åœç•™æ™‚é–“</label>
                <div class="flex items-center gap-2">
                  <select
                    v-model.number="editForm.stayHours"
                    class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                  >
                    <option :value="h" v-for="h in [0,1,2,3,4,5]" :key="'h'+h">
                      {{ h }} å°æ™‚
                    </option>
                  </select>
                  <select
                    v-model.number="editForm.stayMinutes"
                    class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                  >
                    <option :value="m" v-for="m in [0,15,30,45]" :key="'m'+m">
                      {{ m }} åˆ†é˜
                    </option>
                  </select>
                </div>
                <div class="border-t border-slate-700 pt-2 mt-2 text-[11px] flex items-center justify-between text-slate-300">
                  <span>é ä¼°é›¢é–‹æ™‚é–“</span>
                  <span class="font-mono text-teal-300">
                    {{ estimatedLeaveTime || '--:--' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="mt-4 flex justify-end gap-2 text-sm">
              <button
                @click="closeEditModal"
                class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800"
              >
                å–æ¶ˆ
              </button>
              <button
                @click="saveEdit"
                class="px-3 py-1.5 rounded-full bg-teal-500 text-slate-900 font-semibold hover:bg-teal-400"
              >
                å„²å­˜
              </button>
            </div>
          </div>
        </div>
      </transition>

      <!-- åœ°åœ–è¦–åœ– -->
      <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
        <div id="map" class="flex-1 w-full h-full bg-slate-800 z-0"></div>
        <div v-if="isMapLoading" class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-teal-200">
          <i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i>
          <span class="text-xs font-bold">è®€å–ä¸­...</span>
        </div>
        <div class="absolute bottom-24 left-4 right-4 bg-slate-900/95 rounded-2xl border border-slate-700 z-10 flex justify-between items-center">
          <div class="text-sm font-bold text-slate-100 px-3 py-2 flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-xl bg-teal-500/10 border border-teal-400/40">
              <i class="ph-bold ph-map-pin-line text-teal-300 text-sm"></i>
            </span>
            <span>ğŸ“ {{ currentDay.items.filter(i=>i.location).length }} å€‹åœ°é»</span>
          </div>
          <div class="flex gap-2">
            <button @click="initMap" class="p-2 bg-slate-900/80 text-teal-200 rounded-lg border border-slate-600 hover:bg-slate-700">
              <i class="ph-bold ph-arrows-clockwise"></i>
            </button>
            <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-400">
              <i class="ph-bold ph-crosshair"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- åˆ†å¸³è¦–åœ– -->
      <div v-if="viewMode === 'money'" class="p-4 space-y-4">
        <div class="bg-gradient-to-br from-teal-700 via-emerald-600 to-cyan-600 text-white rounded-2xl p-6 shadow-lg text-center relative">
          <div class="absolute top-4 right-4 flex flex-col items-end">
            <label class="text-[10px] text-teal-100 mb-1">åŒ¯ç‡ ({{ currencyLabel }})</label>
            <input v-model.number="exchangeRate" type="number" step="0.01"
              class="w-20 text-right text-xs text-teal-900 rounded px-1 py-0.5">
          </div>
          <p class="text-xs font-semibold text-teal-100 mb-1 flex items-center justify-center gap-1">
            <i class="ph-bold ph-currency-circle-dollar"></i>
            ç›®å‰æ¶ˆè²»ç¸½é¡
          </p>
          <p class="text-3xl font-extrabold tracking-tight mb-1">
            {{ totalExpense.toLocaleString() }} {{ currencySymbol }}
          </p>
          <p class="text-xs text-teal-100">
            ç´„ {{ convertToTwd.toLocaleString() }} æ–°å°å¹£ (ä¼°ç®—)
          </p>
        </div>

        <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3">
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
              <i class="ph-bold ph-users-three text-emerald-300"></i>
              åˆ†å¸³æˆå“¡èˆ‡æ”¯ä»˜æƒ…æ³
            </p>
            <button
              @click="addParticipant"
              class="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200"
            >
              <i class="ph-bold ph-user-plus text-xs"></i>
              æ–°å¢æˆå“¡
            </button>
          </div>
          <div class="bg-slate-900/70 rounded-xl border border-slate-700 p-2 space-y-1 max-h-40 overflow-y-auto hide-scroll">
            <div
              v-for="(p, idx) in participants"
              :key="idx"
              class="flex items-center justify-between gap-2 px-2 py-1 rounded-lg hover:bg-slate-800/80"
            >
              <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-emerald-500/10 border border-emerald-400/40 flex items-center justify-center text-[11px] text-emerald-200">
                    {{ p?.[0] || '?' }}
                </div>
                <div class="flex flex-col">
                  <input
                    :value="p"
                    @change="renameParticipant(idx, $event.target.value)"
                    class="bg-transparent border-none text-xs text-slate-100 focus:outline-none focus:ring-0"
                  />
                  <span class="text-[10px] text-slate-400">
                    å·²æ”¯ä»˜ï¼š{{ (paidByPerson[p] || 0).toLocaleString() }} {{ currencySymbol }}
                  </span>
                </div>
              </div>
              <button
                v-if="participants.length > 1"
                @click="removeParticipant(idx)"
                class="text-slate-500 hover:text-rose-400"
              >
                <i class="ph-bold ph-x text-xs"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3 space-y-3">
          <div class="flex items-center justify-between mb-1">
            <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
              <i class="ph-bold ph-shopping-cart-simple text-emerald-300"></i>
              è¨˜å¸³
            </p>
          </div>
        
          <!-- é€™é‚Šæ”¹ç‰ˆï¼šç”¨å‚ç›´æ’ç‰ˆï¼Œé¿å…åœ¨æ‰‹æ©Ÿæ“ çˆ† -->
          <div class="mb-2 space-y-2">
            <!-- æ¶ˆè²»é …ç›®ï¼šæ•´è¡Œ -->
            <input
              v-model="newExpense.item"
              class="w-full text-xs rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
              placeholder="æ¶ˆè²»é …ç›®ï¼Œä¾‹å¦‚ï¼šåˆé¤ã€è»Šç¥¨..."
            />
            <!-- é‡‘é¡ + ä»˜æ¬¾äººï¼šä¸¦æ’å…©æ¬„ -->
            <div class="flex gap-2">
              <input
                v-model.number="newExpense.amount"
                type="number"
                step="1"
                class="flex-1 text-xs rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 text-right focus:outline-none focus:ring-1 focus:ring-teal-400"
                placeholder="é‡‘é¡"
              />
              <select
                v-model="newExpense.payer"
                class="flex-1 text-[11px] rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
              >
                <option v-for="p in participants" :key="p" :value="p">
                  {{ p }}
                </option>
              </select>
            </div>
            <!-- æ–°å¢æŒ‰éˆ•ï¼šæ‰‹æ©Ÿç”¨æ»¿ç‰ˆï¼Œæ¡Œæ©Ÿå¯å†è‡ªè¡Œæ”¹ class -->
            <button
              @click="addExpense"
              class="w-full px-2 py-2 rounded-xl bg-teal-500 text-slate-950 text-xs font-semibold hover:bg-teal-400"
            >
              æ–°å¢
            </button>
          </div>
        
          <!-- ä¸‹é¢åŸæœ¬çš„æ”¯å‡ºåˆ—è¡¨ä¿æŒä¸è®Š -->
          <div class="space-y-1 max-h-44 overflow-y-auto hide-scroll">
            <div
              v-for="(e, idx) in expenses"
              :key="idx"
              class="flex items-center justify-between px-2 py-1 rounded-lg bg-slate-900/70 border border-slate-700/80 text-xs"
            >
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-slate-50 truncate">
                  {{ e.item }}
                </p>
                <p class="text-[10px] text-slate-400">
                  ç”± {{ e.payer }} æ”¯ä»˜
                </p>
              </div>
              <div class="flex items-center gap-2">
                <div class="text-right">
                  <p class="font-bold text-emerald-300">
                    {{ e.amount.toLocaleString() }} {{ currencySymbol }}
                  </p>
                  <p class="text-[10px] text-slate-400">
                    ç´„ {{ convertAmount(e.amount).toLocaleString() }} NTD
                  </p>
                </div>
                <button
                  @click="removeExpense(idx)"
                  class="text-slate-500 hover:text-rose-400"
                >
                  <i class="ph-bold ph-trash text-xs"></i>
                </button>
              </div>
            </div>
            <div v-if="!expenses.length" class="text-center text-[11px] text-slate-400 py-2">
              é‚„æ²’æœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„ï¼Œæ–°å¢ä¸€ç­†çœ‹çœ‹å§ï¼
            </div>
          </div>
        </div>        

        <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3">
          <div class="flex items-center justify-between mb-2">
            <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
              <i class="ph-bold ph-handshake text-emerald-300"></i>
              å»ºè­°èª°ä»˜èª°å¤šå°‘
            </p>
          </div>
          <div v-if="settlementPlan.length" class="space-y-1 max-h-32 overflow-y-auto hide-scroll">
            <div
              v-for="(item, idx) in settlementPlan"
              :key="idx"
              class="flex items-center justify-between px-2 py-1 rounded-lg bg-slate-900/70 border border-slate-700/80 text-xs"
            >
              <div class="flex items-center gap-1">
                <span class="font-semibold text-slate-50">{{ item.from }}</span>
                <span class="text-[10px] text-slate-400">â†’</span>
                <span class="font-semibold text-slate-50">{{ item.to }}</span>
              </div>
              <div class="text-right">
                <p class="font-bold text-emerald-300">
                  {{ item.amount.toLocaleString() }} {{ currencySymbol }}
                </p>
              </div>
            </div>
          </div>
          <div v-else class="text-center text-[11px] text-slate-400 py-2">
            ç›®å‰å°šæœªç”¢ç”Ÿåˆ†å¸³å»ºè­°ï¼Œè«‹å…ˆæ–°å¢æ”¯å‡ºèˆ‡æˆå“¡ã€‚
          </div>
        </div>
      </div>

      <!-- æ¸…å–®è¦–åœ– -->
      <div v-if="viewMode === 'checklist'" class="p-4 space-y-3">
        <!-- ä¸Šæ–¹æ¨™é¡Œï¼‹æ–°å¢æ¸…å–® -->
        <div class="flex items-center justify-between mb-1">
          <div class="text-xs font-semibold text-slate-200 flex items-center gap-1">
            <i class="ph-bold ph-clipboard-text text-emerald-300"></i>
            <span>è¡Œå‰æ¸…å–®</span>
          </div>
          <button
            @click="addChecklistSection"
            class="text-[11px] px-2 py-1 rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200 flex items-center gap-1"
          >
            <i class="ph-bold ph-folder-plus text-xs"></i>
            æ–°å¢æ¸…å–®
          </button>
        </div>

        <!-- å„å€‹æ¸…å–®å€å¡Š -->
        <div class="space-y-3">
          <div
            v-for="section in checklistSections"
            :key="section.id"
            class="bg-slate-800/90 rounded-2xl border border-slate-700 overflow-hidden"
          >
            <!-- æ¸…å–®æ¨™é¡Œåˆ— -->
            <div
              :class="[
                'px-3 py-2.5 flex items-center justify-between border-b border-slate-700/60 bg-gradient-to-r',
                section.color
              ]"
            >
              <div class="flex items-center gap-2">            
                <div>
                  <!-- æ¨™é¡Œå¯ç›´æ¥ç·¨è¼¯ -->
                  <input
                    v-model="section.title"
                    class="bg-transparent border-none text-xs font-semibold text-slate-950/90 focus:outline-none focus:ring-0"
                    placeholder="æœªå‘½åæ¸…å–®"
                  />
                  <p class="text-[10px] text-slate-900/80">
                    å·²å®Œæˆ {{ section.items.filter(i => i.done).length }} / {{ section.items.length }} é …
                  </p>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <div class="w-16 h-1 rounded-full bg-slate-900/40 overflow-hidden">
                  <div
                    class="h-full rounded-full bg-emerald-300/80"
                    :style="{ width: sectionProgress(section) + '%' }"
                  ></div>
                </div>
                <span class="text-[10px] font-semibold">
                  {{ sectionProgress(section) }}%
                </span>

                <!-- åˆªé™¤æ•´å€‹æ¸…å–® -->
                <button
                  @click.stop="removeChecklistSection(section.id)"
                  class="ml-1 text-slate-900/70 hover:text-rose-700 flex items-center gap-1 text-[10px]"
                >
                  <i class="ph-bold ph-trash text-xs"></i>
                  åˆªé™¤
                </button>
              </div>
            </div>

            <!-- æ¸…å–®é …ç›® -->
            <div class="p-2">
              <div class="space-y-1 max-h-40 overflow-y-auto hide-scroll">
                <label
                  v-for="item in section.items"
                  :key="item.id"
                  class="flex items-center justify-between gap-2 px-2 py-1 rounded-lg hover:bg-slate-800/80"
                >
                  <div class="flex items-center gap-2">
                    <input
                      type="checkbox"
                      v-model="item.done"
                      class="w-3.5 h-3.5 rounded border-slate-500 text-emerald-400 focus:ring-0"
                    />
                    <span
                      class="text-[11px]"
                      :class="item.done ? 'line-through text-slate-500' : 'text-slate-200'"
                    >
                      {{ item.text }}
                    </span>
                  </div>
                  <button
                    @click.stop="removeChecklistItem(section.id, item.id)"
                    class="text-slate-500 hover:text-rose-400"
                  >
                    <i class="ph-bold ph-x text-xs"></i>
                  </button>
                </label>
                <div
                  v-if="!section.items.length"
                  class="text-center text-[11px] text-slate-400 py-2"
                >
                  å°šæœªæ–°å¢é …ç›®
                </div>
              </div>
              <button
                @click="addChecklistItem(section.id)"
                class="mt-2 w-full text-[11px] flex items-center justify-center gap-1 px-2 py-1 rounded-xl border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200"
              >
                <i class="ph-bold ph-plus text-xs"></i>
                æ–°å¢ä¸€é …
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-slate-950/95 border-t border-slate-800 backdrop-blur-md">
      <div class="max-w-md mx-auto flex">
        <button
          @click="viewMode = 'plan'"
          class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
          :class="viewMode === 'plan' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
        >
          <i class="ph-bold ph-note-pencil mb-0.5 text-lg"></i>
          è¡Œç¨‹
        </button>
        <button
          @click="viewMode = 'map'"
          class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
          :class="viewMode === 'map' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
        >
          <i class="ph-bold ph-map-trifold mb-0.5 text-lg"></i>
          åœ°åœ–
        </button>
        <button
          @click="viewMode = 'money'"
          class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
          :class="viewMode === 'money' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
        >
          <i class="ph-bold ph-currency-circle-dollar mb-0.5 text-lg"></i>
          åˆ†å¸³
        </button>
        <button
          @click="viewMode = 'checklist'"
          class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
          :class="viewMode === 'checklist' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
        >
          <i class="ph-bold ph-clipboard-text mb-0.5 text-lg"></i>
          æ¸…å–®
        </button>
      </div>
    </nav>

    <!-- Import Modal -->
    <transition name="fade">
      <div
        v-if="showImportModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 px-4"
      >
        <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-sky-500/10 border border-sky-400/40">
                <i class="ph-bold ph-upload-simple text-sky-300 text-lg"></i>
              </span>
              <div>
                <h2 class="text-sm font-bold text-slate-50">åŒ¯å…¥è¡Œç¨‹ JSON</h2>
                <p class="text-[10px] text-slate-400">
                  è²¼ä¸Šæœ‹å‹åˆ†äº«çµ¦ä½ çš„ JSON å…§å®¹ï¼Œæˆ‘æœƒå¹«ä½ å»ºç«‹ä¸€å€‹æ–°çš„æ—…ç¨‹ã€‚
                </p>
              </div>
            </div>
            <button
              @click="closeImportModal"
              class="text-slate-500 hover:text-slate-100"
            >
              <i class="ph-bold ph-x text-base"></i>
            </button>
          </div>

          <textarea
            v-model="importText"
            class="w-full h-48 text-[10px] rounded-xl bg-slate-950 border border-slate-700 px-2 py-2 text-slate-100 break-all"
            placeholder="è²¼ä¸Šåƒæ˜¯ï¼š{ &quot;meta&quot;: {...}, &quot;trip&quot;: {...}, &quot;setup&quot;: {...}, &quot;days&quot;: [...] } é€™æ¨£çš„ JSON"
          ></textarea>

          <div class="mt-3 flex justify-end gap-2 text-[11px]">
            <button
              @click="closeImportModal"
              class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800"
            >
              å–æ¶ˆ
            </button>
            <button
              @click="doImportTrip"
              class="px-3 py-1.5 rounded-full bg-sky-500 text-slate-950 font-semibold hover:bg-sky-400 flex items-center gap-1"
            >
              <i class="ph-bold ph-check-circle text-xs"></i>
              åŒ¯å…¥è¡Œç¨‹
            </button>
          </div>
        </div>
      </div>
    </transition>

    <!-- Setup Modal -->
    <transition name="fade">
      <div
        v-if="showSetupModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 px-4"
      >
        <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-emerald-500/10 border border-emerald-400/40">
                <i class="ph-bold ph-map-pin-line text-emerald-300 text-lg"></i>
              </span>
              <div>
                <h2 class="text-sm font-bold text-slate-50">å»ºç«‹æ–°æ—…ç¨‹</h2>
                <p class="text-[10px] text-slate-400">
                  å…ˆè¨­å®šç›®çš„åœ°èˆ‡æ—¥æœŸï¼Œæˆ‘æœƒå¹«ä½ ç”¢ç”ŸåŸºæœ¬è¡Œç¨‹æ¶æ§‹
                </p>
              </div>
            </div>
            <button
              @click="showSetupModal = false"
              class="text-slate-500 hover:text-slate-100"
            >
              <i class="ph-bold ph-x text-base"></i>
            </button>
          </div>
          <div class="space-y-2 mt-2">
            <div>
              <label class="block text-[11px] text-slate-300 mb-0.5">
                ç›®çš„åœ° / åŸå¸‚
              </label>
              <input
                v-model="setup.destination"
                class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€å¤§é˜ªã€é¦–çˆ¾..."
              />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block text-[11px] text-slate-300 mb-0.5">
                  å‡ºç™¼æ—¥
                </label>
                <input
                  v-model="setup.startDate"
                  type="date"
                  class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                />
              </div>
              <div>
                <label class="block text-[11px] text-slate-300 mb-0.5">
                  å›ç¨‹æ—¥
                </label>
                <input
                  v-model="setup.endDate"
                  type="date"
                  class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                />
              </div>
            </div>
            <div class="mt-2">
              <label class="block text-[11px] text-slate-300 mb-0.5">
                è‡ªè¨‚åŒ¯ç‡ (1 å¤–å¹£æ› NTD)
              </label>
              <input
                v-model.number="setup.rate"
                type="number"
                step="0.01"
                class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
              />
              <button
                @click="detectRate"
                class="mt-1 w-full text-[10px] px-2 py-1 rounded-lg bg-slate-800 text-slate-200 border border-slate-600 hover:border-teal-400 flex items-center justify-center gap-1"
              >
                <i v-if="!isRateLoading" class="ph-bold ph-magic-wand text-xs"></i>
                <i v-else class="ph-bold ph-spinner text-xs animate-spin"></i>
                è‡ªå‹•åµæ¸¬åŒ¯ç‡
              </button>
            </div>            
          </div>
          <div class="mt-4 flex justify-end gap-2 text-[11px]">
            <button
              @click="showSetupModal = false"
              class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800"
            >
              å…ˆä¸ç”¨
            </button>
            <button
              @click="initTrip"
              class="px-3 py-1.5 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 flex items-center gap-1"
            >
              <i class="ph-bold ph-rocket-launch text-xs"></i>
              å»ºç«‹æ—…ç¨‹
            </button>
          </div>
        </div>
      </div>
    </transition>
  </div>

  <!-- Vue App -->
  <script type="module">
    import {
      createApp,
      ref,
      computed,
      watch,
      onMounted,
      nextTick,
    } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';

    /* ----------------- å°å·¥å…·ï¼šlocalStorage helpers ----------------- */
    const STORAGE_PREFIX = 'travel_app_';

    const saveJson = (key, value) =>
      localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));

    const loadJson = (key, defaultVal) => {
      const raw = localStorage.getItem(STORAGE_PREFIX + key);
      if (!raw) return defaultVal;
      try {
        return JSON.parse(raw);
      } catch {
        return defaultVal;
      }
    };

    /* ----------------- å°å·¥å…·ï¼šæ—¥æœŸ & æ—…ç¨‹å­—ä¸² ----------------- */
    const formatTripRange = (startDate, endDate) => {
      if (!startDate || !endDate) return '';
      const start = new Date(startDate);
      const end = new Date(endDate);
      const fmt = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
      return `${fmt(start)} - ${fmt(end)}`;
    };

    const calcTripDays = (startDate, endDate) => {
      if (!startDate || !endDate) return '';
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diff =
        Math.round((end.getTime() - start.getTime()) / 86400000) + 1;
      if (diff <= 0) return '';
      return `${diff} å¤© ${diff - 1} å¤œ`;
    };

    /* ----------------- å°å·¥å…·ï¼šå¤©æ°£ icon map ----------------- */
    const WEATHER_ICON_MAP = [
        { codes: [0], icon: 'â˜€ï¸' },
        { codes: [1, 2, 3], icon: 'â›…' },
        { codes: [45, 48], icon: 'ğŸŒ«ï¸' },
        { codes: [51, 53, 55, 56, 57], icon: 'ğŸŒ¦ï¸' },
        { codes: [61, 63, 65, 66, 67, 80, 81, 82], icon: 'ğŸŒ§ï¸' },
        { codes: [71, 73, 75, 77, 85, 86], icon: 'â„ï¸' },
        { codes: [95, 96, 99], icon: 'â›ˆï¸' },
    ];


    const getWeatherIconHelper = (code) => {
      const found = WEATHER_ICON_MAP.find((g) => g.codes.includes(code));
      return found?.icon ?? 'â˜ï¸';
    };

    /* ----------------- Leaflet è®Šæ•¸ & geocode cache ----------------- */
    let mapInstance = null;
    let userMarker = null;
    let geoWatchId = null;
    const geocodeCache = new Map(); // key: location string, value: { lat, lon }

    const geocodeLocation = async (location) => {
        if (!location) return null;
        if (geocodeCache.has(location)) {
            return geocodeCache.get(location);
        }

        const res = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`
        );
        const d = await res.json();
        if (!d?.length) return null;

        const { lat, lon } = d[0];
        const result = { lat: +lat, lon: +lon };
        geocodeCache.set(location, result);
        return result;
    };

    createApp({
      setup() {
        /* ========== åŸºæœ¬ç‹€æ…‹ ========== */
        const viewMode = ref('plan');
        const currentDayIdx = ref(0);
        const isOnline = ref(false);
        const showSetupModal = ref(false);

        /* ========== æ—…ç¨‹æ¸…å–® / ç•¶å‰æ—…ç¨‹ ========== */
        const showTripMenu = ref(false);
        const tripList = ref([]);
        const currentTripId = ref(null);

        const days = ref([]);
        const currentDay = computed(
          () =>
            days.value[currentDayIdx.value] || {
              items: [],
              flight: null,
              date: '',
              title: '',
            }
        );

        /* ========== åˆ†äº«è¡Œç¨‹ ========== */
        const showShareModal = ref(false);

        // çµ¦ç³»çµ±åˆ†äº«ç”¨çš„ç°¡çŸ­æ–‡å­—
        const shareSummary = computed(() => {
          const trip = tripList.value.find(t => t.id === currentTripId.value) || null;
          const title =
            (trip && trip.name) ||
            setup.value.destination ||
            'æˆ‘çš„æ—…éŠè¡Œç¨‹';
          const range = formatTripRange(
            setup.value.startDate,
            setup.value.endDate
          );
          const dayCount = days.value.length || 0;
          const expenseCount = expenses.value.length || 0;
          return `${title}${range ? 'ï½œ' + range : ''}\nå…± ${dayCount} å¤©è¡Œç¨‹ï¼Œå·²è¨˜éŒ„ ${expenseCount} ç­†æ”¯å‡ºã€‚`;
        });

        // å®Œæ•´ JSONï¼ˆå¯ä»¥è²¼çµ¦æœ‹å‹ï¼Œä¹Ÿå¯ä»¥ç•¶å‚™ä»½ï¼‰
        const shareJson = computed(() => {
          if (!currentTripId.value) return '';
          const trip = tripList.value.find(t => t.id === currentTripId.value) || null;
          const payload = {
            meta: {
              exportedAt: new Date().toISOString(),
              app: 'Travel Plan (no-backend)',
            },
            trip,
            setup: setup.value,
            days: days.value,
            expenses: expenses.value,
            participants: participants.value,
          };
          return JSON.stringify(payload, null, 2);
        });

        const openShareModal = () => {
          showShareModal.value = true;
        };

        const closeShareModal = () => {
          showShareModal.value = false;
        };

        const copyShare = async () => {
          try {
            await navigator.clipboard.writeText(shareJson.value);
            alert('å·²è¤‡è£½è¡Œç¨‹å…§å®¹ï¼Œå¯ä»¥è²¼åˆ°èŠå¤©è¦–çª—æˆ–ç•¶å‚™ä»½ã€‚');
          } catch (e) {
            console.error(e);
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚');
          }
        };

        const systemShare = async () => {
          // è‹¥ç€è¦½å™¨ä¸æ”¯æ´ Web Shareï¼Œå°±é€€å›åªè¤‡è£½æ–‡å­—
          if (!navigator.share) {
            await copyShare();
            return;
          }
          try {
            await navigator.share({
              title: 'æˆ‘çš„æ—…éŠè¡Œç¨‹',
              text: shareSummary.value,
              url: location.href, // åŒä¸€å€‹é é¢ç¶²å€
            });
          } catch (e) {
            console.error(e);
          }
        };

        /* ========== åˆ†å¸³ / æˆå“¡ / æ”¯å‡º ========== */
        const expenses = ref([]);
        const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
        const participants = ref(['æˆ‘']);
        const exchangeRate = ref(1);
        const isRateLoading = ref(false);

        const totalExpense = computed(() => {
          const sum = expenses.value.reduce(
            (acc, cur) => acc + (parseFloat(cur.amount) || 0),
            0
          );
          return Math.round(sum * 100) / 100;
        });

        const paidByPerson = computed(() => {
          const map = {};
          const people = participants.value.length
            ? participants.value
            : ['æˆ‘'];
          for (const p of people) map[p] = 0;
          for (const e of expenses.value) {
            const amt = parseFloat(e.amount) || 0;
            const payer = e.payer || 'æˆ‘';
            if (!map[payer]) map[payer] = 0;
            map[payer] += amt;
          }
          return map;
        });

        const settlementPlan = computed(() => {
          const people = Object.keys(paidByPerson.value);
          if (!people.length) return [];
          const total = Object.values(paidByPerson.value).reduce(
            (a, b) => a + b,
            0
          );
          const avg = total / people.length;
          const payers = [];
          const receivers = [];
          for (const p of people) {
            const diff =
              Math.round((paidByPerson.value[p] - avg) * 100) / 100;
            if (diff > 0) receivers.push({ name: p, amount: diff });
            else if (diff < 0) payers.push({ name: p, amount: -diff });
          }
          payers.sort((a, b) => a.amount - b.amount);
          receivers.sort((a, b) => b.amount - a.amount);
          const plan = [];
          let i = 0,
            j = 0;
          while (i < payers.length && j < receivers.length) {
            const pay = payers[i];
            const recv = receivers[j];
            const amt = Math.min(pay.amount, recv.amount);
            plan.push({
              from: pay.name,
              to: recv.name,
              amount: Math.round(amt * 100) / 100,
            });
            pay.amount -= amt;
            recv.amount -= amt;
            if (pay.amount <= 0.01) i++;
            if (recv.amount <= 0.01) j++;
          }
          return plan;
        });

        const convertAmount = (amount) => {
          const val = parseFloat(amount) || 0;
          const rate = exchangeRate.value || 1;
          return Math.round(val * rate * 100) / 100;
        };

        const convertToTwd = computed(() =>
          convertAmount(totalExpense.value)
        );

        const addExpense = () => {
          if (!newExpense.value.item || !newExpense.value.amount) return;
          expenses.value.unshift({ ...newExpense.value });
          newExpense.value.item = '';
          newExpense.value.amount = '';
        };

        const removeExpense = (idx) => expenses.value.splice(idx, 1);

        /* æˆå“¡æ“ä½œ */
        const addParticipant = () => {
          const baseName = 'æˆå“¡';
          let idx = participants.value.length + 1;
          let name = `${baseName}${idx}`;
          while (participants.value.includes(name)) {
            idx++;
            name = `${baseName}${idx}`;
          }
          participants.value.push(name);
          if (!newExpense.value.payer) {
            newExpense.value.payer = participants.value[0];
          }
        };

        const removeParticipant = (idx) => {
          if (participants.value.length <= 1) return;
          const name = participants.value[idx];
          if (
            !window.confirm(
              `è¦ç§»é™¤æˆå“¡ã€Œ${name}ã€ä»¥åŠä»–/å¥¹çš„æ‰€æœ‰æ”¯å‡ºå—ï¼Ÿ`
            )
          )
            return;
          participants.value.splice(idx, 1);
          expenses.value = expenses.value.filter((e) => e.payer !== name);
          if (!participants.value.includes(newExpense.value.payer)) {
            newExpense.value.payer = participants.value[0] || '';
          }
        };

        const renameParticipant = (idx, newName) => {
          const oldName = participants.value[idx];
          if (!oldName || !newName || oldName === newName) return;
          participants.value[idx] = newName;
          expenses.value.forEach((e) => {
            if (e.payer === oldName) e.payer = newName;
          });
        };

        /* ========== è¡Œå‰æ¸…å–® ========== */
        const checklistSections = ref([
          {
            id: 'pretrip',
            title: 'å‡ºç™¼å‰æº–å‚™',
            icon: 'ph-airplane-tilt',
            color:
              'from-sky-500/80 via-sky-400/80 to-emerald-400/80',
            items: [
              { id: 'passport', text: 'è­·ç…§ / èº«åˆ†è­‰', done: false },
              {
                id: 'tickets',
                text: 'æ©Ÿç¥¨ / è»Šç¥¨ / è¨‚æˆ¿ç¢ºèªä¿¡',
                done: false,
              },
              { id: 'cash', text: 'ç¾é‡‘ / ä¿¡ç”¨å¡ / ææ¬¾å¡', done: false },
              {
                id: 'sim',
                text: 'ç¶²è·¯ SIM / eSIM / Wi-Fi æ©Ÿ',
                done: false,
              },
            ],
          },
          {
            id: 'pack',
            title: 'è¡Œææ‰“åŒ…',
            icon: 'ph-suitcase-rolling',
            color:
              'from-amber-400/80 via-orange-400/80 to-rose-400/80',
            items: [
              {
                id: 'clothes',
                text: 'è¡£ç‰© / å¤–å¥— / ç¡è¡£',
                done: false,
              },
              {
                id: 'toiletries',
                text: 'ç›¥æ´—ç”¨å…· / åŒ–å¦å“ / ä¿é¤Šå“',
                done: false,
              },
              {
                id: 'meds',
                text: 'å¸¸å‚™è—¥å“ / æ„Ÿå†’è—¥ / è…¸èƒƒè—¥',
                done: false,
              },
              {
                id: 'chargers',
                text: 'å……é›»å™¨ / è½‰æ¥é ­ / è¡Œå‹•é›»æº',
                done: false,
              },
            ],
          },
          {
            id: 'others',
            title: 'å…¶ä»–äº‹é …',
            icon: 'ph-note-pencil',
            color:
              'from-emerald-400/80 via-teal-400/80 to-cyan-400/80',
            items: [
              {
                id: 'apps',
                text: 'å®‰è£ç•¶åœ°å¿…å‚™ Appï¼ˆåœ°åœ–ã€å«è»Šã€æ”¯ä»˜ï¼‰',
                done: false,
              },
              {
                id: 'backup',
                text: 'å‚™ä»½é‡è¦æ–‡ä»¶ï¼ˆè­·ç…§ã€è­‰ä»¶ã€ä¿éšªï¼‰',
                done: false,
              },
            ],
          },
        ]);

        const checklistStats = computed(() => {
          const allItems = checklistSections.value.flatMap(
            (s) => s.items
          );
          const total = allItems.length;
          const done = allItems.filter((i) => i.done).length;
          const percent = total
            ? Math.round((done / total) * 100)
            : 0;
          return { total, done, percent };
        });

        const sectionProgress = (section) => {
          const total = section.items.length;
          const done = section.items.filter((i) => i.done).length;
          return total
            ? Math.round((done / total) * 100)
            : 0;
        };

        const addChecklistItem = (sectionId) => {
          const sec = checklistSections.value.find(
            (s) => s.id === sectionId
          );
          if (!sec) return;
          const baseId = `${sectionId}-item`;
          let idx = sec.items.length + 1;
          let newId = `${baseId}-${idx}`;
          const existingIds = new Set(sec.items.map((i) => i.id));
          while (existingIds.has(newId)) {
            idx++;
            newId = `${baseId}-${idx}`;
          }
          sec.items.push({
            id: newId,
            text: 'æ–°çš„äº‹é …',
            done: false,
          });
        };

        const removeChecklistItem = (sectionId, itemId) => {
          const sec = checklistSections.value.find(
            (s) => s.id === sectionId
          );
          if (!sec) return;
          sec.items = sec.items.filter((i) => i.id !== itemId);
        };

        const addChecklistSection = () => {
          const idx = checklistSections.value.length + 1;
          const id = `section-${Date.now()}-${idx}`;
          checklistSections.value.push({
            id,
            title: `æ–°æ¸…å–® ${idx}`,
            icon: 'ph-note-pencil',
            color: 'from-emerald-400/80 via-teal-400/80 to-cyan-400/80',
            items: [],
          });
        };

        const removeChecklistSection = (sectionId) => {
          if (checklistSections.value.length <= 1) {
            alert('è‡³å°‘è¦ä¿ç•™ä¸€å€‹æ¸…å–®');
            return;
          }
          const sec = checklistSections.value.find(s => s.id === sectionId);
          if (!sec) return;
          if (!window.confirm(`è¦åˆªé™¤æ¸…å–®ã€Œ${sec.title || 'æœªå‘½åæ¸…å–®'}ã€å—ï¼Ÿ`)) return;
          checklistSections.value = checklistSections.value.filter(s => s.id !== sectionId);
        };

        /* ========== å¤©æ°£ / åŒ¯ç‡ / ç›®çš„åœ° ========== */
        const weather = ref({
          location: '',
          temp: null,
          icon: 'â˜ï¸',
          description: '',
          daily: null,
        });

        const setup = ref({
          destination: '',
          startDate: '',
          endDate: '',
          daysCount: 3,
          countryCode: 'tw',      // ISO 3166-1 alpha2ï¼Œä¾‹å¦‚ JP / KR / US
          currencyCode: 'TWD',    // è²¨å¹£ä»£ç¢¼ï¼Œä¾‹å¦‚ JPY / USD
          currencyName: 'æ–°å°å¹£', // è²¨å¹£ä¸­æ–‡åç¨±
          currencySymbol: 'NT$',  // è²¨å¹£ç¬¦è™Ÿï¼Œä¾‹å¦‚ Â¥ / $
          rate: 1,                // 1 å¤–å¹£ = N TWD
        });


        const currencyLabel = computed(() => {
          const code = setup.value.currencyCode;
          const name = setup.value.currencyName;
          if (!code && !name) return 'å¹£åˆ¥';
          if (name && code) return `${name} (${code})`;
          return code || name || 'å¹£åˆ¥';
        });

        const currencySymbol = computed(() => {
          return setup.value.currencySymbol || ''; // ç›´æ¥ç”¨ API å›ä¾†çš„ç¬¦è™Ÿ
        });

        const weatherDisplay = computed(() => {
          if (!weather.value.daily) return null;
          const arr = [];
          const daily = weather.value.daily;
          for (
            let i = 0;
            i < Math.min(5, daily.time.length);
            i++
          ) {
            arr.push({
              date: daily.time[i],
              tmax: daily.temperature_2m_max[i],
              tmin: daily.temperature_2m_min[i],
              code: daily.weathercode[i],
            });
          }
          return arr;
        });

        const getWeatherIcon = (code) =>
          getWeatherIconHelper(code);

          const fetchWeather = async (locName) => {
            try {
                if (!locName) return;
                weather.value.location = locName;

                const geoRes = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`
                );
                const geoData = await geoRes.json();
                if (!geoData?.length) return;

                const { lat, lon } = geoData[0];

                const wRes = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=16`
                );
                const wData = await wRes.json();

                weather.value.temp = Math.round(wData.current_weather.temperature);
                weather.value.icon = getWeatherIconHelper(wData.current_weather.weathercode);
                if (wData.daily) weather.value.daily = wData.daily;
            } catch (e) {
                console.error('weather error', e);
            }
        };


        const handleWeatherUpdate = async () => {
          let target =
            setup.value.destination || weather.value.location || '';
          if (!target) {
            const guess = currentDay.value?.title || '';
            const input = window.prompt(
              'è«‹è¼¸å…¥è¦æŸ¥è©¢å¤©æ°£çš„åŸå¸‚åç¨±',
              guess || 'æ±äº¬'
            );
            if (!input) return;
            target = input;
            if (!setup.value.destination) {
              setup.value.destination = input;
            }
          }
          await fetchWeather(target);
        };

        const detectRate = async () => {
          if (!setup.value.destination) return;
          isRateLoading.value = true;

          try {
            // 1. ç”¨ Nominatim æ‰¾å‡ºåŸå¸‚ â†’ å–å¾—åœ‹å®¶ä»£ç¢¼
            const geoRes = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                setup.value.destination
              )}&limit=1&addressdetails=1`
            );
            const geoData = await geoRes.json();
            if (!geoData?.length) return;

            const addr = geoData[0].address || {};
            const countryCode2 = (addr.country_code || 'tw').toUpperCase(); // ä¾‹å¦‚ JP / KR / US
            setup.value.countryCode = countryCode2.toLowerCase();

            // 2. ç”¨ country code å» restcountries æŸ¥è²¨å¹£è³‡è¨Š
            const rcRes = await fetch(
              `https://restcountries.com/v3.1/alpha/${countryCode2}`
            );
            const rcData = await rcRes.json();
            const countryInfo = Array.isArray(rcData) ? rcData[0] : rcData;

            let currencyCode = 'TWD';
            let currencyName = 'æ–°å°å¹£';
            let currencySymbol = 'NT$';

            if (countryInfo?.currencies) {
              const [code, cur] = Object.entries(countryInfo.currencies)[0]; // å–ç¬¬ä¸€å€‹è²¨å¹£
              currencyCode = code || currencyCode;
              currencyName = cur?.name || currencyName;
              currencySymbol = cur?.symbol || currencySymbol;
            }

            setup.value.currencyCode = currencyCode;
            setup.value.currencyName = currencyName;
            setup.value.currencySymbol = currencySymbol;

            // 3. ç”¨è²¨å¹£ä»£ç¢¼å» open.er-api æ‹‰åŒ¯ç‡ï¼ˆ1 å¤–å¹£ = å¹¾ TWDï¼‰
            const fxRes = await fetch(
              `https://open.er-api.com/v6/latest/${currencyCode}`
            );
            const fxData = await fxRes.json();

            if (fxData?.rates?.TWD) {
              const rate = fxData.rates.TWD;
              exchangeRate.value = rate;
              setup.value.rate = rate;
            }
          } catch (e) {
            console.error('rate error', e);
          } finally {
            isRateLoading.value = false;
          }
        };

        /* ========== èˆªç­å¡ç‰‡ / è¡Œç¨‹é …ç›® ========== */
        const toggleFlightCard = () => {
          const idx = currentDayIdx.value;
          const list = days.value;
          if (!list.length || idx < 0 || idx >= list.length) return;

          // æ‹¿å‡ºç›®å‰é€™ä¸€å¤©
          const day = { ...list[idx] };

          if (!day.flight) {
            // ç¬¬ä¸€æ¬¡æŒ‰ã€Œæ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Šã€â†’ å»ºç«‹ä¸€å€‹è·Ÿ v-model å°å¾—ä¸Šçš„ç‰©ä»¶
            day.flight = {
              startTime: '',
              endTime: '',
              startAirport: '',
              endAirport: '',
              number: '',
              arrivalOffset: 0, // 0: åŒæ—¥, 1: +1 å¤©, -1: å‰ä¸€å¤©
            };
          } else {
            // å·²æœ‰èˆªç­æ™‚æŒ‰ X â†’ åˆªé™¤ï¼ˆä½ å¦‚æœæƒ³åªæ˜¯ã€Œæ”¶åˆã€å¯ä»¥æ”¹æˆå…¶ä»– flagï¼‰
            if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ—¥çš„èˆªç­è³‡è¨Šå—ï¼Ÿ')) return;
            day.flight = null;
          }

          // ç”¨ splice æŠŠé€™ä¸€å¤©å¯«å›å»ï¼Œç¢ºä¿ Vue è§¸ç™¼æ›´æ–°
          list.splice(idx, 1, day);
        };

        const getDotColor = (type) => {
          if (type === 'food') return 'bg-amber-400';
          if (type === 'shop') return 'bg-emerald-400';
          return 'bg-teal-400';
        };

        const addItem = () =>
          currentDay.value.items.push({
            time: '',
            type: 'spot',
            activity: '',
            location: '',
            note: '',
            transport: '',
            duration: '',
            stayMinutes: 0,
          });

        const removeItem = (idx) =>
          currentDay.value.items.splice(idx, 1);

        const addDay = () => {
          const idx = days.value.length + 1;
          days.value.push({
            date: `Day ${idx}`,
            shortDate: `D${idx}`,
            title: '',
            items: [],
            flight: null,
          });
        };

        const removeCurrentDay = () => {
          if (
            days.value.length > 1 &&
            window.confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©å—ï¼Ÿ')
          ) {
            days.value.splice(currentDayIdx.value, 1);
            if (currentDayIdx.value >= days.value.length)
              currentDayIdx.value = days.value.length - 1;
          }
        };

        const getTimePeriod = (timeStr) => {
          if (!timeStr) return '';
          const [hRaw] = timeStr.split(':');
          const h = parseInt(hRaw, 10);
          if (isNaN(h)) return '';
          if (h < 5) return 'æ·±å¤œ';
          if (h < 11) return 'æ—©ä¸Š';
          if (h < 14) return 'ä¸­åˆ';
          if (h < 18) return 'ä¸‹åˆ';
          if (h < 22) return 'æ™šä¸Š';
          return 'æ·±å¤œ';
        };

        const updateDate = (event) => {
          const val = event.target.value;
          if (!val) return;
          const d = currentDay.value;
          d.date = val;
          const baseLabel = new Date(val).toLocaleDateString(
            'zh-TW',
            {
              month: 'numeric',
              day: 'numeric',
            }
          );
          d.shortDate = baseLabel;
          if (!d.title) {
            d.title = 'è¡Œç¨‹';
          }
        };

        /* ========== ç·¨è¼¯è¡Œç¨‹ Modal / æ‹–æ›³æ’åº ========== */
        const draggingIndex = ref(null);
        const editModalVisible = ref(false);
        const editIndex = ref(null);
        const editForm = ref({
          time: '',
          activity: '',
          location: '',
          note: '',
          transport: '',
          type: 'spot',
          stayHours: 0,
          stayMinutes: 0,
        });

        const estimatedLeaveTime = computed(() => {
          if (!editModalVisible.value || !editForm.value.time)
            return '';
          const [hStr, mStr] = editForm.value.time.split(':');
          const baseH = parseInt(hStr || '0', 10);
          const baseM = parseInt((mStr || '0').slice(0, 2), 10);
          if (isNaN(baseH) || isNaN(baseM)) return '';
          let total = baseH * 60 + baseM;
          total +=
            (editForm.value.stayHours || 0) * 60 +
            (editForm.value.stayMinutes || 0);
          total = ((total % (24 * 60)) + 24 * 60) % (24 * 60);
          const hh = String(Math.floor(total / 60)).padStart(2, '0');
          const mm = String(total % 60).padStart(2, '0');
          return `${hh}:${mm}`;
        });

        const openEditModal = (idx) => {
          const item = currentDay.value.items[idx];
          if (!item) return;
          editIndex.value = idx;
          editForm.value.time = item.time || '';
          editForm.value.activity = item.activity || '';
          editForm.value.location = item.location || '';
          editForm.value.note = item.note || '';
          editForm.value.transport = item.transport || '';
          editForm.value.type = item.type || 'spot';
          const minutes = item.stayMinutes || 0;
          editForm.value.stayHours = Math.floor(minutes / 60);
          editForm.value.stayMinutes = minutes % 60;
          editModalVisible.value = true;
        };

        const closeEditModal = () => {
          editModalVisible.value = false;
        };

        const saveEdit = () => {
          if (editIndex.value === null) return;
          const list = currentDay.value.items;
          const item = list[editIndex.value];
          if (!item) return;
          item.time = editForm.value.time;
          item.activity = editForm.value.activity;
          item.location = editForm.value.location;
          item.note = editForm.value.note;
          item.transport = editForm.value.transport;
          item.type = editForm.value.type;
          item.stayMinutes =
            (editForm.value.stayHours || 0) * 60 +
            (editForm.value.stayMinutes || 0);
          editModalVisible.value = false;
        };

        const onDragStart = (idx) => {
          draggingIndex.value = idx;
        };

        const onDrop = (idx) => {
            if (draggingIndex.value === null || draggingIndex.value === idx) return;
            const list = currentDay.value.items;
            const [moved] = list.splice(draggingIndex.value, 1);
            list.splice(idx, 0, moved);
            draggingIndex.value = null;
        };


        /* ========== Map / Geolocation ========== */
        const isMapLoading = ref(false);
        const userLocation = ref(null);

        const initMap = async () => {
          isMapLoading.value = true;
          await nextTick();

          const mapEl = document.getElementById('map');
          if (!mapEl) {
            isMapLoading.value = false;
            return;
          }

          if (mapInstance) {
            mapInstance.remove();
            mapInstance = null;
          }

          mapInstance = L.map('map').setView(
            [35.6895, 139.6917],
            13
          );
          L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            {
              maxZoom: 19,
              attribution: '&copy; OpenStreetMap contributors',
            }
          ).addTo(mapInstance);

          if ('geolocation' in navigator) {
            if (geoWatchId !== null) {
              navigator.geolocation.clearWatch(geoWatchId);
            }

            geoWatchId = navigator.geolocation.watchPosition(
              (pos) => {
                userLocation.value = {
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                };

                const icon = L.divIcon({
                  className: 'custom-div-icon',
                  html: "<div class='gps-pulse'></div>",
                  iconSize: [14, 14],
                });

                if (userMarker) {
                  userMarker.setLatLng([
                    pos.coords.latitude,
                    pos.coords.longitude,
                  ]);
                } else {
                  userMarker = L.marker(
                    [pos.coords.latitude, pos.coords.longitude],
                    { icon }
                  ).addTo(mapInstance);
                }
              },
              (err) => {
                console.warn('geo error', err);
              },
              { enableHighAccuracy: true }
            );
          }

          const locItems = (currentDay.value?.items || []).filter(
            (i) => i.location
          );
          const bounds = L.latLngBounds();

          const geocodePromises = locItems.map((i) =>
            geocodeLocation(i.location)
          );
          const results = await Promise.all(geocodePromises);

          results.forEach((coord, idx) => {
            if (!coord) return;
            const item = locItems[idx];
            L.marker([coord.lat, coord.lon])
              .addTo(mapInstance)
              .bindPopup(
                `<b>${item.activity || ''}</b><br>${
                  item.location || ''
                }`
              );
            bounds.extend([coord.lat, coord.lon]);
          });

          isMapLoading.value = false;

          if (locItems.length > 0) {
            mapInstance.fitBounds(bounds, { padding: [50, 50] });
          }
        };

        const centerOnUser = () => {
          if (userLocation.value && mapInstance) {
            mapInstance.flyTo(
              [userLocation.value.lat, userLocation.value.lng],
              15
            );
          } else {
            alert('å°šæœªå–å¾—å®šä½æˆ–åœ°åœ–å°šæœªè¼‰å…¥');
          }
        };

        /* ========== åŒ¯å…¥è¡Œç¨‹ ========== */
        const showImportModal = ref(false);
        const importText = ref('');

        const openImportModal = () => {
          importText.value = '';
          showImportModal.value = true;
        };

        const closeImportModal = () => {
          showImportModal.value = false;
        };

        const doImportTrip = () => {
          if (!importText.value.trim()) {
            alert('è«‹å…ˆè²¼ä¸Š JSON å…§å®¹');
            return;
          }

          let data;
          try {
            data = JSON.parse(importText.value);
          } catch (e) {
            console.error(e);
            alert('JSON æ ¼å¼è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªå…§å®¹æ˜¯å¦å®Œæ•´ã€‚');
            return;
          }

          // å»ºç«‹æ–°æ—…ç¨‹ IDï¼Œé¿å…å’Œç¾æœ‰ ID è¡çª
          const id = Date.now().toString();

          const importedSetup = data.setup || {};
          const importedDays = Array.isArray(data.days) ? data.days : [];
          const importedExpenses = Array.isArray(data.expenses) ? data.expenses : [];
          const importedParticipants =
            Array.isArray(data.participants) && data.participants.length
              ? data.participants
              : ['æˆ‘'];

          const tripMeta = data.trip || {
            id,
            name: importedSetup.destination || 'åŒ¯å…¥æ—…ç¨‹',
            startDate: importedSetup.startDate || '',
            endDate: importedSetup.endDate || '',
          };
          // å¼·åˆ¶ä½¿ç”¨æ–°çš„ id
          tripMeta.id = id;

          // å¯«å…¥ç‹€æ…‹
          currentTripId.value = id;
          setup.value = {
            ...setup.value,
            ...importedSetup,
          };
          days.value = importedDays;
          expenses.value = importedExpenses;
          participants.value = importedParticipants;

          if (typeof importedSetup.rate === 'number' && !isNaN(importedSetup.rate)) {
            exchangeRate.value = importedSetup.rate;
          }

          // åŠ åˆ°æ—…ç¨‹åˆ—è¡¨æœ€å‰é¢
          tripList.value.unshift(tripMeta);

          // å­˜åˆ° localStorage
          saveJson('index', tripList.value);
          saveJson(`${id}_config`, setup.value);
          saveJson(`${id}_days`, days.value);
          saveJson(`${id}_exp`, expenses.value);
          saveJson(`${id}_users`, participants.value);
          localStorage.setItem(
            STORAGE_PREFIX + `${id}_rate`,
            exchangeRate.value.toString()
          );

          // æ›´æ–°å¤©æ°£
          if (setup.value.destination) {
            fetchWeather(setup.value.destination);
          }

          showImportModal.value = false;
          showTripMenu.value = false;
          alert('å·²åŒ¯å…¥è¡Œç¨‹ä¸¦å»ºç«‹æ–°çš„æ—…ç¨‹ã€‚');
        };

        /* ========== æ—…ç¨‹åˆå§‹åŒ– / åˆ‡æ› / åˆªé™¤ ========== */
        const initTrip = () => {
          days.value = [];
          const total = setup.value.daysCount || 3;

          if (setup.value.startDate && setup.value.endDate) {
            const start = new Date(setup.value.startDate);
            const end = new Date(setup.value.endDate);
            const diff =
              Math.round(
                (end.getTime() - start.getTime()) / 86400000
              ) + 1;
            const count = diff > 0 ? diff : total;
            for (let i = 0; i < count; i++) {
              const d = new Date(start);
              d.setDate(d.getDate() + i);
              const dateLabel = d.toLocaleDateString('zh-TW', {
                month: 'numeric',
                day: 'numeric',
              });
              days.value.push({
                date: d.toISOString().slice(0, 10),
                shortDate: dateLabel,
                title: '',
                items: [],
                flight: null,
              });
            }
          } else {
            for (let i = 0; i < total; i++) {
              days.value.push({
                date: `Day ${i + 1}`,
                shortDate: `D${i + 1}`,
                title: '',
                items: [],
                flight: null,
              });
            }
          }

          currentDayIdx.value = 0;
          showSetupModal.value = false;

          // â˜… æ–°å¢ï¼šæŠŠ setup.rate å¥—ç”¨åˆ°è¨˜å¸³ç”¨çš„ exchangeRate
          if (!setup.value.rate || isNaN(setup.value.rate)) {
            setup.value.rate = 1;
          }
          exchangeRate.value = setup.value.rate;

          const id = Date.now().toString();
          currentTripId.value = id;
          tripList.value.unshift({
            id,
            name: setup.value.destination || 'æœªå‘½åæ—…ç¨‹',
            startDate: setup.value.startDate,
            endDate: setup.value.endDate,
          });

          saveJson('index', tripList.value);
          saveJson(`${id}_config`, setup.value);
          saveJson(`${id}_days`, days.value);
          saveJson(`${id}_exp`, expenses.value);
          saveJson(`${id}_users`, participants.value);
          localStorage.setItem(
            STORAGE_PREFIX + `${id}_rate`,
            exchangeRate.value.toString()
          );

          if (setup.value.destination) {
            fetchWeather(setup.value.destination);
            detectRate();
          }
        };

        const createNewTrip = () => {
          setup.value = {
            destination: '',
            startDate: '',
            endDate: '',
            daysCount: 3,
            countryCode: 'tw',
            rate: 1,
          };
          showSetupModal.value = true;
          expenses.value = [];
          participants.value = ['æˆ‘'];
          newExpense.value.payer = 'æˆ‘';
        };

        const switchTrip = (id) => {
          currentTripId.value = id;
          showTripMenu.value = false;

          const lDays = loadJson(`${id}_days`, null);
          const lExp = loadJson(`${id}_exp`, null);
          const lUsers = loadJson(`${id}_users`, null);
          const lConf = loadJson(`${id}_config`, null);
          const lRate = localStorage.getItem(
            STORAGE_PREFIX + `${id}_rate`
          );

          if (lDays) days.value = lDays;
          if (lExp) expenses.value = lExp;
          if (lUsers) participants.value = lUsers;
          if (lConf) {
            setup.value = lConf;
            exchangeRate.value =
              lConf.rate || exchangeRate.value;
            if (lConf.destination)
              fetchWeather(lConf.destination);
          }
          if (lRate) {
            const v = parseFloat(lRate);
            if (!isNaN(v)) exchangeRate.value = v;
          }

          if (!participants.value.length) {
            participants.value = ['æˆ‘'];
          }
          if (!participants.value.includes(newExpense.value.payer)) {
            newExpense.value.payer = participants.value[0] || 'æˆ‘';
          }
        };

        const deleteTrip = (id) => {
          if (
            !window.confirm(
              'ç¢ºå®šè¦åˆªé™¤é€™å€‹æ—…ç¨‹å—ï¼Ÿç›¸é—œè³‡æ–™æœƒä¸€ä½µåˆªé™¤ã€‚'
            )
          )
            return;
          tripList.value = tripList.value.filter((t) => t.id !== id);

          ['days', 'exp', 'rate', 'users', 'config'].forEach(
            (suffix) =>
              localStorage.removeItem(
                STORAGE_PREFIX + `${id}_${suffix}`
              )
          );
          saveJson('index', tripList.value);

          if (currentTripId.value === id) {
            if (tripList.value.length) {
                switchTrip(tripList.value[0].id);
            } else {
                days.value = [];
                currentTripId.value = null;
                showSetupModal.value = true;
            }
           }
        };

        /* ========== æ—…ç¨‹æ—¥æœŸé¡¯ç¤º ========== */
        const daysToTrip = computed(() =>
          calcTripDays(
            setup.value.startDate,
            setup.value.endDate
          )
        );

        const tripDateRange = computed(() =>
          formatTripRange(
            setup.value.startDate,
            setup.value.endDate
          )
        );

        /* ========== Watchers ========== */

        // å­˜æ¯å¤©è¡Œç¨‹ / æ”¯å‡º / åŒ¯ç‡ / æˆå“¡
        watch(
          [days, expenses, exchangeRate, participants],
          () => {
            if (!currentTripId.value) return;
            const id = currentTripId.value;
            saveJson(`${id}_days`, days.value);
            saveJson(`${id}_exp`, expenses.value);
            saveJson(`${id}_users`, participants.value);
            localStorage.setItem(
              STORAGE_PREFIX + `${id}_rate`,
              exchangeRate.value.toString()
            );
          },
          { deep: true }
        );

        // ç•¶ä½ åœ¨ã€Œå»ºç«‹æ—…ç¨‹ã€çš„åŒ¯ç‡æ¬„ä½ä¿®æ”¹ (setup.rate) æ™‚ï¼ŒåŒæ­¥åˆ°è¨˜å¸³åŒ¯ç‡
        watch(
          () => setup.value.rate,
          (val) => {
            const n = parseFloat(val);
            if (!isNaN(n)) {
              exchangeRate.value = n;
            }
          }
        );

        // ç•¶ä½ åœ¨ã€Œè¨˜å¸³ã€é‚£é‚Šç›´æ¥æ”¹åŒ¯ç‡ input (exchangeRate) æ™‚ï¼Œä¹Ÿå›å¯«åˆ° setup.rate
        watch(exchangeRate, (val) => {
          const n = parseFloat(val);
          if (!isNaN(n)) {
            setup.value.rate = n;
          }
        });

        // åˆ‡åˆ°åœ°åœ–æˆ–åˆ‡æ›æ—¥å­æ™‚ï¼Œé‡æ–° initMap
        watch(viewMode, (v) => {
          if (v === 'map') initMap();
        });

        watch(currentDayIdx, () => {
          if (viewMode.value === 'map') initMap();
        });

        /* ========== onMountedï¼šè¼‰å…¥è³‡æ–™ / è¨­å®šç·šä¸Šç‹€æ…‹ ========== */
        onMounted(() => {
          isOnline.value = navigator.onLine;
          window.addEventListener(
            'online',
            () => (isOnline.value = true)
          );
          window.addEventListener(
            'offline',
            () => (isOnline.value = false)
          );

          const storedTrips = loadJson('index', null);
          if (storedTrips) {
            tripList.value = storedTrips;
          }
          if (tripList.value.length) {
                switchTrip(tripList.value[0].id);
          } else {
                showSetupModal.value = true;
          }
        });

        /* ========== å›å‚³çµ¦æ¨¡æ¿ä½¿ç”¨çš„ç‹€æ…‹èˆ‡æ–¹æ³• ========== */
        return {
          // ä¸»ç‹€æ…‹
          viewMode,
          currentDayIdx,
          days,
          currentDay,
          isOnline,

          // æ—…ç¨‹ç®¡ç†
          showTripMenu,
          tripList,
          currentTripId,
          createNewTrip,
          switchTrip,
          deleteTrip,
          initTrip,
          tripDateRange,
          daysToTrip,

          // è¡Œç¨‹èˆ‡èˆªç­
          addDay,
          addItem,
          removeItem,
          removeCurrentDay,
          getDotColor,
          getTimePeriod,
          updateDate,
          toggleFlightCard,

          // ç·¨è¼¯ Modal / æ‹–æ›³
          draggingIndex,
          editModalVisible,
          editIndex,
          editForm,
          estimatedLeaveTime,
          openEditModal,
          closeEditModal,
          saveEdit,
          onDragStart,
          onDrop,

          // åˆ†å¸³
          expenses,
          newExpense,
          participants,
          exchangeRate,
          totalExpense,
          paidByPerson,
          settlementPlan,
          convertAmount,
          convertToTwd,
          addExpense,
          removeExpense,
          addParticipant,
          removeParticipant,
          renameParticipant,
          currencyLabel,
          currencySymbol,

          // æ¸…å–®
          checklistSections,
          checklistStats,
          sectionProgress,
          addChecklistItem,
          removeChecklistItem,
          addChecklistSection,
          removeChecklistSection,

          // å¤©æ°£ / åŒ¯ç‡
          weather,
          weatherDisplay,
          getWeatherIcon,
          handleWeatherUpdate,
          detectRate,
          isRateLoading,
          setup,
          showSetupModal,

          // åœ°åœ–
          isMapLoading,
          userLocation,
          initMap,
          centerOnUser,

          // åˆ†äº«
          showShareModal,
          shareSummary,
          shareJson,
          openShareModal,
          closeShareModal,
          copyShare,
          systemShare,

          // åŒ¯å…¥
          showImportModal,
          importText,
          openImportModal,
          closeImportModal,
          doImportTrip,

        };
      },
    }).mount('#app');
  </script>
</body>
</html>