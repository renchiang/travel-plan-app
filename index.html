<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>è¼•é‡æ—…éŠè¡Œç¨‹ & åˆ†å¸³å°å¹«æ‰‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <!-- Leaflet Mapï¼ˆç›®å‰æ²’é–‹åœ°åœ–ä¹Ÿæ²’é—œä¿‚ï¼Œç•™è‘—å‚™ç”¨ï¼‰ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            background: radial-gradient(circle at top, #0f172a, #020617);
            color: #e5e7eb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
        .glass {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(148, 163, 184, 0.6);
            border-radius: 999px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .timeline-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            border: 2px solid #38bdf8;
            background-color: #0f172a;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.4);
        }

        .btn-soft {
            @apply px-3 py-1 rounded-full text-xs font-medium;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: #e5e7eb;
        }
        .btn-soft:hover {
            background: rgba(30, 64, 175, 0.5);
            border-color: rgba(96, 165, 250, 0.7);
        }

        .bottom-nav {
            backdrop-filter: blur(14px);
            background: linear-gradient(to top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.8));
        }

        .floating-badge {
            background: radial-gradient(circle at top, #22c55e, #15803d);
            box-shadow:
                0 0 0 4px rgba(22, 163, 74, 0.5),
                0 10px 25px rgba(6, 95, 70, 0.8);
        }

        .active-tab {
            background: rgba(15, 118, 110, 0.3);
            border-color: rgba(45, 212, 191, 0.9);
            color: #f9fafb;
            box-shadow: 0 6px 16px rgba(45, 212, 191, 0.4);
        }

        .input-underline {
            border-bottom: 1px dashed rgba(148, 163, 184, 0.7);
        }

        .card-glass {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.85));
        }
    </style>
</head>
<body class="min-h-screen">
<div id="app" class="w-full max-w-5xl mx-auto px-2 sm:px-4 py-0 sm:py-4">
    <!-- App Containerï¼šæ‰‹æ©Ÿåƒæ»¿è¢å¹•é«˜åº¦ï¼Œæ¡Œæ©Ÿæ‰è®Šå¡ç‰‡ -->
    <div class="glass rounded-none sm:rounded-3xl shadow-2xl border border-slate-700/80 overflow-hidden flex flex-col h-screen sm:h-[720px]">
        <!-- Header -->
        <header class="bg-gradient-to-b from-slate-900/95 via-slate-950 to-slate-900/90 border-b border-slate-800/80">
            <!-- ä¸ŠåŠï¼šå·¦å´ Trip é¸å–® + ä¸­é–“ç›®çš„åœ°/æ—¥æœŸï¼ˆåªæœ‰è¡Œç¨‹é é¡¯ç¤ºæ—¥æœŸï¼‰ -->
            <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                <!-- å·¦å´ï¼šTrip åˆ‡æ› -->
                <button
                        @click="showTripList = true"
                        class="flex items-center gap-1 text-xs text-slate-300 hover:text-cyan-300">
                    <i class="ph-bold ph-list text-base"></i>
                    <span class="hidden sm:inline">æˆ‘çš„æ—…ç¨‹</span>
                </button>

                <!-- ä¸­å¤®ï¼šåœ°é» / æ—¥æœŸè³‡è¨Š -->
                <div class="flex-1 flex flex-col items-center text-center">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/80 border border-slate-700 shadow-sm max-w-full">
                        <i class="ph-bold ph-map-pin text-cyan-300 text-sm"></i>
                        <div class="flex flex-col items-center">
                            <span class="text-[13px] font-semibold tracking-wide text-slate-100 truncate max-w-[180px] sm:max-w-[260px]">
                                {{ setup.destination || 'æˆ‘çš„æ—…è¡Œè¨ˆç•«' }}
                            </span>
                            <p v-if="viewMode === 'plan'" class="text-xs text-slate-400 mt-1 truncate max-w-[220px] sm:max-w-[260px]">
                                {{ tripDateRange || 'è«‹åœ¨æ—…ç¨‹è¨­å®šä¸­é¸æ“‡æ—¥æœŸèˆ‡å¤©æ•¸' }}
                            </p>
                            <p v-if="viewMode === 'plan' && daysToTrip !== null" class="text-[11px] text-teal-200 mt-0.5">
                                è·é›¢å‡ºç™¼é‚„æœ‰ <span class="font-semibold">{{ daysToTrip }}</span> å¤©
                            </p>
                        </div>
                    </div>
                </div>

                <!-- å³å´ä¿ç•™ç©ºä½ï¼Œè®“ä¸­é–“å¯ä»¥çœŸæ­£ç½®ä¸­ -->
                <div class="w-8"></div>
            </div>

            <!-- æ—¥æœŸåˆ— -->
            <div class="border-t border-slate-800/80 bg-slate-900/90">
                <div class="px-3 py-2 flex items-center justify-between gap-2 text-[11px] text-slate-300">
                    <div class="flex items-center gap-1.5 min-w-0">
                        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full border border-teal-500 text-[11px] text-teal-300 font-bold flex-shrink-0">
                            D{{ currentDayIdx + 1 }}
                        </span>
                        <span class="font-medium truncate">{{ currentDay.shortDate || 'æœªè¨­å®šæ—¥æœŸ' }}</span>
                        <span class="text-slate-500 flex-shrink-0">Â·</span>
                        <span class="text-slate-300 truncate">{{ currentDay.title || 'æ—…ç¨‹ç¬¬ ' + (currentDayIdx + 1) + ' å¤©' }}</span>
                    </div>
                    <div class="flex items-center gap-1 overflow-x-auto scrollbar-thin">
                        <button
                                v-for="(d, idx) in days"
                                :key="idx"
                                @click="currentDayIdx = idx"
                                class="px-1.5 py-0.5 rounded-full border text-[10px] whitespace-nowrap transition-all"
                                :class="idx === currentDayIdx
                                    ? 'border-teal-400 bg-teal-500/20 text-teal-200'
                                    : 'border-slate-700 bg-slate-900 text-slate-400 hover:border-teal-500/80 hover:text-teal-200'">
                            D{{ idx + 1 }}
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <!-- æ³¨æ„ï¼šflex-1 + overflow-y-autoï¼Œæ­é… h-screenï¼Œæ‰‹æ©Ÿå°±åªæœƒé€™è£¡æ»¾å‹• -->
        <main class="flex-1 overflow-y-auto scrollbar-thin bg-gradient-to-b from-slate-950 via-slate-950 to-slate-900 pb-2">
            <!-- viewMode åˆ‡æ› -->
            <div class="px-4 pt-2 pb-1">
                <div class="inline-flex bg-slate-900/90 border border-slate-700 rounded-2xl p-0.5 text-xs shadow-lg w-full sm:w-auto">
                    <button
                            @click="viewMode = 'plan'"
                            class="flex items-center justify-center gap-1 px-2 py-1.5 rounded-2xl transition-all flex-1 sm:flex-none"
                            :class="viewMode === 'plan' ? 'active-tab' : 'text-slate-300 hover:bg-slate-800/80'">
                        <i class="ph-bold ph-calendar-check text-sm"></i>
                        è¡Œç¨‹
                    </button>
                    <button
                            @click="viewMode = 'money'"
                            class="flex items-center justify-center gap-1 px-2 py-1.5 rounded-2xl transition-all flex-1 sm:flex-none"
                            :class="viewMode === 'money' ? 'active-tab' : 'text-slate-300 hover:bg-slate-800/80'">
                        <i class="ph-bold ph-wallet text-sm"></i>
                        åˆ†å¸³
                    </button>
                    <button
                            @click="viewMode = 'checklist'"
                            class="flex items-center justify-center gap-1 px-2 py-1.5 rounded-2xl transition-all flex-1 sm:flex-none"
                            :class="viewMode === 'checklist' ? 'active-tab' : 'text-slate-300 hover:bg-slate-800/80'">
                        <i class="ph-bold ph-check-square-offset text-sm"></i>
                        æ¸…å–®
                    </button>
                    <button
                            @click="viewMode = 'translate'"
                            class="flex items-center justify-center gap-1 px-2 py-1.5 rounded-2xl transition-all flex-1 sm:flex-none"
                            :class="viewMode === 'translate' ? 'active-tab' : 'text-slate-300 hover:bg-slate-800/80'">
                        <i class="ph-bold ph-translate text-sm"></i>
                        ç¿»è­¯
                    </button>
                </div>
            </div>

            <!-- è¡Œç¨‹é  -->
            <section v-if="viewMode === 'plan'" class="px-4 pb-4 space-y-3">
                <!-- ä»Šæ—¥æ‘˜è¦ + å¤©æ°£ -->
                <div class="grid grid-cols-1 md:grid-cols-[2fr,1.4fr] gap-3">
                    <!-- æ‘˜è¦å¡ -->
                    <div class="card-glass rounded-2xl border border-sky-800/70 p-3 shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sky-400 to-cyan-500 flex items-center justify-center shadow-lg shadow-sky-500/40">
                                    <i class="ph-bold ph-sun-dim text-slate-950 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-sm font-semibold text-sky-100">ä»Šæ—¥é‡é»</h2>
                                    <p class="text-[11px] text-slate-400">
                                        å¹«ä½ æŠŠä»Šå¤©çš„è¡Œç¨‹ã€å¤©æ°£èˆ‡é ç®—æŠ“åœ¨ä¸€èµ·çœ‹
                                    </p>
                                </div>
                            </div>
                            <button
                                    @click="showSetup = true"
                                    class="flex items-center gap-1 text-[11px] text-slate-300 hover:text-sky-300">
                                <i class="ph-bold ph-gear text-xs"></i>
                                è¨­å®š
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mt-1 text-[11px] text-slate-200">
                            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2 border border-slate-700/90">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-slate-400 flex items-center gap-1">
                                        <i class="ph-bold ph-map-pin-line text-[13px] text-sky-300"></i>
                                        ç›®çš„åœ°
                                    </span>
                                </div>
                                <p class="text-xs font-semibold text-slate-100 truncate">
                                    {{ setup.destination || 'å°šæœªè¨­å®š' }}
                                </p>
                                <p class="text-[10px] text-slate-500 mt-0.5">
                                    {{ setup.countryNote || 'å¯åœ¨è¨­å®šä¸­å¡«å¯«å‚™è¨»' }}
                                </p>
                            </div>

                            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2 border border-slate-700/90">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-slate-400 flex items-center gap-1">
                                        <i class="ph-bold ph-cloud-sun text-[13px] text-amber-300"></i>
                                        å¤©æ°£
                                    </span>
                                    <button
                                            @click="fetchWeather"
                                            class="text-[10px] text-slate-400 hover:text-amber-300">
                                        åˆ·æ–°
                                    </button>
                                </div>
                                <div v-if="weather.loading" class="text-[10px] text-slate-400">
                                    è®€å–ä¸­â€¦
                                </div>
                                <div v-else-if="weather.error" class="text-[10px] text-rose-400">
                                    {{ weather.error }}
                                </div>
                                <div v-else class="space-y-1">
                                    <p class="text-xs font-semibold">
                                        {{ weather.summary || 'å°šæœªå–å¾—' }}
                                    </p>
                                    <p class="text-[10px] text-slate-400">
                                        {{ weather.tempRange || '' }}
                                    </p>
                                </div>
                            </div>

                            <div class="bg-slate-900/70 rounded-xl px-2.5 py-2 border border-slate-700/90">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-slate-400 flex items-center gap-1">
                                        <i class="ph-bold ph-wallet text-[13px] text-emerald-300"></i>
                                        é ç®—
                                    </span>
                                    <button
                                            @click="viewMode = 'money'"
                                            class="text-[10px] text-slate-400 hover:text-emerald-300">
                                        çœ‹åˆ†å¸³
                                    </button>
                                </div>
                                <p class="text-xs">
                                    ä»Šæ—¥é ç®—ï¼š
                                    <span class="font-semibold text-emerald-300">{{ dailyBudgetDisplay }}</span>
                                </p>
                                <p class="text-[10px] text-slate-400 mt-0.5">
                                    å·²ç™»è¨˜èŠ±è²»ï¼š
                                    <span class="font-semibold text-rose-300">{{ todaySpentDisplay }}</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- å°æé†’å¡ -->
                    <div class="card-glass rounded-2xl border border-emerald-700/60 p-3 shadow-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full floating-badge flex items-center justify-center">
                                <i class="ph-bold ph-lightning text-white text-lg"></i>
                            </div>
                            <div class="min-w-0">
                                <h3 class="text-sm font-semibold text-emerald-100">å°å¹«æ‰‹å»ºè­°</h3>
                                <p class="text-[11px] text-emerald-100/80">
                                    æ—…ç¨‹ä¸­æƒ³åˆ°çš„é›œäº‹å¯ä»¥ä¸Ÿåˆ°æ¸…å–®æˆ–ç¿»è­¯å€å…ˆè¨˜ä¸‹
                                </p>
                            </div>
                        </div>
                        <ul class="text-[11px] text-slate-200 space-y-1 list-disc list-inside">
                            <li>è¡Œç¨‹å¡ç‰‡å¯ä»¥æ‹–æ›³æ’åºï¼Œé•·æŒ‰å·¦å´æ™‚é–“åœ“é»å³å¯èª¿æ•´é †åº</li>
                            <li>æ¯å€‹å¡ç‰‡å¯ä»¥è¨­å®šåœ°é»ã€å‚™è¨»ï¼Œæˆ–ç”¨ã€Œé™„è¿‘å°å¹«æ‰‹ã€æ‰¾åƒçš„</li>
                            <li>åˆ†å¸³å€æœƒè‡ªå‹•å¹«ä½ ç®—æ¯å€‹äººå¤šä»˜ / å°‘ä»˜å¤šå°‘</li>
                        </ul>
                    </div>
                </div>

                <!-- è¡Œç¨‹ Timeline -->
                <div class="mt-2 bg-slate-950/80 rounded-2xl border border-slate-800/80 p-3 max-h-[420px] overflow-y-auto scrollbar-thin">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xs font-semibold tracking-wide text-slate-200 flex items-center gap-1.5">
                            <i class="ph-bold ph-timer text-sky-300 text-sm"></i>
                            ä»Šæ—¥è¡Œç¨‹
                        </h2>
                        <div class="flex items-center gap-2">
                            <button
                                    @click="addItem"
                                    class="text-[11px] px-2 py-1 rounded-full bg-sky-900/50 border border-sky-500/80 text-sky-100 hover:bg-sky-800">
                                <i class="ph-bold ph-plus text-xs"></i>
                                æ–°å¢è¡Œç¨‹
                            </button>
                            <button
                                    @click="clearDay"
                                    class="text-[11px] px-2 py-1 rounded-full bg-rose-950/60 border border-rose-500/80 text-rose-100 hover:bg-rose-900">
                                <i class="ph-bold ph-trash text-xs"></i>
                                æ¸…ç©º
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div v-if="!currentDay.items.length" class="text-center py-8 text-[12px] text-slate-500">
                            é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹ï¼Œå…ˆæ–°å¢ä¸€å€‹å§ï¼
                        </div>

                        <!-- å–®ä¸€è¡Œç¨‹é …ç›® -->
                        <div
                                v-for="(item, idx) in currentDay.items"
                                :key="idx"
                                class="flex gap-3">

                            <!-- æ™‚é–“è»¸å·¦å´ -->
                            <div class="flex flex-col items-center w-8 mt-1">
                                <div class="timeline-dot cursor-grab active:cursor-grabbing"></div>
                                <div v-if="idx !== currentDay.items.length - 1" class="flex-1 w-[2px] bg-gradient-to-b from-sky-500/60 via-sky-500/20 to-transparent mt-1"></div>
                            </div>

                            <!-- å³å´å¡ç‰‡ -->
                            <div class="flex-1 bg-slate-900/80 rounded-2xl border border-slate-700/80 p-3 shadow-sm hover:border-sky-500/60 transition-all">
                                <div class="flex items-start justify-between gap-2">
                                    <!-- å…§å®¹ -->
                                    <div class="flex-1 min-w-0 pt-1 space-y-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <input
                                                    v-model="item.time"
                                                    placeholder="æ™‚é–“ (ä¾‹å¦‚ 09:30)"
                                                    class="w-24 text-[11px] bg-slate-950/80 border border-slate-700 rounded-full px-2 py-1 text-slate-100 focus:outline-none focus:border-sky-500"
                                            />
                                            <select
                                                    v-model="item.type"
                                                    class="text-[11px] bg-slate-950 border border-slate-700 rounded-full px-2 py-1 text-slate-100 focus:outline-none focus:border-sky-500">
                                                <option value="spot">æ™¯é»</option>
                                                <option value="food">ç¾é£Ÿ</option>
                                                <option value="shop">è³¼ç‰©</option>
                                                <option value="transport">ç§»å‹•</option>
                                                <option value="other">å…¶ä»–</option>
                                            </select>
                                        </div>

                                        <div class="flex items-center gap-1">
                                            <i class="ph-bold ph-note-pencil text-sky-300 text-xs"></i>
                                            <input
                                                    v-model="item.activity"
                                                    placeholder="è¦åšä»€éº¼ï¼Ÿï¼ˆä¾‹å¦‚ï¼šé€›æ·ºè‰å¯ºã€å¥ˆè‰¯é¤µé¹¿ï¼‰"
                                                    class="flex-1 text-xs bg-transparent input-underline text-slate-100 focus:outline-none"
                                            />
                                        </div>

                                        <div class="flex items-center gap-1">
                                            <i class="ph-bold ph-map-pin-area text-emerald-300 text-xs"></i>
                                            <input
                                                    v-model="item.location"
                                                    placeholder="åœ°é»ï¼ˆå»ºè­°å¯«æˆ Google Map ä¸Šçš„åç¨±æ–¹ä¾¿æŸ¥ï¼‰"
                                                    class="flex-1 text-xs bg-transparent input-underline text-slate-200 focus:outline-none"
                                            />
                                        </div>

                                        <div class="flex items-center gap-1">
                                            <i class="ph-bold ph-info text-indigo-300 text-xs"></i>
                                            <input
                                                    v-model="item.note"
                                                    placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šè¨˜å¾—å…ˆé ç´„ / å¯é€€ç¨… / æ‹ç…§å¥½ä½ç½®ï¼‰"
                                                    class="flex-1 text-[11px] bg-transparent input-underline text-slate-300 focus:outline-none"
                                            />
                                        </div>

                                        <!-- äº¤é€šæ–¹å¼ & å¾ä¸Šä¸€å€‹åœ°é»éä¾†çš„æ™‚é–“ -->
                                        <div v-if="idx > 0" class="mt-2 p-2 bg-slate-900/70 rounded-lg border border-slate-700">
                                            <div class="flex items-center justify-between gap-2 mb-1">
                                                <div class="flex items-center gap-1 text-[11px] text-slate-300">
                                                    <i class="ph-bold ph-route"></i>
                                                    <span>å¾ä¸Šä¸€å€‹åœ°é»éä¾†</span>
                                                </div>
                                                <button
                                                        @click="estimateTravelTime(idx)"
                                                        class="text-[10px] px-2 py-1 rounded-full border border-teal-500/60 text-teal-200 hover:bg-teal-600/20">
                                                    è‡ªå‹•ä¼°æ™‚é–“
                                                </button>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <select
                                                        v-model="item.transportMode"
                                                        class="text-[11px] bg-slate-950 border border-slate-700 rounded-md py-1 px-2 text-slate-100">
                                                    <option value="walk">ğŸš¶â€â™‚ï¸ èµ°è·¯</option>
                                                    <option value="train">ğŸš† é›»è»Š / åœ°éµ</option>
                                                    <option value="bus">ğŸšŒ å…¬è»Š</option>
                                                    <option value="taxi">ğŸš• è¨ˆç¨‹è»Š</option>
                                                </select>
                                                <input
                                                        v-model="item.travelTimeText"
                                                        class="flex-1 text-[11px] text-slate-200 bg-transparent border-b border-dashed border-slate-600 focus:outline-none py-0.5"
                                                        placeholder="ä¾‹å¦‚ï¼šç´„ 15 åˆ†é˜">
                                            </div>
                                            <p class="mt-1 text-[10px] text-slate-500">
                                                * ä¼°ç®—æ™‚é–“åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ä¾ç•¶å¤©äº¤é€šæƒ…æ³ç‚ºä¸»ã€‚
                                            </p>
                                        </div>

                                        <!-- ç¾é£Ÿæ¨è–¦ -->
                                        <div v-if="item.type === 'food'" class="mt-2">
                                            <button
                                                    @click="searchNearby(item, idx)"
                                                    class="text-[11px] px-2 py-1 rounded-full border border-amber-400/70 text-amber-200 bg-amber-900/40 hover:bg-amber-800/70">
                                                <i class="ph-bold ph-fork-knife text-xs mr-0.5"></i>
                                                é™„è¿‘ç¾é£Ÿå°å¹«æ‰‹
                                            </button>

                                            <div v-if="isSearchingRecs && searchTargetIndex === idx" class="mt-1 text-[10px] text-amber-200 flex items-center gap-1">
                                                <i class="ph-bold ph-spinner-gap animate-spin"></i>
                                                å¹«ä½ æ‰¾åƒçš„ä¸­â€¦
                                            </div>

                                            <div v-if="recommendationsMap[idx]?.length" class="mt-2 space-y-1.5">
                                                <div
                                                        v-for="rec in recommendationsMap[idx]"
                                                        :key="rec.place_id"
                                                        class="bg-slate-900/90 border border-amber-500/40 rounded-xl px-2.5 py-1.5 text-[11px] text-slate-100 flex items-start justify-between gap-2">
                                                    <div class="space-y-0.5 min-w-0">
                                                        <div class="flex items-center gap-1.5">
                                                            <span class="font-semibold text-amber-100 truncate max-w-[150px]">{{ rec.name }}</span>
                                                            <span class="text-[10px] text-amber-300 bg-amber-900/60 border border-amber-500/40 rounded-full px-1.5 py-0.5 flex-shrink-0">
                                                                â˜… {{ rec.rating || 'N/A' }}
                                                            </span>
                                                        </div>
                                                        <p class="text-[10px] text-slate-400 truncate max-w-[200px]">
                                                            {{ rec.vicinity || rec.address || '' }}
                                                        </p>
                                                    </div>
                                                    <button
                                                            @click="applyRecommendation(item, rec)"
                                                            class="text-[10px] px-2 py-1 rounded-full bg-amber-500/90 text-slate-900 font-medium hover:bg-amber-400 flex-shrink-0">
                                                        å¥—ç”¨
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- å³ä¸Šè§’å·¥å…· -->
                                    <div class="flex flex-col items-center gap-2 mt-1 ml-1">
                                        <button
                                                @click="duplicateItem(idx)"
                                                class="w-7 h-7 rounded-full bg-slate-900 border border-slate-700/80 flex items-center justify-center text-slate-300 hover:border-sky-400 hover:text-sky-300">
                                            <i class="ph-bold ph-copy text-xs"></i>
                                        </button>
                                        <button
                                                @click="removeItem(idx)"
                                                class="w-7 h-7 rounded-full bg-slate-900 border border-slate-700/80 flex items-center justify-center text-rose-300 hover:border-rose-400 hover:text-rose-200">
                                            <i class="ph-bold ph-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- å–®ä¸€è¡Œç¨‹é …ç›® end -->
                    </div>
                </div>
            </section>

            <!-- åˆ†å¸³é  -->
            <section v-if="viewMode === 'money'" class="px-4 pb-4 space-y-3">
                <!-- åŒ¯ç‡ & æˆå“¡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3 space-y-2">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-400 flex items-center justify-center shadow-lg shadow-emerald-400/40">
                                    <i class="ph-bold ph-currency-circle-dollar text-slate-950 text-lg"></i>
                                </div>
                                <div>
                                    <h2 class="text-sm font-semibold text-emerald-100">åŒ¯ç‡è¨­å®š</h2>
                                    <p class="text-[11px] text-slate-400">
                                        å°‡ç•¶åœ°è²¨å¹£æ›ç®—æˆæ–°å°å¹£
                                    </p>
                                </div>
                            </div>
                            <button
                                    @click="detectRate"
                                    class="text-[11px] px-2 py-1 rounded-full border border-emerald-400/80 text-emerald-200 hover:bg-emerald-900/60">
                                ä¸€éµå¸¶å…¥å»ºè­°
                            </button>
                        </div>

                        <div class="flex items-center gap-2 mt-1">
                            <input
                                    v-model.number="exchangeRate.rate"
                                    type="number"
                                    step="0.01"
                                    class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-[13px] text-slate-100 focus:outline-none focus:border-emerald-500"
                                    placeholder="1 ç•¶åœ°è²¨å¹£ = å¹¾å…ƒå°å¹£ï¼Ÿ"
                            />
                            <span class="text-[11px] text-slate-400">{{ exchangeRate.note || 'ä¾‹å¦‚ï¼š1 æ—¥åœ“ â‰ˆ 0.23 TWD' }}</span>
                        </div>
                    </div>

                    <!-- æˆå“¡è¨­å®š -->
                    <div class="bg-slate-800/90 p-3 rounded-xl border border-slate-700 shadow-sm space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="text-xs font-bold text-slate-300 flex items-center gap-1">
                                <i class="ph-bold ph-users-three"></i>
                                åˆ†å¸³æˆå“¡
                            </div>
                            <div class="flex items-center gap-2 text-[11px] text-slate-400">
                                <span>äººæ•¸</span>
                                <select
                                        v-model.number="participantCount"
                                        @change="updateParticipantCount"
                                        class="bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-xs text-slate-100">
                                    <option v-for="n in 8" :key="n" :value="n">{{ n }} äºº</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="(p, idx) in participants" :key="idx" class="flex items-center gap-2">
                                <span class="text-[11px] text-slate-400 w-10 text-right">æˆå“¡{{ idx + 1 }}</span>
                                <input
                                        v-model="participants[idx]"
                                        @input="syncParticipantsStr"
                                        class="flex-1 bg-slate-900 border border-slate-600 rounded-lg text-xs px-2 py-1 text-slate-100"
                                        placeholder="è¼¸å…¥åç¨±">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¨˜å¸³ & çµç®— -->
                <div class="grid grid-cols-1 md:grid-cols-[1.2fr,1.1fr] gap-3">
                    <!-- è¨˜å¸³è¼¸å…¥ -->
                    <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h2 class="text-sm font-semibold text-slate-100 flex items-center gap-1.5">
                                <i class="ph-bold ph-notebook text-emerald-300 text-sm"></i>
                                æ–°å¢èŠ±è²»
                            </h2>
                            <span class="text-[11px] text-slate-400">
                                å–®ä½ï¼š{{ exchangeRate.currency || 'ç•¶åœ°å¹£' }}
                            </span>
                        </div>

                        <div class="space-y-2 text-[13px]">
                            <input
                                    v-model="newExpense.item"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-500"
                                    placeholder="ç”¨é€”ï¼ˆä¾‹å¦‚ï¼šæ™šé¤ã€åœ°éµç¥¨ã€é–€ç¥¨ï¼‰"
                            />
                            <div class="flex gap-2">
                                <input
                                        v-model.number="newExpense.amount"
                                        type="number"
                                        class="flex-1 bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-500"
                                        placeholder="é‡‘é¡"
                                />
                                <select
                                        v-model="newExpense.payer"
                                        class="w-32 bg-slate-950 border border-slate-700 rounded-xl px-2 py-2 text-slate-100 text-[12px] focus:outline-none focus:border-emerald-500">
                                    <option v-for="p in participants" :key="p" :value="p">
                                        {{ p }} ä»˜æ¬¾
                                    </option>
                                </select>
                            </div>
                            <div class="flex justify-end mt-1">
                                <button
                                        @click="addExpense"
                                        class="px-3 py-1.5 text-xs rounded-full bg-emerald-500/90 text-slate-950 font-semibold hover:bg-emerald-400">
                                    æ–°å¢ç´€éŒ„
                                </button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <h3 class="text-xs font-semibold text-slate-300 flex items-center gap-1 mb-1">
                                <i class="ph-bold ph-clock-counter-clockwise text-slate-400"></i>
                                èŠ±è²»åˆ—è¡¨
                            </h3>
                            <div class="max-h-40 overflow-y-auto scrollbar-thin space-y-1.5 text-[11px]">
                                <div
                                        v-for="(e, idx) in expenses"
                                        :key="idx"
                                        class="flex items-center justify-between bg-slate-950/80 border border-slate-700 rounded-xl px-2.5 py-1.5">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium text-slate-100 truncate">
                                                {{ e.item }}
                                            </span>
                                            <span class="text-emerald-300 font-semibold ml-2">
                                                {{ e.amount }} {{ exchangeRate.currency || '' }}
                                            </span>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-0.5">
                                            {{ e.payer }} ä»˜æ¬¾ Â· ç´„ {{ (e.amount * (exchangeRate.rate || 0)).toFixed(0) }} TWD
                                        </p>
                                    </div>
                                    <button
                                            @click="removeExpense(idx)"
                                            class="ml-2 text-rose-300 hover:text-rose-200">
                                        <i class="ph-bold ph-x text-xs"></i>
                                    </button>
                                </div>
                                <p v-if="!expenses.length" class="text-[11px] text-slate-500 text-center py-4">
                                    ç›®å‰é‚„æ²’æœ‰ä»»ä½•èŠ±è²»ç´€éŒ„
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- çµç®—çµæœ -->
                    <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3">
                        <h2 class="text-sm font-semibold text-slate-100 mb-2 flex items-center gap-1.5">
                            <i class="ph-bold ph-scales text-emerald-300 text-sm"></i>
                            åˆ†å¸³çµæœ
                        </h2>
                        <div class="grid grid-cols-2 gap-2 text-[11px] mb-2">
                            <div class="bg-slate-950/80 rounded-xl border border-slate-700 px-3 py-2">
                                <p class="text-slate-400 text-[10px]">ç¸½èŠ±è²» (ç•¶åœ°å¹£)</p>
                                <p class="text-emerald-300 font-semibold text-sm">
                                    {{ totalAmount }} {{ exchangeRate.currency || '' }}
                                </p>
                            </div>
                            <div class="bg-slate-950/80 rounded-xl border border-slate-700 px-3 py-2">
                                <p class="text-slate-400 text-[10px]">ç¸½èŠ±è²» (æ–°å°å¹£)</p>
                                <p class="text-emerald-300 font-semibold text-sm">
                                    {{ totalTwd }} TWD
                                </p>
                            </div>
                        </div>

                        <div class="bg-slate-950/80 rounded-xl border border-slate-700 px-3 py-2 text-[11px] mb-2">
                            <p class="text-slate-400 text-[10px] mb-1">æ¯äººæ‡‰åˆ†æ”¤ï¼š</p>
                            <p class="text-slate-100">
                                {{ perPersonLocal }} {{ exchangeRate.currency || '' }} â‰ˆ
                                {{ perPersonTwd }} TWD
                            </p>
                        </div>

                        <div class="space-y-1.5 text-[11px] max-h-36 overflow-y-auto scrollbar-thin">
                            <div
                                    v-for="p in participants"
                                    :key="p"
                                    class="bg-slate-950/80 rounded-xl border border-slate-700 px-3 py-2 flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-slate-100">{{ p }}</p>
                                    <p class="text-[10px] text-slate-400">
                                        å¯¦éš›æ”¯ä»˜ï¼š{{ paidByPerson[p] || 0 }} {{ exchangeRate.currency || '' }}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p
                                            v-if="balance[p] > 1"
                                            class="text-emerald-300 text-[11px] font-semibold">
                                        å¤šä»˜ {{ balance[p].toFixed(1) }}ï¼Œæ‡‰æ‹¿å›éŒ¢
                                    </p>
                                    <p
                                            v-else-if="balance[p] < -1"
                                            class="text-rose-300 text-[11px] font-semibold">
                                        å°‘ä»˜ {{ (-balance[p]).toFixed(1) }}ï¼Œæ‡‰è£œéŒ¢
                                    </p>
                                    <p v-else class="text-slate-400 text-[10px]">
                                        å¤§è‡´å¹³è¡¡
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-2 text-[10px] text-slate-500">
                            â€» ç›®å‰æ¡å¹³å‡åˆ†æ”¤ï¼šæ‰€æœ‰èŠ±è²»å¹³å‡åˆ†çµ¦æ¯ä¸€ä½æˆå“¡ã€‚
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ¸…å–®é  -->
            <section v-if="viewMode === 'checklist'" class="px-4 pb-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3">
                        <h2 class="text-sm font-semibold text-slate-100 mb-2 flex items-center gap-1.5">
                            <i class="ph-bold ph-suitcase-simple text-sky-300 text-sm"></i>
                            è¡Œæ / å¿…å‚™ç‰©å“
                        </h2>
                        <div class="space-y-2 text-[12px] max-h-64 overflow-y-auto scrollbar-thin">
                            <div
                                    v-for="(item, idx) in checklist.items"
                                    :key="idx"
                                    class="flex items-center gap-2 bg-slate-950/80 border border-slate-700 rounded-xl px-3 py-2">
                                <input
                                        type="checkbox"
                                        v-model="item.done"
                                        class="w-3.5 h-3.5 rounded border-slate-500 text-sky-400 focus:ring-0 focus:ring-offset-0"
                                />
                                <input
                                        v-model="item.text"
                                        class="flex-1 bg-transparent text-[12px] text-slate-100 focus:outline-none"
                                        placeholder="ä¾‹å¦‚ï¼šè­·ç…§ã€å……é›»å™¨ã€é›¨å‚˜"
                                />
                                <button
                                        @click="checklist.items.splice(idx,1)"
                                        class="text-rose-300 hover:text-rose-200">
                                    <i class="ph-bold ph-x text-xs"></i>
                                </button>
                            </div>
                            <button
                                    @click="checklist.items.push({ text: '', done: false })"
                                    class="w-full mt-1 py-1.5 text-[11px] rounded-full border border-slate-600 text-slate-200 bg-slate-950/80 hover:border-sky-500 hover:text-sky-200">
                                æ–°å¢é …ç›®
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3">
                        <h2 class="text-sm font-semibold text-slate-100 mb-2 flex items-center gap-1.5">
                            <i class="ph-bold ph-list-checks text-emerald-300 text-sm"></i>
                            è¡Œç¨‹å‰ / å›åœ‹å‰æª¢æŸ¥
                        </h2>
                        <div class="space-y-2 text-[12px] max-h-64 overflow-y-auto scrollbar-thin">
                            <div
                                    v-for="(item, idx) in checklist.todos"
                                    :key="idx"
                                    class="flex items-center gap-2 bg-slate-950/80 border border-slate-700 rounded-xl px-3 py-2">
                                <input
                                        type="checkbox"
                                        v-model="item.done"
                                        class="w-3.5 h-3.5 rounded border-slate-500 text-emerald-400 focus:ring-0 focus:ring-offset-0"
                                />
                                <input
                                        v-model="item.text"
                                        class="flex-1 bg-transparent text-[12px] text-slate-100 focus:outline-none"
                                        placeholder="ä¾‹å¦‚ï¼šç¢ºèªè­·ç…§åˆ°æœŸã€è·Ÿå®¶äººå ±å‚™è¡Œç¨‹"
                                />
                                <button
                                        @click="checklist.todos.splice(idx,1)"
                                        class="text-rose-300 hover:text-rose-200">
                                    <i class="ph-bold ph-x text-xs"></i>
                                </button>
                            </div>
                            <button
                                    @click="checklist.todos.push({ text: '', done: false })"
                                    class="w-full mt-1 py-1.5 text-[11px] rounded-full border border-slate-600 text-slate-200 bg-slate-950/80 hover:border-emerald-500 hover:text-emerald-200">
                                æ–°å¢æª¢æŸ¥é …ç›®
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç¿»è­¯é  -->
            <section v-if="viewMode === 'translate'" class="px-4 pb-4 space-y-3">
                <div class="bg-slate-900/80 rounded-2xl border border-slate-800/80 p-3">
                    <h2 class="text-sm font-semibold text-slate-100 mb-2 flex items-center gap-1.5">
                        <i class="ph-bold ph-chat-circle-text text-sky-300 text-sm"></i>
                        å¸¸ç”¨å¥ / ç¿»è­¯å°ç´™æ¢
                    </h2>
                    <p class="text-[11px] text-slate-400 mb-2">
                        å¯ä»¥å…ˆæŠŠæƒ³è·Ÿåº—å“¡ã€é£¯åº—äººå“¡èªªçš„å…§å®¹æ‰“å¥½ï¼Œåˆ°ç¾å ´åªè¦çµ¦ä»–å€‘çœ‹å°±å¯ä»¥ã€‚
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-[12px]">
                        <div>
                            <label class="block text-[11px] text-slate-400 mb-1">ä¸­æ–‡åŸæ–‡</label>
                            <textarea
                                    v-model="translate.src"
                                    rows="7"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-sky-500"
                                    placeholder="ä¾‹å¦‚ï¼šå¯ä»¥å¹«æˆ‘æŠŠé€™å€‹ç”œé»ç¨å¾®åŠ ç†±ä¸€ä¸‹å—ï¼Ÿ"></textarea>
                        </div>
                        <div>
                            <label class="block text-[11px] text-slate-400 mb-1">ç¿»è­¯çµæœï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼‰</label>
                            <textarea
                                    v-model="translate.dst"
                                    rows="7"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-emerald-500"
                                    placeholder="åœ¨é€™è£¡å¡«ä¸Šç¿»è­¯å¥½çš„å…§å®¹"></textarea>
                        </div>
                    </div>
                    <div class="mt-2 text-[11px] text-slate-500">
                        â€» ç›®å‰ç¿»è­¯æ¬„æ˜¯ç´”æ‰‹å‹•è²¼ä¸Šï¼Œä½ å¯ä»¥æ­é… ChatGPT æˆ–ç¿»è­¯å·¥å…·ï¼ŒæŠŠçµæœè²¼éä¾†æ•´ç†ã€‚
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav border-t border-slate-800/80 px-4 py-2">
            <div class="flex items-center justify-between text-[11px] text-slate-300">
                <button
                        @click="viewMode = 'plan'"
                        class="flex flex-col items-center flex-1 py-1"
                        :class="viewMode === 'plan' ? 'text-sky-300' : 'text-slate-400'">
                    <i class="ph-bold ph-calendar-check text-lg mb-0.5"></i>
                    è¡Œç¨‹
                </button>
                <button
                        @click="viewMode = 'money'"
                        class="flex flex-col items-center flex-1 py-1"
                        :class="viewMode === 'money' ? 'text-emerald-300' : 'text-slate-400'">
                    <i class="ph-bold ph-wallet text-lg mb-0.5"></i>
                    åˆ†å¸³
                </button>
                <button
                        @click="viewMode = 'checklist'"
                        class="flex flex-col items-center flex-1 py-1"
                        :class="viewMode === 'checklist' ? 'text-amber-300' : 'text-slate-400'">
                    <i class="ph-bold ph-check-square-offset text-lg mb-0.5"></i>
                    æ¸…å–®
                </button>
                <button
                        @click="viewMode = 'translate'"
                        class="flex flex-col items-center flex-1 py-1"
                        :class="viewMode === 'translate' ? 'text-sky-300' : 'text-slate-400'">
                    <i class="ph-bold ph-translate text-lg mb-0.5"></i>
                    ç¿»è­¯
                </button>
            </div>
        </nav>

        <!-- Trip List Modal -->
        <div
                v-if="showTripList"
                class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40">
            <div class="bg-slate-900 rounded-2xl border border-slate-700 w-[92%] max-w-md p-4 shadow-2xl max-h-[80vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-slate-100 flex items-center gap-1.5">
                        <i class="ph-bold ph-list text-sky-300"></i>
                        æˆ‘çš„æ—…ç¨‹
                    </h2>
                    <button
                            @click="showTripList = false"
                            class="text-slate-400 hover:text-slate-200">
                        <i class="ph-bold ph-x text-base"></i>
                    </button>
                </div>

                <div class="space-y-1.5 text-[12px]">
                    <div
                            v-for="trip in tripList"
                            :key="trip.id"
                            class="flex items-center justify-between bg-slate-950/90 border border-slate-700 rounded-xl px-3 py-2 cursor-pointer hover:border-sky-500"
                            @click="switchTrip(trip.id)">
                        <div>
                            <p class="font-semibold text-slate-100 truncate max-w-[220px]">{{ trip.name }}</p>
                            <p class="text-[10px] text-slate-400">
                                {{ trip.dateRange || 'æœªè¨­å®šæ—¥æœŸ' }}
                            </p>
                        </div>
                        <i v-if="trip.id === currentTripId" class="ph-bold ph-check-circle text-emerald-400 text-lg"></i>
                    </div>
                    <p v-if="!tripList.length" class="text-[11px] text-slate-500 py-4 text-center">
                        ç›®å‰åªæœ‰é€™ä¸€å€‹æ—…ç¨‹ï¼Œä¹‹å¾Œå¯ä»¥è€ƒæ…®åšæˆå¤šæ—…ç¨‹ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼šæ±äº¬ / å¤§é˜ª / åŒ—æµ·é“ï¼‰
                    </p>
                </div>
            </div>
        </div>

        <!-- Setup Modal -->
        <div
                v-if="showSetup"
                class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-40">
            <div class="bg-slate-900 rounded-2xl border border-slate-700 w-[92%] max-w-lg p-5 shadow-2xl max-h-[88vh] overflow-y-auto scrollbar-thin">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold text-slate-100 flex items-center gap-1.5">
                        <i class="ph-bold ph-gear text-sky-300"></i>
                        æ—…ç¨‹è¨­å®š
                    </h2>
                    <button
                            @click="showSetup = false"
                            class="text-slate-400 hover:text-slate-200">
                        <i class="ph-bold ph-x text-base"></i>
                    </button>
                </div>

                <div class="space-y-4 text-[13px]">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">æ—…ç¨‹åç¨± / ç›®çš„åœ°</label>
                        <input
                                v-model="setup.destination"
                                class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-sky-500"
                                placeholder="ä¾‹å¦‚ï¼šæ±äº¬äº”æ—¥è‡ªç”±è¡Œ"
                        />
                    </div>

                    <div>
                        <label class="block text-xs text-slate-400 mb-1">åœ‹å®¶ / åŸå¸‚å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                        <input
                                v-model="setup.countryNote"
                                class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:border-sky-500"
                                placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬æ±äº¬ï¼Œä¸»è¦æ´»å‹•åœ¨æ–°å®¿ / ä¸Šé‡é™„è¿‘"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">å‡ºç™¼æ—¥æœŸ</label>
                            <input
                                    type="date"
                                    v-model="setup.startDate"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 text-xs focus:outline-none focus:border-sky-500"
                            />
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">å¤©æ•¸</label>
                            <input
                                    type="number"
                                    v-model.number="setup.days"
                                    min="1"
                                    max="30"
                                    class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 text-xs focus:outline-none focus:border-sky-500"
                                    placeholder="ä¾‹å¦‚ï¼š5"
                            />
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-400 mb-1">æ¯æ—¥é ç®—ï¼ˆæ–°å°å¹£ï¼‰</label>
                        <input
                                type="number"
                                v-model.number="setup.dailyBudget"
                                class="w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-slate-100 text-xs focus:outline-none focus:border-emerald-500"
                                placeholder="ä¾‹å¦‚ï¼š3000"
                        />
                    </div>

                    <div class="text-[11px] text-slate-500">
                        è¨­å®šå®Œæˆå¾Œï¼Œè¡Œç¨‹é é¢æœƒä¾ç…§å¤©æ•¸ç”¢ç”Ÿ D1 / D2 / D3â€¦ï¼Œä¹Ÿæœƒå¹«ä½ è¨ˆç®—è·é›¢å‡ºç™¼é‚„æœ‰å¹¾å¤©ã€‚
                    </div>

                    <div class="flex justify-end gap-2 pt-2">
                        <button
                                @click="showSetup = false"
                                class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 text-xs hover:bg-slate-800">
                            å–æ¶ˆ
                        </button>
                        <button
                                @click="applySetup"
                                class="px-4 py-1.5 rounded-full bg-sky-500 text-slate-950 text-xs font-semibold hover:bg-sky-400">
                            å¥—ç”¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- App Container end -->
</div> <!-- #app end -->

<script type="module">
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    const firebaseConfig = null;
    const useFirebase = false;

    let mapInstance = null;
    let userMarker = null;

    const GOOGLE_MAPS_API_KEY = ''; // æœ‰ key å†å¡«

    const geocodeCache = {};

    function toRad(deg) {
        return deg * Math.PI / 180;
    }

    function haversineDistanceKm(a, b) {
        const R = 6371;
        const dLat = toRad(b.lat - a.lat);
        const dLon = toRad(b.lon - a.lon);
        const lat1 = toRad(a.lat);
        const lat2 = toRad(b.lat);
        const h = Math.sin(dLat / 2) ** 2 +
                  Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(h));
    }

    function estimateDurationMinutes(distanceKm, mode) {
        let speedKmh = 4.5;
        if (mode === 'taxi') speedKmh = 30;
        else if (mode === 'bus') speedKmh = 20;
        else if (mode === 'train') speedKmh = 45;

        const hours = distanceKm / Math.max(speedKmh, 1);
        let minutes = Math.round(hours * 60);
        if (minutes < 3) minutes = 3;
        return minutes;
    }

    function formatMinutesToText(minutes) {
        if (!minutes || minutes <= 0) return '';
        if (minutes < 60) return `ç´„ ${minutes} åˆ†é˜`;
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        if (m === 0) return `ç´„ ${h} å°æ™‚`;
        return `ç´„ ${h} å°æ™‚ ${m} åˆ†é˜`;
    }

    async function geocodeNameToLatLng(name) {
        if (!name) return null;
        if (geocodeCache[name]) return geocodeCache[name];
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}&limit=1`);
            const data = await res.json();
            if (data && data[0]) {
                const coord = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                geocodeCache[name] = coord;
                return coord;
            }
        } catch (e) {
            console.error('Geocode å¤±æ•—', e);
        }
        return null;
    }

    async function getGoogleTravelTimeText(origin, destination, mode) {
        if (!GOOGLE_MAPS_API_KEY) return null;
        const modeMap = {
            walk: 'walking',
            bus: 'transit',
            train: 'transit',
            taxi: 'driving'
        };
        const gmMode = modeMap[mode] || 'walking';
        const url = `https://maps.googleapis.com/maps/api/distancematrix/json?units=metric&origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(destination)}&mode=${gmMode}&language=zh-TW&key=${GOOGLE_MAPS_API_KEY}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            const element = data.rows?.[0]?.elements?.[0];
            if (element && element.status === 'OK') {
                const minutes = Math.round(element.duration.value / 60);
                return formatMinutesToText(minutes);
            }
        } catch (e) {
            console.error('Google Distance Matrix å¤±æ•—æˆ–è¢«ç€è¦½å™¨æ“‹ä¸‹ (CORS)', e);
        }
        return null;
    }

    if (useFirebase && firebaseConfig) {
    }

    const app = createApp({
        setup() {
            const viewMode = ref('plan');

            const setup = reactive({
                destination: '',
                countryNote: '',
                startDate: '',
                days: 5,
                dailyBudget: 3000
            });

            const days = ref([
                { title: 'ç¬¬ä¸€å¤©', date: '', shortDate: '', items: [] },
                { title: 'ç¬¬äºŒå¤©', date: '', shortDate: '', items: [] },
                { title: 'ç¬¬ä¸‰å¤©', date: '', shortDate: '', items: [] },
                { title: 'ç¬¬å››å¤©', date: '', shortDate: '', items: [] },
                { title: 'ç¬¬äº”å¤©', date: '', shortDate: '', items: [] }
            ]);
            const currentDayIdx = ref(0);
            const currentDay = computed(() => days.value[currentDayIdx.value] || { items: [] });

            const expenses = ref([]);
            const exchangeRate = reactive({
                rate: 0,
                currency: '',
                note: ''
            });

            const participants = ref(['æˆ‘', 'æ—…ä¼´A']);
            const participantCount = ref(participants.value.length);
            const participantsStr = ref('æˆ‘, æ—…ä¼´A');
            const newExpense = ref({
                item: '',
                amount: '',
                payer: 'æˆ‘'
            });

            const checklist = reactive({
                items: [
                    { text: 'è­·ç…§ / èº«åˆ†è­‰', done: false },
                    { text: 'ç¾é‡‘ / ä¿¡ç”¨å¡ / ææ¬¾å¡', done: false },
                    { text: 'æ‰‹æ©Ÿã€å……é›»å™¨ã€è¡Œå‹•é›»æº', done: false },
                    { text: 'è½‰æ¥é ­ / è½‰æ¥æ’åº§', done: false }
                ],
                todos: [
                    { text: 'ç¢ºèªè­·ç…§æœ‰æ•ˆæœŸé™', done: false },
                    { text: 'èˆ‡å®¶äººå ±å‚™è¡Œç¨‹èˆ‡è¯çµ¡æ–¹å¼', done: false },
                    { text: 'ä¸‹è¼‰æˆ–æˆªåœ–è¡Œç¨‹ã€æ©Ÿç¥¨ã€é£¯åº—è³‡è¨Š', done: false }
                ]
            });

            const translate = reactive({
                src: '',
                dst: ''
            });

            const weather = reactive({
                loading: false,
                error: '',
                summary: '',
                tempRange: ''
            });

            const tripList = ref([]);
            const currentTripId = ref('trip_default');
            const showTripList = ref(false);
            const showSetup = ref(false);

            const countryInfoMap = {
                'æ±äº¬': { rate: 0.23, currency: 'JPY', note: '1 æ—¥åœ“ â‰ˆ 0.23 æ–°å°å¹£ï¼ˆè«‹ä¾å¯¦éš›åŒ¯ç‡èª¿æ•´ï¼‰' },
                'æ—¥æœ¬': { rate: 0.23, currency: 'JPY', note: '1 æ—¥åœ“ â‰ˆ 0.23 æ–°å°å¹£' },
                'å¤§é˜ª': { rate: 0.23, currency: 'JPY', note: '1 æ—¥åœ“ â‰ˆ 0.23 æ–°å°å¹£' },
                'éŸ“åœ‹': { rate: 0.024, currency: 'KRW', note: '1000 éŸ“åœ“ â‰ˆ 24 æ–°å°å¹£' },
                'é¦–çˆ¾': { rate: 0.024, currency: 'KRW', note: '1000 éŸ“åœ“ â‰ˆ 24 æ–°å°å¹£' },
                'ç¾åœ‹': { rate: 32, currency: 'USD', note: '1 ç¾é‡‘ â‰ˆ 32 æ–°å°å¹£' },
                'ç´ç´„': { rate: 32, currency: 'USD', note: '1 ç¾é‡‘ â‰ˆ 32 æ–°å°å¹£' },
                'æ­æ´²': { rate: 35, currency: 'EUR', note: '1 æ­å…ƒ â‰ˆ 35 æ–°å°å¹£' },
                'å°ç£': { rate: 1, currency: 'TWD', note: 'å·²ç¶“æ˜¯æ–°å°å¹£' }
            };

            const selectedCountryInfo = computed(() => {
                if (!setup.destination) return null;
                for (const key of Object.keys(countryInfoMap)) {
                    if (setup.destination.includes(key) || (setup.countryNote && setup.countryNote.includes(key))) {
                        return countryInfoMap[key];
                    }
                }
                return null;
            });

            const applySetup = () => {
                const daysCount = Math.max(1, Math.min(30, setup.days || 1));
                const old = [...days.value];
                days.value = Array.from({ length: daysCount }, (_, i) => {
                    const oldDay = old[i] || { items: [] };
                    return {
                        title: `ç¬¬ ${i + 1} å¤©`,
                        date: '',
                        shortDate: '',
                        items: oldDay.items || []
                    };
                });

                if (setup.startDate) {
                    const base = new Date(setup.startDate);
                    days.value.forEach((d, idx) => {
                        const dt = new Date(base);
                        dt.setDate(dt.getDate() + idx);
                        d.date = dt.toISOString().slice(0, 10);
                        d.shortDate = `${dt.getMonth() + 1}/${dt.getDate()}`;
                    });
                }

                const tripData = {
                    setup: JSON.parse(JSON.stringify(setup)),
                    days: JSON.parse(JSON.stringify(days.value)),
                    expenses: JSON.parse(JSON.stringify(expenses.value)),
                    participants: participantsStr.value
                };
                localStorage.setItem(currentTripId.value, JSON.stringify(tripData));
                rebuildTripList();
                showSetup.value = false;
            };

            const tripDateRange = computed(() => {
                if (!setup.startDate || !setup.days) return '';
                const start = new Date(setup.startDate);
                const end = new Date(setup.startDate);
                end.setDate(end.getDate() + setup.days - 1);
                const fmt = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                return `${fmt(start)} - ${fmt(end)} Â· å…± ${setup.days} å¤©`;
            });

            const daysToTrip = computed(() => {
                if (!setup.startDate) return null;
                const today = new Date();
                const start = new Date(setup.startDate);
                const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
                if (diff < 0) return 0;
                return diff;
            });

            const dailyBudgetDisplay = computed(() =>
                setup.dailyBudget ? `${setup.dailyBudget.toLocaleString()} TWD` : 'æœªè¨­å®š'
            );

            const todaySpentDisplay = computed(() => {
                if (!exchangeRate.rate || !exchangeRate.currency) return 'å°šæœªè¨­å®šåŒ¯ç‡';
                const total = expenses.value.reduce((sum, e) => sum + Number(e.amount || 0), 0);
                const twd = total * exchangeRate.rate;
                return `${total.toFixed(0)} ${exchangeRate.currency} â‰ˆ ${Math.round(twd).toLocaleString()} TWD`;
            });

            const addItem = () => currentDay.value.items.push({
                time: '',
                type: 'spot',
                activity: '',
                location: '',
                note: '',
                transportMode: 'walk',
                travelTimeText: ''
            });
            const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
            const clearDay = () => {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤é€™ä¸€å¤©æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ')) {
                    currentDay.value.items = [];
                }
            };
            const duplicateItem = (idx) => {
                const item = currentDay.value.items[idx];
                currentDay.value.items.splice(idx + 1, 0, JSON.parse(JSON.stringify(item)));
            };

            const detectRate = () => {
                const info = selectedCountryInfo.value;
                if (!info) {
                    alert('ç›®å‰ç„¡æ³•å¾ç›®çš„åœ°æ¨æ¸¬åŒ¯ç‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚');
                    return;
                }
                exchangeRate.rate = info.rate;
                exchangeRate.currency = info.currency;
                exchangeRate.note = info.note;
            };

            const addExpense = () => {
                if (!newExpense.value.item || !newExpense.value.amount || !newExpense.value.payer) {
                    alert('è«‹å¡«å¯«å®Œæ•´çš„èŠ±è²»è³‡è¨Š');
                    return;
                }
                expenses.value.push({
                    item: newExpense.value.item,
                    amount: Number(newExpense.value.amount),
                    payer: newExpense.value.payer
                });
                newExpense.value.item = '';
                newExpense.value.amount = '';
            };
            const removeExpense = (idx) => expenses.value.splice(idx, 1);

            const totalAmount = computed(() =>
                expenses.value.reduce((sum, e) => sum + Number(e.amount || 0), 0).toFixed(1)
            );
            const totalTwd = computed(() =>
                (expenses.value.reduce((sum, e) => sum + Number(e.amount || 0), 0) * (exchangeRate.rate || 0)).toFixed(0)
            );

            const perPersonLocal = computed(() => {
                if (!participants.value.length) return 0;
                const total = expenses.value.reduce((sum, e) => sum + Number(e.amount || 0), 0);
                return (total / participants.value.length).toFixed(1);
            });
            const perPersonTwd = computed(() => {
                if (!participants.value.length) return 0;
                const total = expenses.value.reduce((sum, e) => sum + Number(e.amount || 0), 0) * (exchangeRate.rate || 0);
                return (total / participants.value.length).toFixed(0);
            });

            const paidByPerson = computed(() => {
                const map = {};
                participants.value.forEach(p => map[p] = 0);
                expenses.value.forEach(e => {
                    if (!map[e.payer]) map[e.payer] = 0;
                    map[e.payer] += Number(e.amount || 0);
                });
                return map;
            });

            const balance = computed(() => {
                const each = Number(perPersonLocal.value || 0);
                const map = {};
                Object.entries(paidByPerson.value).forEach(([p, amt]) => {
                    map[p] = amt - each;
                });
                return map;
            });

            const updateParticipants = () => {
                participants.value = participantsStr.value.split(',').map(s=>s.trim()).filter(s=>s);
                participantCount.value = participants.value.length || 0;
                if (!participants.value.includes(newExpense.value.payer)) {
                    newExpense.value.payer = participants.value[0] || 'æˆ‘';
                }
            };
            const syncParticipantsStr = () => {
                participantsStr.value = participants.value.join(', ');
                if (!participants.value.includes(newExpense.value.payer)) {
                    newExpense.value.payer = participants.value[0] || 'æˆ‘';
                }
            };
            const updateParticipantCount = () => {
                const target = Math.max(1, Number(participantCount.value) || 1);
                const current = participants.value.length;
                if (current < target) {
                    for (let i = current; i < target; i++) {
                        participants.value.push(`æˆå“¡${i + 1}`);
                    }
                } else if (current > target) {
                    participants.value.splice(target);
                }
                syncParticipantsStr();
            };
            const updateDate = (e, d) => {
                d.date = e.target.value;
                if (d.date) {
                    const dt = new Date(d.date);
                    d.shortDate = `${dt.getMonth() + 1}/${dt.getDate()}`;
                } else {
                    d.shortDate = '';
                }
            };

            const rebuildTripList = () => {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('trip_'));
                tripList.value = keys.map(k => {
                    const obj = JSON.parse(localStorage.getItem(k) || '{}');
                    return {
                        id: k,
                        name: obj.setup?.destination || 'æœªå‘½åæ—…ç¨‹',
                        dateRange: (obj.setup && obj.setup.startDate && obj.setup.days)
                            ? (() => {
                                const start = new Date(obj.setup.startDate);
                                const end = new Date(obj.setup.startDate);
                                end.setDate(end.getDate() + obj.setup.days - 1);
                                const fmt = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                                return `${fmt(start)} - ${fmt(end)} Â· å…± ${obj.setup.days} å¤©`;
                            })()
                            : ''
                    };
                });
            };

            const switchTrip = (id) => {
                const str = localStorage.getItem(id);
                if (!str) return;
                try {
                    const data = JSON.parse(str);
                    if (data.setup) Object.assign(setup, data.setup);
                    if (data.days && Array.isArray(data.days)) days.value = data.days;
                    if (data.expenses && Array.isArray(data.expenses)) expenses.value = data.expenses;
                    if (data.participants) {
                        participantsStr.value = data.participants;
                        updateParticipants();
                    }
                    currentTripId.value = id;
                    showTripList.value = false;
                } catch (e) {
                    console.error(e);
                }

                const lDays = localStorage.getItem(`${id}_days`);
                const lExp = localStorage.getItem(`${id}_expenses`);
                const lUsers = localStorage.getItem(`${id}_users`);
                if(lDays) {
                    days.value = JSON.parse(lDays);
                    days.value.forEach(d => {
                        if (!d.items) d.items = [];
                        d.items.forEach(it => {
                            if (!it.transportMode) it.transportMode = 'walk';
                            if (typeof it.travelTimeText === 'undefined') it.travelTimeText = '';
                        });
                    });
                }
                if(lExp) expenses.value = JSON.parse(lExp);
                if(lUsers) { participantsStr.value = lUsers; updateParticipants(); }

                if (!setup.startDate) {
                    days.value.forEach((d) => {
                        d.shortDate = '';
                    });
                }
            };

            const fetchWeather = async () => {
                weather.loading = true;
                weather.error = '';
                try {
                    if (!setup.destination) {
                        weather.summary = 'å°šæœªè¨­å®šç›®çš„åœ°';
                        weather.tempRange = '';
                        return;
                    }
                    weather.summary = 'æ™´æ™‚å¤šé›²ï¼Œé©åˆæ•£æ­¥è¡Œç¨‹ï¼ˆç¤ºæ„ï¼‰';
                    weather.tempRange = 'ç´„ 10 â€“ 18Â°C Â· è¨˜å¾—å¸¶ä»¶å¤–å¥—';
                } catch (e) {
                    weather.error = 'å–å¾—å¤©æ°£è³‡è¨Šæ™‚ç™¼ç”Ÿå•é¡Œ';
                } finally {
                    weather.loading = false;
                }
            };

            const recommendationsMap = reactive({});
            const isSearchingRecs = ref(false);
            const searchTargetIndex = ref(null);

            const searchNearby = async (item, idx) => {
                if (!item.location && !setup.destination) {
                    alert('è«‹å…ˆå¡«å¯«åœ°é»æˆ–æ—…ç¨‹ç›®çš„åœ°');
                    return;
                }
                try {
                    isSearchingRecs.value = true;
                    searchTargetIndex.value = idx;
                    const q = item.location || setup.destination;
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`;
                    const res = await fetch(url);
                    const list = await res.json();
                    recommendationsMap[idx] = list.map(p => ({
                        place_id: p.place_id,
                        name: p.display_name.split(',')[0],
                        vicinity: p.display_name,
                        rating: (Math.random() * 2 + 3).toFixed(1)
                    }));
                } catch (e) {
                    console.error(e);
                    alert('å–å¾—é™„è¿‘åœ°é»æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå¯ä»¥ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•æŸ¥è©¢ã€‚');
                } finally {
                    isSearchingRecs.value = false;
                    searchTargetIndex.value = null;
                }
            };

            const applyRecommendation = (item, rec) => {
                item.activity = rec.name;
                item.location = rec.name;
            };

            const estimateTravelTime = async (index) => {
                const items = currentDay.value.items || [];
                if (index <= 0 || index >= items.length) {
                    return;
                }
                const prev = items[index - 1];
                const curr = items[index];
                if (!prev.location || !curr.location) {
                    alert('è«‹å…ˆåœ¨ã€Œä¸Šä¸€å€‹ã€ä»¥åŠã€Œé€™ä¸€å€‹ã€è¡Œç¨‹éƒ½å¡«å¯«åœ°é»ã€‚');
                    return;
                }
                if (!curr.transportMode) {
                    curr.transportMode = 'walk';
                }

                let textResult = null;
                try {
                    textResult = await getGoogleTravelTimeText(prev.location, curr.location, curr.transportMode);
                } catch (e) {
                    console.error(e);
                }

                if (!textResult) {
                    const origin = await geocodeNameToLatLng(prev.location);
                    const dest = await geocodeNameToLatLng(curr.location);
                    if (origin && dest) {
                        const distKm = haversineDistanceKm(origin, dest);
                        const minutes = estimateDurationMinutes(distKm, curr.transportMode);
                        textResult = `${formatMinutesToText(minutes)}ï¼ˆç›´ç·šè·é›¢ç´„ ${distKm.toFixed(1)} å…¬é‡Œï¼‰`;
                    } else {
                        textResult = 'ç„¡æ³•ä¼°ç®—ï¼Œè«‹åœ¨ Google Maps å†ç¢ºèªã€‚';
                    }
                }

                curr.travelTimeText = textResult;
            };

            const loadTripFromStorage = () => {
                const str = localStorage.getItem(currentTripId.value);
                if (str) {
                    try {
                        const data = JSON.parse(str);
                        if (data.setup) Object.assign(setup, data.setup);
                        if (data.days) days.value = data.days;
                        if (data.expenses) expenses.value = data.expenses;
                        if (data.participants) {
                            participantsStr.value = data.participants;
                            updateParticipants();
                        }
                    } catch (e) {
                        console.error(e);
                    }
                } else {
                    localStorage.setItem(currentTripId.value, JSON.stringify({
                        setup,
                        days: days.value,
                        expenses: [],
                        participants: participantsStr.value
                    }));
                }

                const lDays = localStorage.getItem(`${currentTripId.value}_days`);
                const lExp = localStorage.getItem(`${currentTripId.value}_expenses`);
                const lUsers = localStorage.getItem(`${currentTripId.value}_users`);
                if (lDays) days.value = JSON.parse(lDays);
                if (lExp) expenses.value = JSON.parse(lExp);
                if (lUsers) { participantsStr.value = lUsers; updateParticipants(); }

                if (setup.startDate) {
                    const base = new Date(setup.startDate);
                    days.value.forEach((d, idx) => {
                        if (!d.date) {
                            const dt = new Date(base);
                            dt.setDate(dt.getDate() + idx);
                            d.date = dt.toISOString().slice(0, 10);
                            d.shortDate = `${dt.getMonth() + 1}/${dt.getDate()}`;
                        }
                    });
                }

                // å…¼å®¹èˆŠè³‡æ–™ï¼šè£œäº¤é€šæ¬„ä½
                days.value.forEach(d => {
                    if (!d.items) d.items = [];
                    d.items.forEach(it => {
                        if (!it.transportMode) it.transportMode = 'walk';
                        if (typeof it.travelTimeText === 'undefined') it.travelTimeText = '';
                    });
                });
            };

            const rebuildLocalStructure = () => {
                const stored = localStorage.getItem(currentTripId.value);
                if (!stored) return;
                try {
                    const data = JSON.parse(stored);
                    localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(data.days || []));
                    localStorage.setItem(`${currentTripId.value}_expenses`, JSON.stringify(data.expenses || []));
                    localStorage.setItem(`${currentTripId.value}_users`, data.participants || '');
                } catch (e) {
                    console.error(e);
                }
            };

            onMounted(() => {
                rebuildTripList();
                loadTripFromStorage();
                rebuildLocalStructure();

                watch([days, expenses, exchangeRate, participantsStr], () => {
                    localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(days.value));
                    localStorage.setItem(`${currentTripId.value}_expenses`, JSON.stringify(expenses.value));
                    localStorage.setItem(`${currentTripId.value}_users`, participantsStr.value);
                }, { deep: true });

                fetchWeather();
            });

            return {
                viewMode, currentDayIdx, days, currentDay,
                participants, participantsStr, participantCount, updateParticipants, syncParticipantsStr, updateParticipantCount,
                setup, applySetup, tripDateRange, daysToTrip,
                addItem, removeItem, clearDay, duplicateItem,
                expenses, exchangeRate, newExpense,
                detectRate, addExpense, removeExpense,
                totalAmount, totalTwd, perPersonLocal, perPersonTwd,
                paidByPerson, balance,
                checklist, translate,
                dailyBudgetDisplay, todaySpentDisplay,
                weather, fetchWeather,
                tripList, currentTripId, showTripList, switchTrip, rebuildTripList,
                showSetup,
                updateDate,
                searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, estimateTravelTime, searchTargetIndex,
                loadTripFromStorage
            };
        }
    });

    app.mount('#app');
</script>
</body>
</html>
