<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÊóÖÈÅäË®àÁï´ | Travel Plan</title>
    <!-- Vue 3 (ESM) -->
    <script type="module" src="https://unpkg.com/vue@3/dist/vue.esm-browser.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #020617; /* Ê∑±Ëâ≤ËÉåÊôØ */
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.15s ease;
        }
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        .leaflet-control-zoom {
            display: none !important;
        }
        .marker-label {
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.8);
            box-shadow: 0 4px 10px rgba(15,23,42,0.7);
        }
        .marker-label-spot {
            border-color: rgba(52,211,153,0.9);
        }
        .marker-label-food {
            border-color: rgba(248,250,252,0.9);
        }
        .marker-label-transport {
            border-color: rgba(129,140,248,0.9);
        }
        .marker-label-flight {
            border-color: rgba(251,113,133,0.9);
        }
        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 rgba(34,197,94,0.7);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(34,197,94,0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 8px rgba(34,197,94,0);
            }
            100% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(34,197,94,0);
            }
        }
        .animate-fade-in {
            animation: fade-in-up 0.4s ease-out forwards;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Â∞èË¶ñÁ™óÊôÇÔºåËÆìÂ∫ïÈÉ®Â∞éËà™Âõ∫ÂÆöÂú®ÊâãÊ©üÈ¢®Ê†º */
        @media (max-width: 640px) {
            .mobile-bottom-nav {
                position: fixed;
                left: 50%;
                transform: translateX(-50%);
                bottom: 10px;
                width: 100%;
                max-width: 420px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="text-slate-100 bg-slate-900 h-screen flex flex-col overflow-hidden">

    <div id="app" class="relative flex flex-col h-full max-w-md mx-auto bg-slate-950/95 shadow-[0_0_60px_rgba(15,23,42,0.9)] rounded-none sm:rounded-3xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-800">

        <!-- HeaderÔºö‰∏äÊñπÂ§ßÊ®ô + Êó•Êúü + ÂÄíÊï∏ -->
        <header class="bg-gradient-to-b from-slate-900 via-slate-900/95 to-slate-900 text-white shrink-0 z-20">
            <div class="px-4 pt-4 pb-3 flex items-start justify-center relative">
                <!-- Â∑¶‰∏äËßíÔºöÊóÖÁ®ãÈÅ∏ÂñÆÊåâÈàï -->
                <button
                    @click="showTripMenu = true"
                    class="absolute left-4 top-4 text-slate-300 hover:text-white transition">
                    <i class="ph-bold ph-list text-2xl"></i>
                </button>

                <!-- ‰∏≠ÈñìÔºöÊ®ôÈ°åËàáÊó•Êúü -->
                <div class="text-center pr-8">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <i class="ph-fill ph-suitcase text-amber-300 text-xl"></i>
                        <input
                            v-model="setup.destination"
                            class="text-xl font-bold bg-transparent border-none text-center focus:outline-none focus:ring-0 placeholder-slate-500"
                            placeholder="Ëº∏ÂÖ•ÁõÆÁöÑÂú∞ (‰æãÔºöÈáúÂ±±ÊùæÂ≥∂)"
                        >
                    </div>
                    <div class="flex items-center justify-center gap-2 text-xs text-slate-300">
                        <input
                            type="date"
                            v-model="setup.startDate"
                            class="bg-slate-800/80 border border-slate-600 rounded-full px-3 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-emerald-400/70"
                        >
                        <span v-if="tripDateRange" class="font-mono text-emerald-300 px-2 py-0.5 rounded-full bg-emerald-950/60 border border-emerald-500/50">
                            {{ tripDateRange }}
                        </span>
                    </div>

                    <div v-if="daysToTrip !== null" class="mt-2 text-[11px] text-slate-400 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-calendar-check text-xs text-emerald-400"></i>
                        <span v-if="daysToTrip > 0">Ë∑ùÈõ¢Âá∫ÁôºÈÇÑÊúâ <span class="text-emerald-300 font-semibold">{{ daysToTrip }}</span> Â§©</span>
                        <span v-else-if="daysToTrip === 0">‰ªäÂ§©Â∞±ÊòØÂá∫ÁôºÊó• üéâ</span>
                        <span v-else>Ë°åÁ®ãÂ∑≤Á∂ìÁµêÊùüÂï¶ÔºåÂø´‰æÜË®òÈåÑÂøÉÂæó</span>
                    </div>
                </div>

                <!-- Âè≥‰∏äËßíÔºöË®≠ÂÆöÊåâÈàï -->
                <button
                    @click="showSetupModal = true"
                    class="absolute right-4 top-4 text-slate-300 hover:text-white transition">
                    <i class="ph-bold ph-gear-six text-2xl"></i>
                </button>
            </div>

            <!-- TabsÔºöË¶ñÂúñÂàáÊèõ -->
            <div class="px-4 pb-2 pt-1">
                <div class="bg-slate-900/80 border border-slate-800 rounded-full p-1 flex text-xs">
                    <button
                        @click="viewMode = 'plan'"
                        class="flex-1 py-1.5 rounded-full flex items-center justify-center gap-1 transition text-[11px]"
                        :class="viewMode === 'plan' ? 'bg-slate-800 text-emerald-300 shadow-inner' : 'text-slate-400 hover:text-slate-100'"
                    >
                        <i class="ph-bold ph-list-check text-sm"></i>
                        Ë°åÁ®ãË°®
                    </button>
                    <button
                        @click="viewMode = 'map'"
                        class="flex-1 py-1.5 rounded-full flex items-center justify-center gap-1 transition text-[11px]"
                        :class="viewMode === 'map' ? 'bg-slate-800 text-sky-300 shadow-inner' : 'text-slate-400 hover:text-slate-100'"
                    >
                        <i class="ph-bold ph-map-trifold text-sm"></i>
                        Âú∞Âúñ
                    </button>
                    <button
                        @click="viewMode = 'expense'"
                        class="flex-1 py-1.5 rounded-full flex items-center justify-center gap-1 transition text-[11px]"
                        :class="viewMode === 'expense' ? 'bg-slate-800 text-amber-300 shadow-inner' : 'text-slate-400 hover:text-slate-100'"
                    >
                        <i class="ph-bold ph-coins text-sm"></i>
                        Ëä±Ë≤ª
                    </button>
                    <button
                        @click="viewMode = 'checklist'"
                        class="flex-1 py-1.5 rounded-full flex items-center justify-center gap-1 transition text-[11px]"
                        :class="viewMode === 'checklist' ? 'bg-slate-800 text-violet-300 shadow-inner' : 'text-slate-400 hover:text-slate-100'"
                    >
                        <i class="ph-bold ph-clipboard-text text-sm"></i>
                        ÊâìÂåÖ
                    </button>
                </div>
            </div>
        </header>        

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 relative hide-scroll pb-24">

            <!-- Ë°åÁ®ãË°® (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 space-y-6">
                    <!-- ‰ªäÊó•ÊëòË¶Å + Â§©Ê∞£ -->
                    <div class="bg-slate-800/90 p-4 rounded-2xl shadow-sm border border-slate-700 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <!-- Èö±ÂΩ¢Êó•ÊúüÈÅ∏ÊìáÂô® -->
                            <input type="date" :value="currentDay.fullDate" @input="updateDate($event.target.value)" class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <!-- Êó•ÊúüÈ°ØÁ§∫ -->
                            <input
                                v-model="currentDay.date"
                                class="text-lg font-bold text-slate-50 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none"
                                placeholder="Day 1 (ÈªûÊìäË®≠ÂÆö)">
                            <input
                                v-model="currentDay.title"
                                class="text-sm text-slate-300 bg-transparent border-b border-dashed border-slate-600 focus:border-teal-400 focus:outline-none w-full mt-1"
                                placeholder="Ëº∏ÂÖ•Áï∂Êó•‰∏ªÈ°å (‰æãÂ¶ÇÔºöÊñ∞ÂÆøÈÄõË°ó / Ê≤≥Âè£Êπñ‰∏ÄÊó•ÈÅä)">
                        </div>
                        <!-- Â§©Ê∞£È°ØÁ§∫ -->
                        <div class="flex flex-col items-end pl-2">
                            <div v-if="weatherDisplay" class="text-right">
                                <div class="flex items-center justify-end gap-1 text-amber-300">
                                    <i :class="['ph-duotone', weatherDisplay.icon, 'text-2xl']"></i>
                                    <span class="text-xl font-bold font-mono whitespace-nowrap">{{ weatherDisplay.temp }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                    <i :class="weatherDisplay.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>
                                    {{ weatherDisplay.label }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ëà™Áè≠Âç°Áâá -->
                    <div>
                        <div v-if="currentDay.flight" class="relative bg-gradient-to-r from-sky-500 via-sky-400 to-teal-500 rounded-2xl text-white shadow-lg overflow-hidden">
                            <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-900 rounded-full z-10"></div>
                            <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-slate-900 rounded-full z-10"></div>
                            <div class="p-4 relative z-0">
                                <button @click="toggleFlightCard" class="absolute top-2 right-2 text-white/80 hover:text-white hover:bg-white/20 rounded-full p-1 transition">
                                    <i class="ph-bold ph-x"></i>
                                </button>
                                <div class="flex justify-between items-center mb-1 pt-2">
                                    <!-- Âá∫Áôº -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.departTime" class="bg-transparent text-lg font-mono text-white text-center border-none placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="text-[9px] opacity-70 mt-1">Ëµ∑È£õ (Áï∂Âú∞ÊôÇÈñì)</div>
                                        <input v-model="currentDay.flight.departAirport" class="bg-transparent text-xs uppercase tracking-widest border-none text-white/90 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="TPE">
                                    </div>
                                    <!-- Ë≥áË®ä -->
                                    <div class="flex flex-col items-center justify-center w-1/3 px-2">
                                        <i class="ph-fill ph-airplane text-2xl mb-1 transform rotate-90"></i>
                                        <input v-model="currentDay.flight.number" class="bg-transparent text-xs font-mono border-none text-white/90 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="BR198">
                                        <div class="w-full h-0.5 bg-white/40 rounded-full mt-1"></div>
                                    </div>
                                    <!-- ÊäµÈÅî -->
                                    <div class="flex flex-col items-center w-1/3">
                                        <input v-model="currentDay.flight.arriveTime" class="bg-transparent text-lg font-mono text-white text-center border-none placeholder-white/50 focus:outline-none focus:border-white font-mono p-0">
                                        <div class="text-[9px] opacity-70 mt-1">ÊäµÈÅî (Áï∂Âú∞ÊôÇÈñì)</div>
                                        <input v-model="currentDay.flight.arriveAirport" class="bg-transparent text-xs uppercase tracking-widest border-none text-white/90 placeholder-white/50 focus:ring-0 uppercase p-0" placeholder="PUS">
                                    </div>
                                </div>
                                <div class="text-[10px] flex justify-between text-white/80 mt-1">
                                    <span>Ëà™Á©∫ÂÖ¨Âè∏Ôºö<input v-model="currentDay.flight.airline" class="bg-transparent border-none p-0 focus:ring-0 text-[10px]"></span>
                                    <span>Â∫ß‰ΩçÔºö<input v-model="currentDay.flight.seat" class="bg-transparent border-none p-0 focus:ring-0 w-10 text-[10px]"></span>
                                </div>
                            </div>
                        </div>
                        <button
                            v-else
                            @click="toggleFlightCard"
                            class="mt-1 w-full py-3 border border-dashed border-slate-600/80 rounded-2xl text-slate-300 hover:border-slate-400 hover:bg-slate-800/70 transition flex items-center justify-center gap-2 group">
                            <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-bold">Êñ∞Â¢ûÁï∂Êó•Ëà™Áè≠Ë≥áË®ä</span>
                        </button>
                    </div>

                    <!-- Ë°åÁ®ãÊìç‰ΩúÂàóÔºöÊñ∞Â¢ûË°åÁ®ã + ÂÖ±Áî® -->
                    <div class="flex items-center justify-between gap-2 mt-1">
                        <div class="flex items-center gap-1 text-xs text-slate-400">
                            <i class="ph-bold ph-list-numbers text-sm"></i>
                            <span>‰ªäÊó•Ë°åÁ®ã</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button
                                @click="showShareModal = true"
                                class="flex items-center gap-1 text-[11px] px-2.5 py-1 rounded-full bg-slate-800 text-slate-100 border border-slate-600 hover:bg-slate-700"
                            >
                                <i class="ph-bold ph-users-three text-xs"></i>
                                ÂÖ±Áî®
                            </button>
                            <button
                                @click="addItem"
                                class="flex items-center gap-1 text-[11px] px-2.5 py-1 rounded-full bg-teal-500 text-slate-900 font-bold hover:bg-teal-400"
                            >
                                <i class="ph-bold ph-plus text-xs"></i>
                                Êñ∞Â¢ûË°åÁ®ã
                            </button>
                        </div>
                    </div>

                    <!-- Ë°åÁ®ã TimelineÔºöÂèØÊãñÊãâÊéíÂ∫è + ÈªûÂç°ÁâáÂá∫Á∑®ËºØË¶ñÁ™ó -->
                    <div class="relative mt-3 pl-4 border-l border-slate-700 space-y-3">
                        <div
                            v-for="(item, idx) in currentDay.items"
                            :key="idx"
                            class="relative group"
                            draggable="true"
                            @dragstart="onDragStart(idx)"
                            @dragover.prevent
                            @drop="onDrop(idx)"
                        >
                            <!-- ‰∏≤Á∑ö‰∏äÁöÑÂúìÈªû -->
                            <div
                                class="absolute -left-[21px] top-1/2 -translate-y-1/2 w-3 h-3 rounded-full border-2 border-slate-900 shadow-sm bg-rose-500"
                            ></div>

                            <!-- Ë°åÁ®ãÂç°Áâá -->
                            <div
                                class="bg-slate-800/90 hover:bg-slate-800 rounded-2xl shadow-sm border border-slate-700 hover:shadow-lg transition flex items-center gap-3 px-3 py-2 cursor-pointer"
                                @click="openEditModal(idx)"
                            >
                                <!-- Â∑¶ÔºöÊôÇÈñì -->
                                <div class="flex flex-col items-center justify-center w-[3.5rem]">
                                    <div class="text-[10px] text-slate-400 mb-0.5">
                                        {{ getTimePeriod(item.time) }}
                                    </div>
                                    <div class="text-lg font-mono font-semibold text-slate-50">
                                        {{ item.time || '--:--' }}
                                    </div>
                                </div>

                                <!-- ‰∏≠ÔºöÂú∞ÈªûÂêçÁ®± + ÂÇôË®ª -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2">
                                        <div
                                            class="w-6 h-6 rounded-full bg-rose-500 text-[11px] text-white flex items-center justify-center font-bold shrink-0"
                                        >
                                            {{ idx + 1 }}
                                        </div>
                                        <div class="font-semibold text-sm text-slate-50 truncate">
                                            {{ item.location || 'Èªû‰∏Ä‰∏ãÁ∑®ËºØÂú∞ÈªûÂêçÁ®±' }}
                                        </div>
                                    </div>

                                    <p v-if="item.note" class="text-[11px] text-slate-400 mt-0.5 line-clamp-1">
                                        ‚úèÔ∏è {{ item.note }}
                                    </p>
                                </div>

                                <!-- Âè≥ÔºöÂÅúÁïôÊôÇÈñì + Êìç‰Ωú -->
                                <div class="flex flex-col items-end gap-1 text-slate-400 text-[11px]">
                                    <span class="px-1.5 py-0.5 rounded-full bg-slate-900 border border-slate-600">
                                        ÂÅúÁïô {{ formatStay(item.stayMinutes) }}
                                    </span>
                                    <div class="flex gap-1">
                                        <button
                                            class="p-1 rounded-full hover:bg-slate-700"
                                            @click.stop="openNoteModal(idx)"
                                            title="ÊôØÈªûÁ≠ÜË®ò"
                                        >
                                            <i class="ph-bold ph-note-pencil text-xs"></i>
                                        </button>
                                        <button
                                            class="p-1 rounded-full hover:bg-slate-700"
                                            @click.stop="removeItem(idx)"
                                            title="Âà™Èô§"
                                        >
                                            <i class="ph-bold ph-trash text-xs text-rose-400"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ê≤íÊúâË°åÁ®ãÊôÇÊèêÁ§∫ -->
                        <div
                            v-if="currentDay.items.length === 0"
                            class="text-center text-xs text-slate-400 pt-4 pb-2"
                        >
                            ÈÇÑÊ≤íÊúâË°åÁ®ãÔºåÂÖàÁî®Âè≥‰∏äÁöÑ„ÄåÊñ∞Â¢ûË°åÁ®ã„ÄçÂä†‰∏ÄÁ≠ÜÂêßÔºÅ
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-800 text-center">
                        <button @click="removeCurrentDay" class="text-xs text-red-300 hover:text-red-500 flex items-center justify-center gap-1 mx-auto">
                            <i class="ph-bold ph-trash"></i> Âà™Èô§ÈÄô‰∏ÄÂ§©
                        </button>
                    </div>
                </div>
            </transition>

            <!-- Ë°åÁ®ãÁ∑®ËºØ Modal -->
            <transition name="fade">
                <div
                    v-if="editModalVisible"
                    class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4"
                >
                    <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-xl p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-slate-50 flex items-center gap-1">
                                <i class="ph-bold ph-map-pin text-rose-400"></i>
                                Á∑®ËºØË°åÁ®ã
                            </h2>
                            <button
                                class="text-slate-400 hover:text-slate-100"
                                @click="closeEditModal"
                            >
                                <i class="ph-bold ph-x text-lg"></i>
                            </button>
                        </div>

                        <div class="space-y-3 text-xs">
                            <!-- Âú∞ÈªûÂêçÁ®± -->
                            <div>
                                <label class="block mb-1 text-slate-300">Âú∞ÈªûÂêçÁ®±</label>
                                <input
                                    v-model="editForm.location"
                                    type="text"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    placeholder="‰æãÂ¶ÇÔºöÊùæÂ≥∂Êµ∑‰∏äÁ∫úËªä ÊùæÂ≥∂Sky Park"
                                />
                            </div>

                            <!-- ÊäµÈÅîÊôÇÈñì -->
                            <div>
                                <label class="block mb-1 text-slate-300">ÊäµÈÅîÊôÇÈñì</label>
                                <div class="flex items-center gap-2">
                                    <input
                                        v-model="editForm.time"
                                        type="time"
                                        class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    />
                                    <span class="text-[11px] text-slate-400">
                                        ÔºàÁ≥ªÁµ±Ë¶èÂäÉÔºèÊâãÂãïÁöÜÂèØÔºâ
                                    </span>
                                </div>
                            </div>

                            <!-- ÂÅúÁïôÊôÇÈñì -->
                            <div>
                                <label class="block mb-1 text-slate-300">ÂÅúÁïôÊôÇÈñì</label>
                                <div class="flex items-center gap-2">
                                    <select
                                        v-model.number="editForm.stayHours"
                                        class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-2 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    >
                                        <option :value="h" v-for="h in [0,1,2,3,4,5]"> {{ h }} Â∞èÊôÇ</option>
                                    </select>
                                    <select
                                        v-model.number="editForm.stayMinutes"
                                        class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-2 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    >
                                        <option :value="m" v-for="m in [0,15,30,45]"> {{ m }} ÂàÜÈêò</option>
                                    </select>
                                </div>
                            </div>

                            <!-- È†ê‰º∞Èõ¢ÈñãÊôÇÈñì -->
                            <div class="border-t border-slate-700 pt-3 mt-2">
                                <div class="flex items-center justify-between text-xs text-slate-300">
                                    <span>È†ê‰º∞Èõ¢ÈñãÊôÇÈñì</span>
                                    <span class="font-mono text-teal-300">
                                        {{ estimatedLeaveTime || '--:--' }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-4">
                            <button
                                class="px-4 py-2 rounded-xl text-xs font-bold border border-slate-600 text-slate-200 hover:bg-slate-800"
                                @click="closeEditModal"
                            >
                                ÂèñÊ∂à
                            </button>
                            <button
                                class="px-4 py-2 rounded-xl text-xs font-bold bg-teal-500 text-slate-900 hover:bg-teal-400"
                                @click="saveEditModal"
                            >
                                ÂÑ≤Â≠ò
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- ÊôØÈªûÁ≠ÜË®ò Modal -->
            <transition name="fade">
                <div
                    v-if="noteModalVisible"
                    class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4"
                >
                    <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-xl p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-slate-50">ÊôØÈªûÁ≠ÜË®ò</h2>
                            <button
                                class="text-slate-400 hover:text-slate-100"
                                @click="closeNoteModal"
                            >
                                <i class="ph-bold ph-x text-lg"></i>
                            </button>
                        </div>

                        <textarea
                            v-model="noteText"
                            rows="6"
                            class="w-full rounded-2xl bg-slate-800 border border-slate-600 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                            placeholder="ÂèØ‰ª•Ë®ò‰∏Ä‰∫õÂøÉÂæó„ÄÅ‰∫§ÈÄöÊèêÈÜí„ÄÅÊãçÁÖßËßíÂ∫¶‚Ä¶"
                        ></textarea>

                        <div class="flex justify-end gap-2 mt-4">
                            <button
                                class="px-4 py-2 rounded-xl text-xs font-bold border border-slate-600 text-slate-200 hover:bg-slate-800"
                                @click="closeNoteModal"
                            >
                                ÂèñÊ∂à
                            </button>
                            <button
                                class="px-4 py-2 rounded-xl text-xs font-bold bg-teal-500 text-slate-900 hover:bg-teal-400"
                                @click="saveNoteModal"
                            >
                                ÂÑ≤Â≠ò
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- ÂÖ±Áî®Ë°åÁ®ã ModalÔºöÂåØÂá∫ / ÂåØÂÖ• JSON -->
            <transition name="fade">
                <div
                    v-if="showShareModal"
                    class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4"
                >
                    <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-xl p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-slate-50 flex items-center gap-2">
                                <i class="ph-bold ph-users-three text-teal-300"></i>
                                Ëàá‰ªñ‰∫∫ÂÖ±Áî®Ë°åÁ®ã
                            </h2>
                            <button
                                class="text-slate-400 hover:text-slate-100"
                                @click="showShareModal = false"
                            >
                                <i class="ph-bold ph-x text-lg"></i>
                            </button>
                        </div>

                        <div class="space-y-4 text-xs text-slate-200">
                            <!-- ÂåØÂá∫ -->
                            <div>
                                <p class="mb-1 text-slate-400">
                                    1. Êää‰∏ãÈù¢ÈÄôÊÆµÊñáÂ≠óË§áË£ΩÔºåË≤ºÁµ¶ÊúãÂèãÔºàLINE / Messenger ÈÉΩÂèØ‰ª•Ôºâ„ÄÇ
                                </p>
                                <textarea
                                    readonly
                                    class="w-full h-24 rounded-2xl bg-slate-800 border border-slate-700 px-3 py-2 font-mono text-[11px] text-emerald-300 break-all"
                                >{{ exportText }}</textarea>
                                <button
                                    class="mt-2 w-full px-3 py-1.5 rounded-xl bg-slate-800 text-xs font-bold text-slate-100 border border-slate-600 hover:bg-slate-700"
                                    @click="copyExportText"
                                >
                                    Ë§áË£ΩÂàÜ‰∫´ÊñáÂ≠ó
                                </button>
                            </div>

                            <!-- ÂåØÂÖ• -->
                            <div class="border-t border-slate-700 pt-3">
                                <p class="mb-1 text-slate-400">
                                    2. Êî∂Âà∞ÊúãÂèãÁöÑÂàÜ‰∫´ÂÖßÂÆπÊôÇÔºåË≤ºÂà∞‰∏ãÈù¢ÔºåÊåâ„ÄåÂåØÂÖ•Ë°åÁ®ã„ÄçÂç≥ÂèØ„ÄÇ
                                </p>
                                <textarea
                                    v-model="importText"
                                    class="w-full h-24 rounded-2xl bg-slate-800 border border-slate-700 px-3 py-2 font-mono text-[11px] text-slate-100"
                                    placeholder="ÊääÊúãÂèãÂÇ≥ÁöÑ JSON Ë≤ºÂú®ÈÄôË£°"
                                ></textarea>
                                <button
                                    class="mt-2 w-full px-3 py-1.5 rounded-xl bg-teal-500 text-xs font-bold text-slate-900 hover:bg-teal-400"
                                    @click="importFromText"
                                >
                                    ÂåØÂÖ•Ë°åÁ®ã
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Âú∞ÂúñË¶ñÂúñ -->
            <div v-if="viewMode === 'map'" class="h-full w-full">
                <div class="h-full flex flex-col">
                    <div class="p-4 pb-2">
                        <div class="flex items-center justify-between gap-2">
                            <div class="flex items-center gap-2">
                                <div class="w-9 h-9 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center">
                                    <i class="ph-bold ph-compass text-lg text-sky-300"></i>
                                </div>
                                <div>
                                    <div class="text-xs text-slate-400">ÁõÆÂâçÈ°ØÁ§∫</div>
                                    <div class="text-sm font-semibold text-slate-50 truncate max-w-[160px]">
                                        {{ currentDay.title || currentDay.date || '‰ªäÂ§©ÁöÑË°åÁ®ã' }}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    @click="initMap(true)"
                                    class="flex items-center gap-1 text-[11px] px-2.5 py-1 rounded-full border border-slate-600 bg-slate-800 text-slate-100 hover:bg-slate-700"
                                >
                                    <i class="ph-bold ph-target text-xs"></i>
                                    ÈáçÊñ∞ËºâÂÖ•
                                </button>
                                <button
                                    @click="centerOnUser"
                                    class="flex items-center gap-1 text-[11px] px-2.5 py-1 rounded-full border border-emerald-500/60 bg-emerald-950/50 text-emerald-300 hover:bg-emerald-900/70"
                                >
                                    <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                                    ÊàëÁöÑÂÆö‰Ωç
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 flex items-center gap-1 text-[10px] text-slate-400">
                            <span v-if="isMapLoading" class="flex items-center gap-1">
                                <i class="ph-bold ph-spinner-gap animate-spin"></i>
                                ËÆÄÂèñÂú∞ÂúñËàáÂ∫ßÊ®ô‰∏≠...
                            </span>
                            <span v-else-if="userLocation">
                                <i class="ph-bold ph-map-pin text-emerald-400"></i>
                                ‰ΩøÁî®ËÄÖÂÆö‰Ωç: {{ userLocation.lat.toFixed(4) }}, {{ userLocation.lng.toFixed(4) }}
                            </span>
                            <span v-else>
                                <i class="ph-bold ph-warning-circle text-amber-400"></i>
                                ÂèØËÉΩÁÑ°Ê≥ïÂèñÂæóÂÆö‰ΩçÔºåÂèØÁõ¥Êé•Âú®Âú∞Âúñ‰∏äÁ∏ÆÊîæÊü•ÁúãË°åÁ®ã
                            </span>
                        </div>
                    </div>

                    <div class="flex-1 px-4 pb-4">
                        <div id="map" class="w-full h-full rounded-3xl overflow-hidden border border-slate-800 bg-slate-900"></div>
                    </div>
                </div>
            </div>

            <!-- Ëä±Ë≤ªË¶ñÂúñ -->
            <div v-if="viewMode === 'expense'" class="p-4 space-y-4">
                <div class="bg-slate-800/90 border border-slate-700 rounded-2xl p-3 space-y-3">
                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <div class="text-xs text-slate-400 flex items-center gap-1">
                                <i class="ph-bold ph-users-three text-sm text-amber-300"></i>
                                ÊóÖ‰º¥Ê∏ÖÂñÆ
                            </div>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span
                                    v-for="(p, idx) in participants"
                                    :key="idx"
                                    class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900 border border-slate-600 text-[11px]"
                                >
                                    <input v-model="participants[idx]" class="bg-transparent border-none text-xs max-w-[70px] focus:outline-none focus:ring-0">
                                    <button v-if="participants.length>1" @click="removeParticipant(idx)" class="text-slate-500 hover:text-red-400">
                                        <i class="ph-bold ph-x text-[10px]"></i>
                                    </button>
                                </span>
                                <button
                                    @click="addParticipant"
                                    class="inline-flex items-center justify-center w-6 h-6 rounded-full border border-dashed border-slate-500 text-slate-300 hover:bg-slate-800 text-xs"
                                >
                                    <i class="ph-bold ph-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">È†ê‰º∞ÂåØÁéá</div>
                            <div class="flex items-center justify-end gap-1">
                                <input
                                    v-model.number="exchangeRate"
                                    type="number"
                                    step="0.001"
                                    class="w-20 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-xs text-right focus:outline-none focus:ring-2 focus:ring-amber-400/60"
                                >
                                <span class="text-[11px] text-slate-400">1 {{ currencyLabel }} ‚âà {{ exchangeRate }} TWD</span>
                            </div>
                            <button
                                @click="detectRate"
                                class="mt-1 text-[10px] text-amber-300 underline decoration-dotted underline-offset-2">
                                Ëá™ÂãïÊäìÂèñÂç≥ÊôÇÂåØÁéá
                            </button>
                            <div v-if="isRateLoading" class="text-[10px] text-slate-500 mt-0.5 flex items-center gap-1 justify-end">
                                <i class="ph-bold ph-spinner-gap animate-spin text-xs"></i> ËÆÄÂèñ‰∏≠‚Ä¶
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/90 border border-slate-700 rounded-2xl p-3 space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-wallet text-lg text-amber-300"></i>
                            <div>
                                <div class="text-xs text-slate-400">Á∏ΩËä±Ë≤ª ({{ currencyLabel }})</div>
                                <div class="text-lg font-bold text-amber-200 font-mono">{{ totalExpense.toLocaleString() }}</div>
                            </div>
                        </div>
                        <div class="text-right text-xs text-slate-400">
                            <div>Á¥Ñ {{ (totalExpense * exchangeRate).toLocaleString() }} TWD</div>
                        </div>
                    </div>

                    <div class="border-t border-slate-700 pt-3 space-y-3">
                        <div class="flex gap-2">
                            <input v-model="newExpense.item" placeholder="È†ÖÁõÆ (‰æãÂ¶ÇÔºöÂçàÈ§ê / ËªäÁ•®)" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-amber-400/60">
                            <input v-model.number="newExpense.amount" type="number" placeholder="ÈáëÈ°ç" class="w-20 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-xs text-right focus:outline-none focus:ring-2 focus:ring-amber-400/60">
                        </div>
                        <div class="flex gap-2 items-center">
                            <select v-model="newExpense.payer" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-amber-400/60">
                                <option v-for="p in participants" :key="p" :value="p">{{ p }} ÊîØ‰ªò</option>
                            </select>
                            <button
                                @click="addExpense"
                                class="px-3 py-1 rounded-lg bg-amber-500 text-slate-900 text-xs font-bold hover:bg-amber-400 flex items-center gap-1"
                            >
                                <i class="ph-bold ph-plus text-xs"></i>
                                Êñ∞Â¢û
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div v-for="(e, idx) in expenses" :key="idx" class="bg-slate-800/90 border border-slate-700 rounded-2xl px-3 py-2 flex items-center justify-between">
                        <div>
                            <div class="text-sm font-semibold text-slate-50">{{ e.item }}</div>
                            <div class="text-[11px] text-slate-400 flex items-center gap-1">
                                <i class="ph-bold ph-user text-[10px] text-amber-300"></i>
                                {{ e.payer }}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-mono text-amber-200">{{ e.amount.toLocaleString() }} {{ currencyLabel }}</div>
                            <div class="text-[11px] text-slate-500">‚âà {{ (e.amount * exchangeRate).toLocaleString() }} TWD</div>
                            <button @click="removeExpense(idx)" class="mt-1 text-[10px] text-slate-500 hover:text-red-400 flex items-center gap-0.5">
                                <i class="ph-bold ph-trash text-[11px]"></i>
                                Âà™Èô§
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÁµêÁÆóÂª∫Ë≠∞ -->
                <div v-if="settlementPlan.length" class="bg-slate-800/90 border border-slate-700 rounded-2xl p-3 space-y-2 mt-3">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="ph-bold ph-hand-coins text-lg text-emerald-300"></i>
                        <div>
                            <div class="text-xs text-slate-400">Á∞°ÊòìÁµêÁÆóÂª∫Ë≠∞</div>
                            <div class="text-[11px] text-slate-500">‰ª•Âπ≥ÂùáÂàÜÊî§ÁÇ∫ÁõÆÊ®ôÔºåÂàóÂá∫Ë™∞Ë¶ÅÁµ¶Ë™∞Â§öÂ∞ë</div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <div
                            v-for="(s, idx) in settlementPlan"
                            :key="idx"
                            class="text-xs text-slate-200 flex items-center justify-between gap-2 bg-slate-900/70 rounded-xl px-2.5 py-1.5"
                        >
                            <div class="flex items-center gap-1">
                                <span class="font-semibold text-rose-200">{{ s.from }}</span>
                                <span class="text-slate-400">‚ûú</span>
                                <span class="font-semibold text-emerald-200">{{ s.to }}</span>
                            </div>
                            <div class="text-right text-[11px]">
                                <div class="font-mono text-amber-200">{{ s.amount.toLocaleString() }} {{ currencyLabel }}</div>
                                <div class="text-slate-500">‚âà {{ (s.amount * exchangeRate).toLocaleString() }} TWD</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊâìÂåÖ / ÂæÖËæ¶Ê∏ÖÂñÆË¶ñÂúñ -->
            <div v-if="viewMode === 'checklist'" class="p-4 space-y-3">
                <div class="bg-slate-800/90 border border-slate-700 rounded-2xl p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-suitcase-rolling text-lg text-violet-300"></i>
                            <div>
                                <div class="text-xs text-slate-400">ÊâìÂåÖÈÄ≤Â∫¶</div>
                                <div class="text-sm text-slate-200">
                                    Â∑≤ÂÆåÊàê {{ checklistStats.done }} / {{ checklistStats.total }} È†Ö
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400 mb-1">Êï¥È´îÂÆåÊàêÂ∫¶</div>
                            <div class="w-24 h-2 bg-slate-900 rounded-full overflow-hidden border border-slate-600">
                                <div
                                    class="h-full bg-gradient-to-r from-violet-400 via-sky-400 to-emerald-400"
                                    :style="{ width: checklistStats.percent + '%' }"
                                ></div>
                            </div>
                            <div class="text-[10px] text-slate-500 mt-0.5">{{ checklistStats.percent.toFixed(0) }}%</div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div
                        v-for="section in checklistSections"
                        :key="section.id"
                        class="bg-slate-800/90 border border-slate-700 rounded-2xl p-3"
                    >
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i :class="['ph-bold', section.icon, 'text-lg']"></i>
                                <div class="text-sm font-semibold">{{ section.title }}</div>
                            </div>
                            <div class="text-[11px] text-slate-400 flex items-center gap-1">
                                <span>ÂÆåÊàê {{ sectionProgress(section.id).done }}/{{ sectionProgress(section.id).total }}</span>
                            </div>
                        </div>

                        <div class="space-y-1 max-h-40 overflow-y-auto pr-1">
                            <div
                                v-for="(item, idx) in section.items"
                                :key="idx"
                                class="flex items-center gap-2 text-xs"
                            >
                                <button
                                    @click="toggleChecklistItem(section.id, idx)"
                                    class="w-5 h-5 flex items-center justify-center rounded-full border transition"
                                    :class="item.done ? 'bg-emerald-500 border-emerald-400 text-slate-900' : 'bg-slate-900 border-slate-600 text-slate-400'"
                                >
                                    <i v-if="item.done" class="ph-bold ph-check"></i>
                                </button>
                                <input
                                    v-model="item.text"
                                    class="flex-1 bg-transparent border-b border-dashed border-slate-600 focus:border-violet-400 focus:outline-none py-0.5"
                                    :class="item.done ? 'text-slate-400 line-through' : 'text-slate-100'"
                                    placeholder="Ë¶ÅÂ∏∂‰ªÄÈ∫ºÔºü"
                                >
                                <button
                                    @click="removeChecklistItem(section.id, idx)"
                                    class="text-slate-500 hover:text-red-400"
                                >
                                    <i class="ph-bold ph-trash text-[11px]"></i>
                                </button>
                            </div>
                        </div>

                        <button
                            @click="addChecklistItem(section.id)"
                            class="mt-2 text-[11px] flex items-center gap-1 text-violet-300 hover:text-violet-100"
                        >
                            <i class="ph-bold ph-plus-circle text-xs"></i>
                            Êñ∞Â¢û‰∏ÄÈ†Ö
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Nav -->
        <nav class="mobile-bottom-nav z-30">
            <div class="mx-3 mb-2 rounded-2xl bg-slate-900/95 border border-slate-700/80 shadow-[0_10px_30px_rgba(15,23,42,0.9)] px-3 py-2 flex items-center justify-between text-[11px]">
                <button
                    @click="viewMode = 'plan'"
                    class="flex flex-col items-center gap-0.5 flex-1"
                    :class="viewMode === 'plan' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-list-check text-lg"></i>
                    <span>Ë°åÁ®ã</span>
                </button>
                <button
                    @click="viewMode = 'map'"
                    class="flex flex-col items-center gap-0.5 flex-1"
                    :class="viewMode === 'map' ? 'text-sky-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-map-trifold text-lg"></i>
                    <span>Âú∞Âúñ</span>
                </button>
                <button
                    @click="viewMode = 'expense'"
                    class="flex flex-col items-center gap-0.5 flex-1"
                    :class="viewMode === 'expense' ? 'text-amber-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-coins text-lg"></i>
                    <span>Ëä±Ë≤ª</span>
                </button>
                <button
                    @click="viewMode = 'checklist'"
                    class="flex flex-col items-center gap-0.5 flex-1"
                    :class="viewMode === 'checklist' ? 'text-violet-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-clipboard-text text-lg"></i>
                    <span>ÊâìÂåÖ</span>
                </button>
            </div>
        </nav>

        <!-- Trip ÈÅ∏ÂñÆ -->
        <transition name="fade">
            <div v-if="showTripMenu" class="fixed inset-0 z-40 bg-slate-950/80 flex justify-end">
                <div class="w-72 h-full bg-slate-900 border-l border-slate-800 shadow-2xl flex flex-col">
                    <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-suitcase-rolling text-xl text-emerald-300"></i>
                            <div>
                                <div class="text-sm font-semibold">ÊóÖÁ®ãÂàóË°®</div>
                                <div class="text-[11px] text-slate-400">ÁÆ°ÁêÜ‰∏çÂêåÂüéÂ∏Ç / ‰∏çÂêåÊóÖË°å</div>
                            </div>
                        </div>
                        <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-100">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto hide-scroll px-3 py-2 space-y-2">
                        <div
                            v-for="trip in tripList"
                            :key="trip.id"
                            class="rounded-xl border px-3 py-2 text-xs cursor-pointer transition"
                            :class="trip.id === currentTripId ? 'bg-slate-800 border-emerald-500/70' : 'bg-slate-900/80 border-slate-700 hover:border-slate-500'"
                            @click="switchTrip(trip.id)"
                        >
                            <div class="flex items-center justify-between">
                                <div class="font-semibold text-slate-50 truncate max-w-[120px]">
                                    {{ trip.title || 'Êú™ÂëΩÂêçË°åÁ®ã' }}
                                </div>
                                <button
                                    @click.stop="deleteTrip(trip.id)"
                                    class="text-slate-500 hover:text-red-400"
                                >
                                    <i class="ph-bold ph-trash text-[11px]"></i>
                                </button>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1">
                                <i class="ph-bold ph-calendar-blank text-[11px]"></i>
                                <span>{{ trip.dateRange || 'Â∞öÊú™Ë®≠ÂÆöÊó•Êúü' }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 py-3 border-t border-slate-800">
                        <button
                            @click="createNewTrip"
                            class="w-full py-2 rounded-xl bg-emerald-500 text-slate-900 text-sm font-bold flex items-center justify-center gap-1 hover:bg-emerald-400"
                        >
                            <i class="ph-bold ph-plus"></i>
                            Êñ∞Â¢û‰∏ÄÂÄãÊóÖÁ®ã
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- ÂàùÂßãË®≠ÂÆö Modal -->
        <transition name="fade">
            <div v-if="showSetupModal" class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4">
                <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-2xl p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <i class="ph-bold ph-map-pin-line text-xl text-emerald-300"></i>
                            <div>
                                <div class="text-sm font-semibold text-slate-50">ÊóÖÁ®ãË®≠ÂÆö</div>
                                <div class="text-[11px] text-slate-400">Ë®≠ÂÆöÁõÆÁöÑÂú∞„ÄÅÊó•ÊúüËàáÈ†êÁÆóÂÅèÂ•Ω</div>
                            </div>
                        </div>
                        <button @click="showSetupModal = false" class="text-slate-400 hover:text-slate-100">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    </div>

                    <div class="space-y-3 text-xs">
                        <div>
                            <label class="block mb-1 text-slate-300">ÁõÆÁöÑÂú∞</label>
                            <input
                                v-model="setup.destination"
                                type="text"
                                class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                                placeholder="‰æãÂ¶ÇÔºöÊù±‰∫¨„ÄÅÈáúÂ±±„ÄÅ‰∫¨ÈÉΩ„ÄÅÂ§ßÈò™..."
                            />
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block mb-1 text-slate-300">Âá∫ÁôºÊó•</label>
                                <input
                                    v-model="setup.startDate"
                                    type="date"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-xs text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                                />
                            </div>
                            <div>
                                <label class="block mb-1 text-slate-300">Â§©Êï∏</label>
                                <input
                                    v-model.number="setup.days"
                                    type="number"
                                    min="1"
                                    max="30"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-xs text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                                />
                            </div>
                        </div>
                        <div>
                            <label class="block mb-1 text-slate-300">È†êÁÆóÂπ£Âà•</label>
                            <select
                                v-model="setup.currency"
                                class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-xs text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/70"
                            >
                                <option value="KRW">ÈüìÂúì (KRW)</option>
                                <option value="JPY">Êó•Âúì (JPY)</option>
                                <option value="USD">ÁæéÂÖÉ (USD)</option>
                                <option value="EUR">Ê≠êÂÖÉ (EUR)</option>
                                <option value="TWD">Âè∞Âπ£ (TWD)</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-between gap-2 mt-5">
                        <button
                            @click="showSetupModal = false"
                            class="flex-1 px-4 py-2 rounded-xl text-xs font-bold border border-slate-600 text-slate-200 hover:bg-slate-800"
                        >
                            ÂèñÊ∂à
                        </button>
                        <button
                            @click="initTrip"
                            class="flex-1 px-4 py-2 rounded-xl text-xs font-bold bg-emerald-500 text-slate-900 hover:bg-emerald-400 flex items-center justify-center gap-1"
                        >
                            <i class="ph-bold ph-check-circle text-sm"></i>
                            ÂÑ≤Â≠òË®≠ÂÆö
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        
        const useFirebase = false; 
        const firebaseConfig = { /* apiKey: "...", ... */ };

        let appInstance, db;
        let mapInstance = null;
        let userMarker = null;

        if (useFirebase) {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(m => {
                appInstance = m.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(f => {
                    db = f.getFirestore(appInstance);
                });
            });
        }

        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isOnline = ref(false);
                const isFirebaseReady = ref(false);
                let geoWatchId = null;

                const showTripMenu = ref(false);
                const tripList = ref([]);
                const currentTripId = ref(null);
                const showSetupModal = ref(false);

                const days = ref([]);

// Ë°åÁ®ãÊãñÊãâ / Á∑®ËºØ / Á≠ÜË®ò / ÂÖ±Áî®Áõ∏Èóú state
                const draggingIndex = ref(null);

                const editModalVisible = ref(false);
                const editIndex = ref(null);
                const editForm = ref({
                    time: '',
                    location: '',
                    stayHours: 0,
                    stayMinutes: 0
                });

                const noteModalVisible = ref(false);
                const noteIndex = ref(null);
                const noteText = ref('');

                const showShareModal = ref(false);
                const importText = ref('');
                const expenses = ref([]);
                const participants = ref(['Êàë', 'ÊóÖ‰º¥A']);
                const participantsStr = ref('Êàë, ÊóÖ‰º¥A');
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'Êàë' });

                const conversionTarget = ref('TWD');
                const isRateLoading = ref(false);

                const checklistSections = ref([
                    {
                        id: 'doc',
                        title: 'Ë≠â‰ª∂ / ÂøÖÂÇô',
                        icon: 'ph-identification-card',
                        items: [
                            { text: 'Ë≠∑ÁÖß', done: false },
                            { text: 'Ë∫´ÂàÜË≠â / ÂÅ•‰øùÂç°', done: false },
                            { text: 'ÁèæÈáë / ‰ø°Áî®Âç°', done: false },
                            { text: 'ÊÇ†ÈÅäÂç° / ‰∫§ÈÄöÂç°', done: false }
                        ]
                    },
                    {
                        id: 'clothes',
                        title: 'Ë°£Áâ© / Á©øÊê≠',
                        icon: 'ph-t-shirt',
                        items: [
                            { text: 'Â§ñÂ•ó / Èò≤È¢®Ë°£', done: false },
                            { text: '‰∏äË°£ / Ë§≤Â≠ê', done: false },
                            { text: 'Áù°Ë°£', done: false },
                            { text: 'Ë•™Â≠ê / ÂÖßË°£Ë§≤', done: false }
                        ]
                    },
                    {
                        id: 'life',
                        title: 'ÁîüÊ¥ªÁî®ÂìÅ',
                        icon: 'ph-toothbrush',
                        items: [
                            { text: 'ÁâôÂà∑ÁâôËÜè', done: false },
                            { text: 'Ê¥óÈù¢‰π≥ / ‰øùÈ§äÂìÅ', done: false },
                            { text: 'Èö±ÂΩ¢ÁúºÈè° / Ëó•Ê∞¥', done: false },
                            { text: 'Èõ®ÂÇò / Èõ®Ë°£', done: false }
                        ]
                    },
                    {
                        id: 'digital',
                        title: '3C / ÈõªÂ≠ê',
                        icon: 'ph-device-mobile-camera',
                        items: [
                            { text: 'ÊâãÊ©ü / ÂÖÖÈõªÂô®', done: false },
                            { text: 'Ë°åÂãïÈõªÊ∫ê', done: false },
                            { text: 'ËΩâÊé•È†≠ / ËΩâÊèõÊèíÈ†≠', done: false },
                            { text: 'Áõ∏Ê©ü / Ë®òÊÜ∂Âç°', done: false }
                        ]
                    },
                    {
                        id: 'shopping',
                        title: 'Ë≥ºÁâ©Ê∏ÖÂñÆ',
                        icon: 'ph-bag',
                        items: [
                            { text: 'Ëó•Â¶ù / ‰øùÈ§äÂìÅ', done: false },
                            { text: '‰º¥ÊâãÁ¶Æ / Á¶ÆÁâ©', done: false },
                            { text: 'Áï∂Âú∞ÈôêÂÆöÂïÜÂìÅ', done: false }
                        ]
                    }
                ]);

                const recommendationsMap = reactive({});
                const isSearchingRecs = ref(false);
                const searchTargetIndex = ref('');

                const currentDay = computed(() => days.value[currentDayIdx.value] || {items:[], flight:null, date:'', title:''});

                const setup = ref({
                    destination: '',
                    startDate: '',
                    days: 3,
                    currency: 'KRW'
                });

                const weather = ref({
                    temp: null,
                    icon: 'ph-sun',
                    location: '',
                    daily: null
                });

                const userLocation = ref(null);
                const isMapLoading = ref(false);

                const tripDateRange = computed(() => {
                    if (!setup.value.startDate || !setup.value.days) return '';
                    const start = new Date(setup.value.startDate);
                    const end = new Date(start);
                    end.setDate(start.getDate() + setup.value.days - 1);
                    const fmt = d => `${d.getMonth()+1}/${d.getDate()}`;
                    return `${fmt(start)} - ${fmt(end)} ¬∑ ÂÖ± ${setup.value.days} Â§©`;
                });

                const currencyLabel = computed(() => setup.value.currency || 'KRW');
                const currencySymbol = computed(() => {
                    switch(setup.value.currency) {
                        case 'JPY': return '¬•';
                        case 'USD': return '$';
                        case 'EUR': return '‚Ç¨';
                        case 'TWD': return 'NT$';
                        default: return '‚Ç©';
                    }
                });

                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (item.amount || 0), 0));

                const paidByPerson = computed(() => {
                    const map = {};
                    participants.value.forEach(p => map[p] = 0);
                    expenses.value.forEach(e => {
                        if (map[e.payer] === undefined) map[e.payer] = 0;
                        map[e.payer] += (e.amount || 0);
                    });
                    return map;
                });

                const settlementPlan = computed(() => {
                    if (totalExpense.value === 0 || participants.value.length === 0) return [];
                    const average = totalExpense.value / participants.value.length;
                    const diff = participants.value.map(p => ({
                        name: p,
                        diff: (paidByPerson.value[p] || 0) - average
                    }));
                    const payer = diff.filter(d => d.diff > 0).sort((a,b) => b.diff - a.diff);
                    const receiver = diff.filter(d => d.diff < 0).sort((a,b) => a.diff - b.diff);
                    const result = [];
                    let i = 0, j = 0;
                    while(i < receiver.length && j < payer.length) {
                        const give = Math.min(payer[j].diff, -receiver[i].diff);
                        if (give > 1) {
                            result.push({
                                from: receiver[i].name,
                                to: payer[j].name,
                                amount: Math.round(give)
                            });
                        }
                        payer[j].diff -= give;
                        receiver[i].diff += give;
                        if (payer[j].diff <= 1) j++;
                        if (receiver[i].diff >= -1) i++;
                    }
                    return result;
                });

                const checklistStats = computed(() => {
                    let total = 0, done = 0;
                    checklistSections.value.forEach(sec => {
                        sec.items.forEach(i => {
                            total++;
                            if (i.done) done++;
                        });
                    });
                    return {
                        total,
                        done,
                        percent: total === 0 ? 0 : (done / total * 100)
                    };
                });

                const sectionProgress = (id) => {
                    const sec = checklistSections.value.find(s => s.id === id);
                    if (!sec) return { total: 0, done: 0 };
                    let total = sec.items.length;
                    let done = sec.items.filter(i => i.done).length;
                    return { total, done };
                };

                const weatherDisplay = computed(() => {
                    if (!setup.value.destination) return null;
                    if (weather.value.daily && currentDay.value.fullDate) {
                        if (!weather.value.daily.time) {
                            return {
                                temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                                icon: weather.value.icon || 'ph-sun',
                                label: `${setup.value.destination} (ÁõÆÂâç)`,
                                isForecast: false
                            };
                        }
                        const targetDate = currentDay.value.fullDate;
                        const idx = weather.value.daily.time.indexOf(targetDate);
                        if (idx !== -1) {
                            const max = Math.round(weather.value.daily.temperature_2m_max[idx]);
                            const min = Math.round(weather.value.daily.temperature_2m_min[idx]);
                            return {
                                temp: `${min}¬∞ - ${max}¬∞`,
                                icon: getWeatherIcon(weather.value.daily.weathercode[idx]),
                                label: `${setup.value.destination} (È†êÂ†±)`,
                                isForecast: true
                            };
                        }
                    }
                    return {
                        temp: weather.value.temp !== null ? `${weather.value.temp}¬∞` : '--',
                        icon: weather.value.icon || 'ph-sun',
                        label: `${setup.value.destination} (ÁõÆÂâç)`,
                        isForecast: false
                    };
                });

                
                const estimatedLeaveTime = computed(() => {
                    const t = editForm.value.time;
                    if (!t) return '';
                    const [h, m] = t.split(':').map(x => parseInt(x || '0', 10));
                    const addMinutes =
                        (editForm.value.stayHours || 0) * 60 +
                        (editForm.value.stayMinutes || 0);
                    let total = h * 60 + m + addMinutes;
                    total = ((total % (24 * 60)) + 24 * 60) % (24 * 60);
                    const hh = String(Math.floor(total / 60)).padStart(2, '0');
                    const mm = String(total % 60).padStart(2, '0');
                    return `${hh}:${mm}`;
                });

                const exportText = computed(() =>
                    JSON.stringify(
                        {
                            destination: setup.value.destination,
                            startDate: setup.value.startDate,
                            days: days.value
                        },
                        null,
                        2
                    )
                );

                const daysToTrip = computed(() => {
                    if (!setup.value.startDate) return null;
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const start = new Date(setup.value.startDate);
                    start.setHours(0,0,0,0);
                    const diffMs = start - today;
                    const diffDays = Math.round(diffMs / 86400000);
                    return diffDays;
                });

                const getWeatherIcon = (code) => {
                    if (code === undefined || code === null) return 'ph-sun';
                    if (code === 0) return 'ph-sun';
                    if ([1,2,3].includes(code)) return 'ph-cloud-sun';
                    if ([45,48].includes(code)) return 'ph-cloud-fog';
                    if ([51,53,55,56,57].includes(code)) return 'ph-cloud-rain';
                    if ([61,63,65,66,67,80,81,82].includes(code)) return 'ph-cloud-rain-heavy';
                    if ([71,73,75,77,85,86].includes(code)) return 'ph-cloud-snow';
                    if ([95,96,99].includes(code)) return 'ph-cloud-lightning';
                    return 'ph-cloud';
                };

                const updateDate = (val) => {
                    if (!val) return;
                    currentDay.value.fullDate = val;
                    const d = new Date(val);
                    const dayName = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][d.getDay()];
                    currentDay.value.date = `${d.getMonth()+1}/${d.getDate()} ( ${dayName} )`;
                };

                const addParticipant = () => {
                    participants.value.push(`ÊóÖ‰º¥${participants.value.length}`);
                };
                const removeParticipant = (idx) => {
                    if (participants.value.length <= 1) return;
                    const name = participants.value[idx];
                    participants.value.splice(idx, 1);
                    expenses.value.forEach(e => {
                        if (e.payer === name) e.payer = participants.value[0] || 'Êàë';
                    });
                };
                const renameParticipant = () => {
                    participants.value = participantsStr.value.split(',').map(s => s.trim()).filter(Boolean);
                };

                const addDay = () => {
                    const idx = days.value.length + 1;
                    days.value.push({ date: `Day ${idx}`, shortDate: `D${idx}`, title: '', items: [], flight: null });
                };
                const removeCurrentDay = () => {
                    if(days.value.length>1 && confirm('Âà™Èô§?')) {
                        days.value.splice(currentDayIdx.value, 1);
                        if (currentDayIdx.value >= days.value.length) currentDayIdx.value = days.value.length - 1;
                    }
                };
                // Ë°åÁ®ãÊãñÊãâÊéíÂ∫è
                const onDragStart = (idx) => {
                    draggingIndex.value = idx;
                };

                const onDrop = (idx) => {
                    if (draggingIndex.value === null || draggingIndex.value === idx) return;
                    const list = currentDay.value.items;
                    const moved = list.splice(draggingIndex.value, 1)[0];
                    list.splice(idx, 0, moved);
                    draggingIndex.value = null;
                };

                // Á∑®ËºØË°åÁ®ã Modal
                const openEditModal = (idx) => {
                    const it = currentDay.value.items[idx];
                    editIndex.value = idx;
                    editForm.value = {
                        time: it.time || '',
                        location: it.location || '',
                        stayHours: Math.floor((it.stayMinutes || 0) / 60),
                        stayMinutes: (it.stayMinutes || 0) % 60
                    };
                    editModalVisible.value = true;
                };

                const closeEditModal = () => {
                    editModalVisible.value = false;
                };

                const saveEditModal = () => {
                    const idx = editIndex.value;
                    if (idx == null) return;
                    const it = currentDay.value.items[idx];
                    it.time = editForm.value.time;
                    it.location = editForm.value.location;
                    it.stayMinutes =
                        (editForm.value.stayHours || 0) * 60 +
                        (editForm.value.stayMinutes || 0);
                    editModalVisible.value = false;
                };

                // ÊôØÈªûÁ≠ÜË®ò Modal
                const openNoteModal = (idx) => {
                    const it = currentDay.value.items[idx];
                    noteIndex.value = idx;
                    noteText.value = it.note || '';
                    noteModalVisible.value = true;
                };

                const closeNoteModal = () => {
                    noteModalVisible.value = false;
                };

                const saveNoteModal = () => {
                    const idx = noteIndex.value;
                    if (idx == null) return;
                    currentDay.value.items[idx].note = noteText.value;
                    noteModalVisible.value = false;
                };

                // ÂÅúÁïôÊôÇÈñìÈ°ØÁ§∫
                const formatStay = (mins) => {
                    mins = mins || 0;
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    if (h === 0 && m === 0) return '0 ÂàÜÈêò';
                    if (h === 0) return `${m} ÂàÜÈêò`;
                    if (m === 0) return `${h} Â∞èÊôÇ`;
                    return `${h} Â∞èÊôÇ ${m} ÂàÜ`;
                };

                // ÂÖ±Áî®Ë°åÁ®ãÔºöË§áË£Ω / ÂåØÂÖ• JSON
                const copyExportText = async () => {
                    try {
                        await navigator.clipboard.writeText(exportText.value);
                        alert('Â∑≤Ë§áË£ΩÔºåÂèØ‰ª•Ë≤ºÁµ¶ÊúãÂèãÂõâÔºÅ');
                    } catch (e) {
                        alert('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ëá™ÂãïË§áË£ΩÔºåË´ãÊâãÂãïÈÅ∏ÂèñÊñáÂ≠óË§áË£Ω„ÄÇ');
                    }
                };

                const importFromText = () => {
                    if (!importText.value.trim()) {
                        alert('Ë´ãÂÖàË≤º‰∏äÂàÜ‰∫´ÂÖßÂÆπ„ÄÇ');
                        return;
                    }
                    try {
                        const obj = JSON.parse(importText.value);
                        if (!obj || !Array.isArray(obj.days)) {
                            throw new Error('Ê†ºÂºèÈåØË™§');
                        }
                        if (obj.destination) {
                            setup.value.destination = obj.destination;
                        }
                        if (obj.startDate) {
                            setup.value.startDate = obj.startDate;
                        }
                        days.value = obj.days;
                        currentDayIdx.value = 0;
                        importText.value = '';
                        alert('ÂåØÂÖ•ÊàêÂäüÔºåÂèØ‰ª•‰∏ÄËµ∑Á∑®ËºØ‰∫ÜÔºÅ');
                    } catch (e) {
                        alert('ÂåØÂÖ•Â§±ÊïóÔºöÊ†ºÂºè‰∏çÊòØÈ†êÊúüÁöÑ JSON„ÄÇ');
                    }
                };


                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const addExpense = () => {
                    if (!newExpense.value.item || !newExpense.value.amount) return;
                    expenses.value.unshift({...newExpense.value});
                    newExpense.value.item='';
                    newExpense.value.amount='';
                };
                const removeExpense = (idx) => expenses.value.splice(idx, 1);

                const addChecklistItem = (sectionId) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items.push({ text: '', done: false });
                };
                const removeChecklistItem = (sectionId, idx) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items.splice(idx, 1);
                };
                const toggleChecklistItem = (sectionId, idx) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items[idx].done = !sec.items[idx].done;
                };

                const convertAmount = (amt) => {
                    if (!exchangeRate.value) return 0;
                    return Math.round(amt * exchangeRate.value);
                };
                const convertToTwd = (amt) => convertAmount(amt);

                const detectRate = async () => {
                    if (!setup.value.currency || setup.value.currency === 'TWD') {
                        exchangeRate.value = 1;
                        return;
                    }
                    isRateLoading.value = true;
                    try {
                        const res = await fetch(`https://api.exchangerate.host/latest?base=${setup.value.currency}&symbols=TWD`);
                        const data = await res.json();
                        if (data && data.rates && data.rates.TWD) {
                            exchangeRate.value = parseFloat(data.rates.TWD.toFixed(3));
                        }
                    } catch(e) {
                        console.error(e);
                    } finally {
                        isRateLoading.value = false;
                    }
                };

                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if(geoData?.[0]) {
                            const {lat, lon} = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                            const wData = await wRes.json();
                            weather.value.temp = wData?.current?.temperature_2m ?? null;
                            weather.value.icon = getWeatherIcon(wData?.current?.weathercode);
                            weather.value.daily = wData?.daily || null;
                        }
                    } catch(e) {
                        console.error('Fetch weather error', e);
                    }
                };

                const initTrip = () => {
                    const d = [];
                    const baseDate = setup.value.startDate ? new Date(setup.value.startDate) : null;
                    const dayCount = setup.value.days || 3;
                    for(let i=0;i<dayCount;i++){
                        const dateObj = baseDate ? new Date(baseDate) : null;
                        if(dateObj) dateObj.setDate(baseDate.getDate() + i);
                        let fullDate = '';
                        let dateStr = `Day ${i+1}`;
                        if(dateObj) {
                            const dayName = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][dateObj.getDay()];
                            fullDate = dateObj.toISOString().slice(0,10);
                            dateStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ( ${dayName} )`;
                        }
                        d.push({
                            date: dateStr,
                            shortDate: `D${i+1}`,
                            fullDate,
                            title: '',
                            items: [],
                            flight: null
                        });
                    }
                    days.value = d;
                    currentDayIdx.value = 0;

                    const tripMeta = {
                        id: currentTripId.value || Date.now().toString(),
                        title: setup.value.destination || 'Êú™ÂëΩÂêçË°åÁ®ã',
                        dateRange: tripDateRange.value
                    };
                    const existingIdx = tripList.value.findIndex(t => t.id === tripMeta.id);
                    if (existingIdx === -1) {
                        tripList.value.push(tripMeta);
                    } else {
                        tripList.value[existingIdx] = tripMeta;
                    }
                    currentTripId.value = tripMeta.id;

                    if (setup.value.destination) {
                        fetchWeather(setup.value.destination);
                    }
                    showSetupModal.value = false;
                };

                const toggleFlightCard = () => {
                    if (!currentDay.value.flight) {
                        currentDay.value.flight = {
                            departTime: '',
                            arriveTime: '',
                            departAirport: '',
                            arriveAirport: '',
                            airline: '',
                            number: '',
                            seat: ''
                        };
                    } else {
                        currentDay.value.flight = null;
                    }
                };

                const getDotColor = (type) => {
                    switch(type) {
                        case 'food': return 'bg-amber-400';
                        case 'shop': return 'bg-pink-400';
                        case 'transport': return 'bg-sky-400';
                        case 'flight': return 'bg-rose-400';
                        default: return 'bg-emerald-400';
                    }
                };

                const getTimePeriod = (t) => {
                    if(!t) return 'ÊôÇÈñì';
                    const h = parseInt(t.split(':')[0]);
                    return h<5?'ÂáåÊô®':h<11?'‰∏äÂçà':h<14?'‰∏≠Âçà':h<18?'‰∏ãÂçà':'Êôö‰∏ä';
                };

                const addItem = () => {
                    currentDay.value.items.push({
                        time: '',
                        type: 'spot',
                        activity: '',
                        location: '',
                        note: '',
                        transport: '',
                        duration: '',
                        stayMinutes: 0
                    });
                };

                const removeItem = (idx) => {
                    if (!confirm('Ë¶ÅÂà™Èô§ÈÄôÂÄãË°åÁ®ãÂóéÔºü')) return;
                    currentDay.value.items.splice(idx, 1);
                };
                
const addDay = () => {
                    const idx = days.value.length + 1;
                    days.value.push({ date: `Day ${idx}`, shortDate: `D${idx}`, title: '', items: [], flight: null });
                };

                const initMap = async (force=false) => {
                    if (viewMode.value !== 'map') return;
                    if (mapInstance && !force) return;
                    isMapLoading.value = true;
                    await nextTick();
                    const mapEl = document.getElementById('map');
                    if (!mapEl) {
                        isMapLoading.value = false;
                        return;
                    }

                    if (!mapInstance) {
                        mapInstance = L.map('map', {
                            zoomControl: false,
                            attributionControl: false
                        }).setView([25.0418, 121.5650], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19
                        }).addTo(mapInstance);
                    }

                    mapInstance.eachLayer(layer => {
                        if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                            mapInstance.removeLayer(layer);
                        }
                    });

                    const items = currentDay.value.items || [];
                    const bounds = [];
                    for (let item of items) {
                        if (!item.location) continue;
                        try {
                            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                            const data = await res.json();
                            if (data?.[0]) {
                                const {lat, lon} = data[0];
                                const marker = L.marker([lat, lon]).addTo(mapInstance);
                                bounds.push([lat, lon]);
                                const label = document.createElement('div');
                                label.className = 'marker-label ' + (item.type === 'food' ? 'marker-label-food' :
                                    item.type === 'transport' ? 'marker-label-transport' :
                                    item.type === 'flight' ? 'marker-label-flight' :
                                    'marker-label-spot');
                                label.innerText = (item.time ? item.time + ' ' : '') + (item.activity || item.location);
                                marker.bindPopup(label);
                            }
                        } catch(e) {
                            console.error('Map geocode error', e);
                        }
                    }

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(pos => {
                            const {latitude, longitude} = pos.coords;
                            userLocation.value = {lat: latitude, lng: longitude};
                            if (!userMarker) {
                                const iconDiv = L.divIcon({
                                    html: '<div class="pulse-dot"></div>',
                                    className: '',
                                    iconSize: [14,14]
                                });
                                userMarker = L.marker([latitude, longitude], {icon: iconDiv}).addTo(mapInstance);
                            } else {
                                userMarker.setLatLng([latitude, longitude]);
                            }
                            bounds.push([latitude, longitude]);
                            if (bounds.length) {
                                mapInstance.fitBounds(bounds, {padding: [40,40]});
                            } else {
                                mapInstance.setView([latitude, longitude], 14);
                            }
                            isMapLoading.value = false;
                        }, () => {
                            if (bounds.length) {
                                mapInstance.fitBounds(bounds, {padding: [40,40]});
                            } else {
                                mapInstance.setView([25.0418, 121.5650], 13);
                            }
                            isMapLoading.value = false;
                        });
                    } else {
                        if (bounds.length) {
                            mapInstance.fitBounds(bounds, {padding: [40,40]});
                        } else {
                            mapInstance.setView([25.0418, 121.5650], 13);
                        }
                        isMapLoading.value = false;
                    }
                };

                const centerOnUser = () => {
                    if (!mapInstance || !userLocation.value) return;
                    mapInstance.setView([userLocation.value.lat, userLocation.value.lng], 15);
                };

                const initSampleData = () => {
                    if (days.value.length === 0) {
                        setup.value.destination = 'ÈáúÂ±± ÊùæÂ≥∂';
                        setup.value.startDate = new Date().toISOString().slice(0,10);
                        setup.value.days = 1;
                        const today = new Date(setup.value.startDate);
                        const dayName = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'][today.getDay()];
                        days.value = [
                            {
                                date: `${today.getMonth()+1}/${today.getDate()} ( ${dayName} )`,
                                shortDate: 'D1',
                                fullDate: setup.value.startDate,
                                title: 'ÊùæÂ≥∂Êµ∑‰∏äÁ∫úËªä & Êµ∑ÊôØÊï£Ê≠•',
                                items: [
                                    {
                                        time: '11:39',
                                        type: 'transport',
                                        activity: 'ÊäµÈÅîÊùæÂ≥∂ÁÅ£Á∏ΩËªäÁ´ô',
                                        location: 'ÊùæÂ≥∂ÁÅ£Á∏ΩËªäÁ´ô ÏÜ°ÎèÑ Î≤†Ïù¥ Ïä§ÌÖåÏù¥ÏÖò (Ìï¥ÏÉÅÏºÄÏù¥Î∏îÏπ¥)',
                                        note: 'ÂèØÂÖàË≤∑Â•Ω‰æÜÂõûÁ•®ÔºåËã•ÊúâÂ•óÁ•®ÂèØÂÖåÊèõ',
                                        transport: '',
                                        duration: '',
                                        stayMinutes: 30
                                    },
                                    {
                                        time: '12:09',
                                        type: 'spot',
                                        activity: 'Êê≠‰πòÁ∫úËªäÂâçÂæÄ Sky Park',
                                        location: 'ÊùæÂ≥∂Êµ∑‰∏äÁ∫úËªä ÊùæÂ≥∂Sky Park',
                                        note: 'Âª∫Ë≠∞ÂÆâÊéíÁéªÁíÉÂ∫ïËªäÂªÇÔºåÊãçÁÖßË¶ñÈáé‰Ω≥',
                                        transport: '',
                                        duration: '',
                                        stayMinutes: 90
                                    }
                                ],
                                flight: null
                            }
                        ];
                    }
                };

                const saveTripsToStorage = () => {
                    const data = {
                        setup: setup.value,
                        days: days.value,
                        expenses: expenses.value,
                        participants: participants.value,
                        exchangeRate: exchangeRate.value,
                        tripList: tripList.value,
                        currentTripId: currentTripId.value
                    };
                    localStorage.setItem('travel_planner_v2', JSON.stringify(data));
                };

                const loadTripsFromStorage = () => {
                    try {
                        const raw = localStorage.getItem('travel_planner_v2');
                        if (!raw) {
                            initSampleData();
                            return;
                        }
                        const obj = JSON.parse(raw);
                        if (obj.setup) setup.value = obj.setup;
                        if (Array.isArray(obj.days) && obj.days.length > 0) days.value = obj.days;
                        if (Array.isArray(obj.expenses)) expenses.value = obj.expenses;
                        if (Array.isArray(obj.participants) && obj.participants.length > 0) participants.value = obj.participants;
                        if (obj.exchangeRate) exchangeRate.value = obj.exchangeRate;
                        if (Array.isArray(obj.tripList)) tripList.value = obj.tripList;
                        if (obj.currentTripId) currentTripId.value = obj.currentTripId;
                    } catch(e) {
                        console.error('Load trips failed', e);
                        initSampleData();
                    }
                };

                const createNewTrip = () => {
                    setup.value = {
                        destination: '',
                        startDate: '',
                        days: 3,
                        currency: setup.value.currency || 'KRW'
                    };
                    days.value = [];
                    showSetupModal.value = true;
                };

                const switchTrip = (id) => {
                    currentTripId.value = id;
                    saveTripsToStorage();
                };

                const deleteTrip = (id) => {
                    if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊóÖÁ®ãÂóéÔºü')) return;
                    const idx = tripList.value.findIndex(t => t.id === id);
                    if (idx !== -1) {
                        tripList.value.splice(idx, 1);
                        if (currentTripId.value === id) {
                            currentTripId.value = tripList.value[0]?.id || null;
                        }
                    }
                    saveTripsToStorage();
                };

                const estimateDuration = (item) => {
                    if (!item || !item.time || !item.duration) return '';
                    const [h,m] = item.time.split(':').map(Number);
                    const [dh,dm] = item.duration.split(':').map(Number);
                    let total = h*60 + m + dh*60 + dm;
                    const hh = String(Math.floor(total/60)).padStart(2,'0');
                    const mm = String(total%60).padStart(2,'0');
                    return `${hh}:${mm}`;
                };

                const searchNearby = async (idx) => {
                    const item = currentDay.value.items[idx];
                    if (!item || !item.location) return;
                    isSearchingRecs.value = true;
                    searchTargetIndex.value = `${currentDayIdx.value}-${idx}`;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=5`);
                        const data = await res.json();
                        recommendationsMap[searchTargetIndex.value] = (data || []).map((r,i) => ({
                            name: r.display_name,
                            lat: r.lat,
                            lon: r.lon,
                            type: r.type,
                            idx: i
                        }));
                    } catch(e) {
                        console.error(e);
                    } finally {
                        isSearchingRecs.value = false;
                    }
                };

                const applyRecommendation = (idx, recIdx) => {
                    const key = `${idx}-${recIdx}`; 
                };

                const initNetworkStatus = () => {
                    isOnline.value = navigator.onLine;
                    window.addEventListener('online', () => isOnline.value = true);
                    window.addEventListener('offline', () => isOnline.value = false);
                };

                const initGeoWatch = () => {
                    if (!navigator.geolocation) return;
                    geoWatchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            userLocation.value = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude
                            };
                        },
                        (err) => {
                            console.warn('Geo watch error', err);
                        },
                        { enableHighAccuracy: true, maximumAge: 5000, timeout: 8000 }
                    );
                };

                onMounted(() => {
                    initNetworkStatus();
                    loadTripsFromStorage();
                    initSampleData();
                });

                watch([setup, days, expenses, participants, exchangeRate, tripList, currentTripId], () => {
                    saveTripsToStorage();
                }, {deep: true});

                watch(viewMode, (val) => {
                    if (val === 'map') {
                        initMap();
                    }
                });

                return {
                    viewMode, currentDayIdx, days, currentDay,
                    participants, participantsStr,
                    addParticipant, removeParticipant, renameParticipant,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    paidByPerson, settlementPlan, exchangeRate,
                    isOnline, getTimePeriod, weather,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    updateDate, showSetupModal, setup, initTrip, weatherDisplay, detectRate, isRateLoading,
                    currencyLabel, currencySymbol, toggleFlightCard, getDotColor,
                    showTripMenu, tripList, createNewTrip, switchTrip, deleteTrip, currentTripId,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    convertAmount, convertToTwd,
                    daysToTrip, tripDateRange,
                    checklistSections, checklistStats, sectionProgress,
                    addChecklistItem, removeChecklistItem, toggleChecklistItem,
                    estimateDuration,

                    // Êñ∞Â¢ûÔºöË°åÁ®ãÊãñÊãâ / Á∑®ËºØ / Á≠ÜË®ò / ÂÖ±Áî®
                    draggingIndex,
                    editModalVisible, editForm, estimatedLeaveTime,
                    openEditModal, closeEditModal, saveEditModal,
                    noteModalVisible, noteText, openNoteModal, closeNoteModal, saveNoteModal,
                    showShareModal, exportText, importText, copyExportText, importFromText,
                    formatStay,
                    onDragStart, onDrop
                };
            }
        }).mount('#app')
    </script>
</body>
</html>
