<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„æ—…éŠè¨ˆç•« | Travel Plan</title>

    <!-- Vue 3 (ESM for better DX) -->
    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick, reactive } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js';

        const useFirebase = false;

        // Firebase è¨­å®šï¼ˆå¦‚æœªä½¿ç”¨å¯ç•¥éï¼‰
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
        };

        let appInstance, db;
        let mapInstance = null;
        let userMarker = null;

        if (useFirebase) {
            import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js").then(m => {
                appInstance = m.initializeApp(firebaseConfig);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(f => {
                    db = f.getFirestore(appInstance);
                });
            });
        }

        
        createApp({
            setup() {
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const isOnline = ref(false);
                const isFirebaseReady = ref(false);
                let geoWatchId = null;

                const showTripMenu = ref(false);
                const tripList = ref([]);
                const currentTripId = ref(null);

                const days = ref([]);
                const currentDay = computed(() => days.value[currentDayIdx.value] || { items: [], flight: null, date: '', title: '' });

                const expenses = ref([]);
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
                const participantsStr = ref('æˆ‘');
                const participants = ref([]);
                const exchangeRate = ref(1);
                const isRateLoading = ref(false);

                const checklistSections = ref([
                    {
                        id: 'pretrip',
                        title: 'å‡ºç™¼å‰æº–å‚™',
                        icon: 'ph-airplane-tilt',
                        color: 'from-sky-500/80 via-sky-400/80 to-emerald-400/80',
                        items: [
                            { id: 'passport', text: 'è­·ç…§ / èº«åˆ†è­‰', done: false },
                            { id: 'tickets', text: 'æ©Ÿç¥¨ / è»Šç¥¨ / è¨‚æˆ¿ç¢ºèªä¿¡', done: false },
                            { id: 'cash', text: 'ç¾é‡‘ / ä¿¡ç”¨å¡ / ææ¬¾å¡', done: false },
                            { id: 'sim', text: 'ç¶²è·¯ SIM / eSIM / Wi-Fi æ©Ÿ', done: false },
                        ],
                    },
                    {
                        id: 'pack',
                        title: 'è¡Œææ‰“åŒ…',
                        icon: 'ph-suitcase-rolling',
                        color: 'from-amber-400/80 via-orange-400/80 to-rose-400/80',
                        items: [
                            { id: 'clothes', text: 'è¡£ç‰© / å¤–å¥— / ç¡è¡£', done: false },
                            { id: 'toiletries', text: 'ç›¥æ´—ç”¨å…· / åŒ–å¦å“ / ä¿é¤Šå“', done: false },
                            { id: 'meds', text: 'å¸¸å‚™è—¥å“ / æ„Ÿå†’è—¥ / è…¸èƒƒè—¥', done: false },
                            { id: 'chargers', text: 'å……é›»å™¨ / è½‰æ¥é ­ / è¡Œå‹•é›»æº', done: false },
                        ],
                    },
                    {
                        id: 'others',
                        title: 'å…¶ä»–äº‹é …',
                        icon: 'ph-note-pencil',
                        color: 'from-emerald-400/80 via-teal-400/80 to-cyan-400/80',
                        items: [
                            { id: 'apps', text: 'å®‰è£ç•¶åœ°å¿…å‚™ Appï¼ˆåœ°åœ–ã€å«è»Šã€æ”¯ä»˜ï¼‰', done: false },
                            { id: 'backup', text: 'å‚™ä»½é‡è¦æ–‡ä»¶ï¼ˆè­·ç…§ã€è­‰ä»¶ã€ä¿éšªï¼‰', done: false },
                        ],
                    },
                ]);

                const checklistStats = computed(() => {
                    const allItems = checklistSections.value.flatMap(s => s.items);
                    const total = allItems.length;
                    const done = allItems.filter(i => i.done).length;
                    const percent = total ? Math.round((done / total) * 100) : 0;
                    return { total, done, percent };
                });

                const sectionProgress = (section) => {
                    const total = section.items.length;
                    const done = section.items.filter(i => i.done).length;
                    return total ? Math.round((done / total) * 100) : 0;
                };

                const addChecklistItem = (sectionId) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    const baseId = `${sectionId}-item`;
                    let idx = sec.items.length + 1;
                    let newId = `${baseId}-${idx}`;
                    const existingIds = new Set(sec.items.map(i => i.id));
                    while (existingIds.has(newId)) {
                        idx++;
                        newId = `${baseId}-${idx}`;
                    }
                    sec.items.push({ id: newId, text: 'æ–°çš„äº‹é …', done: false });
                };

                const removeChecklistItem = (sectionId, itemId) => {
                    const sec = checklistSections.value.find(s => s.id === sectionId);
                    if (!sec) return;
                    sec.items = sec.items.filter(i => i.id !== itemId);
                };

                const toggleChecklistItem = (item) => {
                    item.done = !item.done;
                };

                const totalExpense = computed(() => {
                    const sum = expenses.value.reduce((acc, cur) => acc + (parseFloat(cur.amount) || 0), 0);
                    return Math.round(sum * 100) / 100;
                });

                const paidByPerson = computed(() => {
                    const map = {};
                    const people = participants.value.length ? participants.value : ['æˆ‘'];
                    for (const p of people) map[p] = 0;
                    for (const e of expenses.value) {
                        const amt = parseFloat(e.amount) || 0;
                        const payer = e.payer || 'æˆ‘';
                        if (!map[payer]) map[payer] = 0;
                        map[payer] += amt;
                    }
                    return map;
                });

                const settlementPlan = computed(() => {
                    const people = Object.keys(paidByPerson.value);
                    if (!people.length) return [];
                    const total = Object.values(paidByPerson.value).reduce((a, b) => a + b, 0);
                    const avg = total / people.length;
                    const payers = [];
                    const receivers = [];
                    for (const p of people) {
                        const diff = Math.round((paidByPerson.value[p] - avg) * 100) / 100;
                        if (diff > 0) receivers.push({ name: p, amount: diff });
                        else if (diff < 0) payers.push({ name: p, amount: -diff });
                    }
                    payers.sort((a, b) => a.amount - b.amount);
                    receivers.sort((a, b) => b.amount - a.amount);
                    const plan = [];
                    let i = 0, j = 0;
                    while (i < payers.length && j < receivers.length) {
                        const pay = payers[i];
                        const recv = receivers[j];
                        const amt = Math.min(pay.amount, recv.amount);
                        plan.push({
                            from: pay.name,
                            to: recv.name,
                            amount: Math.round(amt * 100) / 100,
                        });
                        pay.amount -= amt;
                        recv.amount -= amt;
                        if (pay.amount <= 0.01) i++;
                        if (recv.amount <= 0.01) j++;
                    }
                    return plan;
                });

                const convertAmount = (amount) => {
                    const val = parseFloat(amount) || 0;
                    const rate = exchangeRate.value || 1;
                    return Math.round(val * rate * 100) / 100;
                };

                const convertToTwd = computed(() => {
                    const val = totalExpense.value;
                    const rate = exchangeRate.value || 1;
                    return Math.round(val * rate * 100) / 100;
                });

                const isMapLoading = ref(false);
                const userLocation = ref(null);

                const weather = ref({
                    location: '',
                    temp: null,
                    icon: 'â˜ï¸',
                    description: '',
                    daily: null
                });

                const currencyLabel = computed(() => {
                    if (!setup.value.destination) return 'å¹£åˆ¥';
                    const code = setup.value.countryCode || 'tw';
                    const map = {
                        'jp': 'æ—¥åœ“ (JPY)',
                        'kr': 'éŸ“åœ“ (KRW)',
                        'us': 'ç¾é‡‘ (USD)',
                        'cn': 'äººæ°‘å¹£ (CNY)',
                        'th': 'æ³°éŠ– (THB)',
                        'tw': 'æ–°å°å¹£ (TWD)'
                    };
                    return map[code] || 'å¹£åˆ¥';
                });

                const currencySymbol = computed(() => {
                    const code = setup.value.countryCode || 'tw';
                    const map = {
                        'jp': 'Â¥',
                        'kr': 'â‚©',
                        'us': '$',
                        'cn': 'Â¥',
                        'th': 'à¸¿',
                        'tw': 'NT$'
                    };
                    return map[code] || '';
                });

                const weatherDisplay = computed(() => {
                    if (!weather.value.daily) return null;
                    const arr = [];
                    const daily = weather.value.daily;
                    for (let i = 0; i < Math.min(5, daily.time.length); i++) {
                        arr.push({
                            date: daily.time[i],
                            tmax: daily.temperature_2m_max[i],
                            tmin: daily.temperature_2m_min[i],
                            code: daily.weathercode[i]
                        });
                    }
                    return arr;
                });

                const getWeatherIcon = (code) => {
                    if (code === 0) return 'â˜€ï¸';
                    if ([1, 2, 3].includes(code)) return 'â›…';
                    if ([45, 48].includes(code)) return 'ğŸŒ«ï¸';
                    if ([51, 53, 55, 56, 57].includes(code)) return 'ğŸŒ¦ï¸';
                    if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return 'ğŸŒ§ï¸';
                    if ([71, 73, 75, 77, 85, 86].includes(code)) return 'â„ï¸';
                    if ([95, 96, 99].includes(code)) return 'â›ˆï¸';
                    return 'â˜ï¸';
                };

                const showSetupModal = ref(false);
                const setup = ref({
                    destination: '',
                    startDate: '',
                    endDate: '',
                    daysCount: 3,
                    countryCode: 'jp',
                    rate: 0.22,
                });

                const toggleFlightCard = () => {
                    const day = currentDay.value;
                    if (!day) return;
                    if (!day.flight) {
                        day.flight = {
                            from: '',
                            to: '',
                            airline: '',
                            flightNo: '',
                            departTime: '',
                            arriveTime: '',
                            note: ''
                        };
                    } else {
                        day.flight = null;
                    }
                };

                const getDotColor = (type) => {
                    if (type === 'food') return 'bg-amber-400';
                    if (type === 'shop') return 'bg-emerald-400';
                    return 'bg-teal-400';
                };

                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';

                const addItem = () => currentDay.value.items.push({
                    time: '',
                    type: 'spot',
                    activity: '',
                    location: '',
                    note: '',
                    transport: '',
                    duration: '',
                    stayMinutes: 0
                });

                const removeItem = (idx) => currentDay.value.items.splice(idx, 1);
                const addDay = () => {
                    const idx = days.value.length + 1;
                    days.value.push({ date: `Day ${idx}`, shortDate: `D${idx}`, title: '', items: [], flight: null });
                };

                const draggingIndex = ref(null);
                const editModalVisible = ref(false);
                const editIndex = ref(null);
                const editForm = ref({
                    time: '',
                    activity: '',
                    location: '',
                    note: '',
                    transport: '',
                    type: 'spot',
                    stayHours: 0,
                    stayMinutes: 0
                });

                const estimatedLeaveTime = computed(() => {
                    if (!editModalVisible.value || !editForm.value.time) return '';
                    const [hStr, mStr] = editForm.value.time.split(':');
                    const baseH = parseInt(hStr || '0', 10);
                    const baseM = parseInt((mStr || '0').slice(0, 2), 10);
                    if (isNaN(baseH) || isNaN(baseM)) return '';
                    let total = baseH * 60 + baseM;
                    total += (editForm.value.stayHours || 0) * 60 + (editForm.value.stayMinutes || 0);
                    total = ((total % (24 * 60)) + (24 * 60)) % (24 * 60);
                    const hh = String(Math.floor(total / 60)).padStart(2, '0');
                    const mm = String(total % 60).padStart(2, '0');
                    return `${hh}:${mm}`;
                });

                const openEditModal = (idx) => {
                    const item = currentDay.value.items[idx];
                    if (!item) return;
                    editIndex.value = idx;
                    editForm.value.time = item.time || '';
                    editForm.value.activity = item.activity || '';
                    editForm.value.location = item.location || '';
                    editForm.value.note = item.note || '';
                    editForm.value.transport = item.transport || '';
                    editForm.value.type = item.type || 'spot';
                    const minutes = item.stayMinutes || 0;
                    editForm.value.stayHours = Math.floor(minutes / 60);
                    editForm.value.stayMinutes = minutes % 60;
                    editModalVisible.value = true;
                };

                const closeEditModal = () => {
                    editModalVisible.value = false;
                };

                const saveEdit = () => {
                    if (editIndex.value === null) return;
                    const list = currentDay.value.items;
                    const item = list[editIndex.value];
                    if (!item) return;
                    item.time = editForm.value.time;
                    item.activity = editForm.value.activity;
                    item.location = editForm.value.location;
                    item.note = editForm.value.note;
                    item.transport = editForm.value.transport;
                    item.type = editForm.value.type;
                    item.stayMinutes = (editForm.value.stayHours || 0) * 60 + (editForm.value.stayMinutes || 0);
                    editModalVisible.value = false;
                };

                const onDragStart = (idx) => {
                    draggingIndex.value = idx;
                };

                const onDrop = (idx) => {
                    if (draggingIndex.value === null || draggingIndex.value === idx) return;
                    const list = currentDay.value.items;
                    const moved = list.splice(draggingIndex.value, 1)[0];
                    list.splice(idx, 0, moved);
                    draggingIndex.value = null;
                };

                const removeCurrentDay = () => {
                    if (days.value.length > 1 && confirm('åˆªé™¤?')) {
                        days.value.splice(currentDayIdx.value, 1);
                        if (currentDayIdx.value >= days.value.length) currentDayIdx.value = days.value.length - 1;
                    }
                };

                const addExpense = () => {
                    if (!newExpense.value.item || !newExpense.value.amount) return;
                    expenses.value.unshift({ ...newExpense.value });
                    newExpense.value.item = '';
                    newExpense.value.amount = '';
                };

                const removeExpense = (idx) => expenses.value.splice(idx, 1);

                const updateParticipants = () => {
                    const arr = participantsStr.value
                        .split(',')
                        .map(s => s.trim())
                        .filter(Boolean);
                    if (arr.length) {
                        participants.value = arr;
                    } else {
                        participants.value = ['æˆ‘'];
                    }
                    if (!participants.value.includes(newExpense.value.payer)) {
                        newExpense.value.payer = participants.value[0] || 'æˆ‘';
                    }
                };

                const addParticipant = () => {
                    const baseName = 'æˆå“¡';
                    let idx = participants.value.length + 1;
                    let name = `${baseName}${idx}`;
                    while (participants.value.includes(name)) {
                        idx++;
                        name = `${baseName}${idx}`;
                    }
                    participants.value.push(name);
                };

                const removeParticipant = (idx) => {
                    if (participants.value.length <= 1) return;
                    const name = participants.value[idx];
                    if (!confirm(`è¦ç§»é™¤æˆå“¡ã€Œ${name}ã€ä»¥åŠä»–/å¥¹çš„æ‰€æœ‰æ”¯å‡ºå—ï¼Ÿ`)) return;
                    participants.value.splice(idx, 1);
                    expenses.value = expenses.value.filter(e => e.payer !== name);
                    if (!participants.value.includes(newExpense.value.payer)) {
                        newExpense.value.payer = participants.value[0] || '';
                    }
                };

                const renameParticipant = (idx, newName) => {
                    const oldName = participants.value[idx];
                    if (!oldName || !newName || oldName === newName) return;
                    participants.value[idx] = newName;
                    expenses.value.forEach(e => {
                        if (e.payer === oldName) e.payer = newName;
                    });
                };

                const getTimePeriod = (timeStr) => {
                    if (!timeStr) return '';
                    const [hRaw] = timeStr.split(':');
                    const h = parseInt(hRaw, 10);
                    if (isNaN(h)) return '';
                    if (h < 5) return 'æ·±å¤œ';
                    if (h < 11) return 'æ—©ä¸Š';
                    if (h < 14) return 'ä¸­åˆ';
                    if (h < 18) return 'ä¸‹åˆ';
                    if (h < 22) return 'æ™šä¸Š';
                    return 'æ·±å¤œ';
                };

                const updateDate = (event) => {
                    const val = event.target.value;
                    if (!val) return;
                    const d = currentDay.value;
                    d.date = val;
                    const baseLabel = new Date(val).toLocaleDateString('zh-TW', {
                        month: 'numeric',
                        day: 'numeric',
                    });
                    d.shortDate = baseLabel;
                    if (!d.title) {
                        d.title = 'è¡Œç¨‹';
                    }
                };

                const fetchWeather = async (locName) => {
                    try {
                        weather.value.location = locName;
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locName)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (geoData?.[0]) {
                            const { lat, lon } = geoData[0];
                            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=16`);
                            const wData = await wRes.json();
                            weather.value.temp = Math.round(wData.current_weather.temperature);
                            weather.value.icon = getWeatherIcon(wData.current_weather.weathercode);
                            if (wData.daily) weather.value.daily = wData.daily;
                        }
                    } catch (e) {
                        console.error('weather error', e);
                    }
                };

                const countryInfoMap = {
                    'jp': { c: 'JPY', l: 'ja', n: 'æ—¥æ–‡' },
                    'kr': { c: 'KRW', l: 'ko', n: 'éŸ“æ–‡' },
                    'us': { c: 'USD', l: 'en', n: 'è‹±æ–‡' },
                    'cn': { c: 'CNY', l: 'zh-CN', n: 'ç°¡ä¸­' },
                    'th': { c: 'THB', l: 'th', n: 'æ³°æ–‡' },
                    'tw': { c: 'TWD', l: 'zh-TW', n: 'ä¸­æ–‡' }
                };

                const detectRate = async () => {
                    if (!setup.value.destination) return;
                    isRateLoading.value = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(setup.value.destination)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (!geoData?.[0]) return;
                        const countryCodeGuess = (geoData[0].display_name || '').toLowerCase();
                        let code = 'tw';
                        if (countryCodeGuess.includes('japan') || countryCodeGuess.includes('æ—¥æœ¬')) code = 'jp';
                        else if (countryCodeGuess.includes('korea') || countryCodeGuess.includes('éŸ“åœ‹')) code = 'kr';
                        else if (countryCodeGuess.includes('united states') || countryCodeGuess.includes('usa') || countryCodeGuess.includes('ç¾åœ‹')) code = 'us';
                        else if (countryCodeGuess.includes('china') || countryCodeGuess.includes('ä¸­åœ‹') || countryCodeGuess.includes('ä¸­åœ‹å¤§é™¸')) code = 'cn';
                        else if (countryCodeGuess.includes('thailand') || countryCodeGuess.includes('æ³°åœ‹')) code = 'th';
                        setup.value.countryCode = code;
                        const info = countryInfoMap[code];
                        if (!info) return;
                        const fxRes = await fetch(`https://open.er-api.com/v6/latest/${info.c}`);
                        const fxData = await fxRes.json();
                        if (fxData?.rates?.TWD) {
                            exchangeRate.value = fxData.rates.TWD;
                            setup.value.rate = fxData.rates.TWD;
                        }
                    } catch (e) {
                        console.error('rate error', e);
                    } finally {
                        isRateLoading.value = false;
                    }
                };

                const initTrip = () => {
                    days.value = [];
                    const total = setup.value.daysCount || 3;
                    if (setup.value.startDate && setup.value.endDate) {
                        const start = new Date(setup.value.startDate);
                        const end = new Date(setup.value.endDate);
                        const diff = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        const count = diff > 0 ? diff : total;
                        for (let i = 0; i < count; i++) {
                            const d = new Date(start);
                            d.setDate(d.getDate() + i);
                            const dateLabel = d.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
                            days.value.push({
                                date: d.toISOString().slice(0, 10),
                                shortDate: dateLabel,
                                title: '',
                                items: [],
                                flight: null,
                            });
                        }
                    } else {
                        for (let i = 0; i < total; i++) {
                            days.value.push({
                                date: `Day ${i + 1}`,
                                shortDate: `D${i + 1}`,
                                title: '',
                                items: [],
                                flight: null,
                            });
                        }
                    }
                    currentDayIdx.value = 0;
                    showSetupModal.value = false;

                    const id = Date.now().toString();
                    currentTripId.value = id;
                    tripList.value.unshift({
                        id,
                        name: setup.value.destination || 'æœªå‘½åæ—…ç¨‹',
                        startDate: setup.value.startDate,
                        endDate: setup.value.endDate,
                    });
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                    if (setup.value.destination) fetchWeather(setup.value.destination);
                };

                const isOnlineComputed = computed(() => isOnline.value);

                const saveTripList = () => {
                    localStorage.setItem('travel_app_index', JSON.stringify(tripList.value));
                };
                const createNewTrip = () => {
                    setup.value 
                        = {
                            destination: '',
                            startDate: '',
                            endDate: '',
                            daysCount: 3,
                            countryCode: 'jp',
                            rate: 0.22,
                        };
                    showSetupModal.value = true;
                };
                const switchTrip = (id) => {
                    currentTripId.value = id;
                    showTripMenu.value = false;
                    const lDays = localStorage.getItem(`${id}_days`);
                    const lExp = localStorage.getItem(`${id}_exp`);
                    const lUsers = localStorage.getItem(`${id}_users`);
                    const lRate = localStorage.getItem(`${id}_rate`);
                    const lConf = localStorage.getItem(`${id}_config`);

                    if (lDays) days.value = JSON.parse(lDays);
                    if (lExp) expenses.value = JSON.parse(lExp);
                    if (lUsers) { participantsStr.value = lUsers; updateParticipants(); }
                    if (lRate) exchangeRate.value = parseFloat(lRate);
                    if (lConf) {
                        const conf = JSON.parse(lConf);
                        setup.value = conf;
                        exchangeRate.value = conf.rate || exchangeRate.value;
                        fetchWeather(conf.destination);
                    }
                };
                const deleteTrip = (id) => {
                    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ—…ç¨‹å—ï¼Ÿç›¸é—œè³‡æ–™æœƒä¸€ä½µåˆªé™¤ã€‚')) return;
                    tripList.value = tripList.value.filter(t => t.id !== id);
                    localStorage.removeItem(`${id}_days`);
                    localStorage.removeItem(`${id}_exp`);
                    localStorage.removeItem(`${id}_rate`);
                    localStorage.removeItem(`${id}_users`);
                    localStorage.removeItem(`${id}_config`);
                    saveTripList();
                    if (currentTripId.value === id) {
                        if (tripList.value[0]) {
                            switchTrip(tripList.value[0].id);
                        } else {
                            days.value = []; currentTripId.value = null; showSetupModal.value = true;
                        }
                    }
                };

                // ========= Leaflet åœ°åœ–æ ¸å¿ƒï¼šå®Œæ•´ç‰ˆ initMap =========
                const initMap = async () => { 
                    isMapLoading.value = true;
                    await nextTick();

                    const mapEl = document.getElementById('map');
                    if (!mapEl) {
                        isMapLoading.value = false;
                        return;
                    }

                    // æ¸…æ‰èˆŠåœ°åœ–
                    if (mapInstance) { 
                        mapInstance.remove(); 
                        mapInstance = null; 
                    }

                    // å»ºç«‹æ–°åœ°åœ– + åº•åœ–
                    mapInstance = L.map('map').setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstance);

                    // å•Ÿå‹• GPS è¿½è¹¤ä½¿ç”¨è€…ä½ç½®ï¼ˆè—è‰²å°é»ï¼‰
                    if ("geolocation" in navigator) {
                        if (geoWatchId !== null) {
                            navigator.geolocation.clearWatch(geoWatchId);
                        }

                        geoWatchId = navigator.geolocation.watchPosition(pos => {
                            userLocation.value = { 
                                lat: pos.coords.latitude, 
                                lng: pos.coords.longitude 
                            };

                            const icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: "<div class='gps-pulse'></div>",
                                iconSize: [14, 14]
                            });

                            if (userMarker) {
                                userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
                            } else {
                                userMarker = L.marker(
                                    [pos.coords.latitude, pos.coords.longitude], 
                                    { icon }
                                ).addTo(mapInstance);
                            }
                        }, err => {
                            console.warn('geo error', err);
                        }, { enableHighAccuracy: true });
                    }

                    // ç•¶å¤©è¡Œç¨‹æœ‰å¡« location çš„é …ç›® â†’ è½‰ marker
                    const locs = (currentDay.value?.items || []).filter(i => i.location);
                    const bounds = L.latLngBounds();

                    for (const item of locs) {
                        try {
                            // é¿å…æ‰“å¤ªå¿«è¢« Nominatim é™é€Ÿ
                            await new Promise(r => setTimeout(r, 500));

                            const res = await fetch(
                                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`
                            );
                            const d = await res.json();

                            if (d && d.length > 0) {
                                const lat = parseFloat(d[0].lat);
                                const lon = parseFloat(d[0].lon);

                                L.marker([lat, lon])
                                    .addTo(mapInstance)
                                    .bindPopup(`<b>${item.activity || ''}</b><br>${item.location || ''}`);

                                bounds.extend([lat, lon]);
                            }
                        } catch (e) {
                            console.error('geocode error', e);
                        }
                    }

                    isMapLoading.value = false;

                    if (locs.length > 0) {
                        mapInstance.fitBounds(bounds, { padding: [50, 50] });
                    }
                };

                // å®šä½æŒ‰éˆ•ï¼šæŠŠé¡é ­ç§»å‹•åˆ°ç›®å‰ userLocation
                const centerOnUser = () => { 
                    if (userLocation.value && mapInstance) {
                        mapInstance.flyTo(
                            [userLocation.value.lat, userLocation.value.lng], 
                            15
                        ); 
                    } else {
                        alert('å°šæœªå–å¾—å®šä½æˆ–åœ°åœ–å°šæœªè¼‰å…¥');
                    }
                };

                onMounted(() => {
                    isOnline.value = navigator.onLine;
                    window.addEventListener('online', () => (isOnline.value = true));
                    window.addEventListener('offline', () => (isOnline.value = false));

                    const storedTrips = localStorage.getItem('travel_app_index');
                    if (storedTrips) {
                        tripList.value = JSON.parse(storedTrips);
                    }
                    if (tripList.value.length) {
                        switchTrip(tripList.value[0].id);
                    } else {
                        showSetupModal.value = true;
                    }
                    
                    watch([days, expenses, exchangeRate, participantsStr], () => {
                        if (!currentTripId.value) return;
                        localStorage.setItem(`${currentTripId.value}_days`, JSON.stringify(days.value));
                        localStorage.setItem(`${currentTripId.value}_exp`, JSON.stringify(expenses.value));
                        localStorage.setItem(`${currentTripId.value}_rate`, exchangeRate.value.toString());
                        localStorage.setItem(`${currentTripId.value}_users`, participantsStr.value);
                    }, { deep: true });
                });

                // åˆ‡æ›åˆ°åº•åœ–æ¨¡å¼æ™‚ â†’ åˆå§‹åŒ–åœ°åœ–
                watch(viewMode, (v) => { 
                    if(v === 'map') initMap(); 
                });

                // åœ¨åœ°åœ–æ¨¡å¼ä¸‹åˆ‡æ› D1/D2... â†’ é‡æ–°åˆå§‹åŒ–ç•¶å¤©çš„ marker
                watch(currentDayIdx, () => { 
                    if (viewMode.value === 'map') initMap(); 
                });

                const searchNearby = async (item, idx) => {
                    if (!item.location || item.type !== 'food') return;
                    const modeKey = `${currentDayIdx.value}-${idx}`;
                    isSearchingRecs.value[modeKey] = true;
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}&limit=1`);
                        const geoData = await geoRes.json();
                        if (!geoData?.[0]) return;
                        const { lat, lon } = geoData[0];
                        const overpassQuery = `
                            [out:json][timeout:25];
                            (
                              node
                                ["amenity"~"restaurant|cafe|fast_food|food_court"]
                                (around:800,${lat},${lon});
                            );
                            out body;
                            >;
                            out skel qt;
                        `;
                        const overRes = await fetch('https://overpass-api.de/api/interpreter', {
                            method: 'POST',
                            body: overpassQuery,
                        });
                        const overData = await overRes.json();
                        const recs = (overData.elements || [])
                            .filter(e => e.tags && e.tags.name)
                            .slice(0, 10)
                            .map(e => ({
                                name: e.tags.name,
                                cuisine: e.tags.cuisine || '',
                                addr: e.tags['addr:full'] || '',
                                lat: e.lat,
                                lon: e.lon,
                            }));
                        recommendationsMap.value[modeKey] = recs;
                    } catch (e) {
                        console.error('search nearby error', e);
                    } finally {
                        isSearchingRecs.value[modeKey] = false;
                    }
                };

                const recommendationsMap = ref({});
                const isSearchingRecs = ref({});
                const searchTargetIndex = ref(null);

                const applyRecommendation = (dayIdx, itemIdx, rec) => {
                    if (!days.value[dayIdx] || !days.value[dayIdx].items[itemIdx]) return;
                    const item = days.value[dayIdx].items[itemIdx];
                    item.location = rec.name;
                    if (!item.activity) item.activity = rec.name;
                };

                const estimateDuration = async (idx) => {
                    const prev = currentDay.value.items[idx - 1];
                    const curr = currentDay.value.items[idx];
                    if (!prev.location || !curr.location) return;
                    const modeMap = {
                        walk: 'walking',
                        bus: 'driving',
                        train: 'transit',
                        taxi: 'driving'
                    };
                    const mode = modeMap[curr.transport] || 'walking';
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(prev.location)}&destination=${encodeURIComponent(curr.location)}&travelmode=${mode}`;
                    curr.duration = 'è«‹åœ¨ Google Maps ä¸­æŸ¥çœ‹æ™‚é–“å¾Œå¡«å¯«';
                    window.open(url, '_blank');
                };

                const daysToTrip = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return '';
                    const start = new Date(setup.value.startDate);
                    const end = new Date(setup.value.endDate);
                    const diff = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    if (diff <= 0) return '';
                    return `${diff} å¤© ${diff - 1} å¤œ`;
                });

                const tripDateRange = computed(() => {
                    if (!setup.value.startDate || !setup.value.endDate) return '';
                    const start = new Date(setup.value.startDate);
                    const end = new Date(setup.value.endDate);
                    const fmt = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
                    return `${fmt(start)} - ${fmt(end)}`;
                });

                return {
                    viewMode, currentDayIdx, days, currentDay,
                    participants, participantsStr,
                    addParticipant, removeParticipant, renameParticipant,
                    getGoogleMapLink, addItem, removeItem, removeCurrentDay, addDay,
                    expenses, newExpense, totalExpense, addExpense, removeExpense,
                    paidByPerson, settlementPlan, exchangeRate,
                    isOnline, getTimePeriod, weather,
                    isMapLoading, userLocation, initMap, centerOnUser,
                    updateDate, showSetupModal, setup, initTrip, weatherDisplay, detectRate, isRateLoading,
                    currencyLabel, currencySymbol, toggleFlightCard, getDotColor,
                    showTripMenu, tripList, createNewTrip, switchTrip, deleteTrip, currentTripId,
                    searchNearby, recommendationsMap, isSearchingRecs, applyRecommendation, searchTargetIndex,
                    convertAmount, convertToTwd,
                    daysToTrip, tripDateRange,
                    checklistSections, checklistStats, sectionProgress,
                    addChecklistItem, removeChecklistItem, toggleChecklistItem,
                    estimateDuration,
                    draggingIndex, editModalVisible, editIndex, editForm,
                    estimatedLeaveTime, openEditModal, closeEditModal, saveEdit,
                    onDragStart, onDrop
                };
            }
        }).mount('#app')
    </script>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet for map -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Google Font -->
    <link
        rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
    />

    <style>
        body {
            font-family: 'Noto Sans TC', system-ui, -apple-system, BlinkMacSystemFont,
                'Segoe UI', sans-serif;
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }
        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* ä½¿ç”¨è€… GPS å°åœ“é»å‹•ç•«ï¼ˆLeaflet divIcon ç”¨ï¼‰ */
        .custom-div-icon .gps-pulse {
            width: 14px;
            height: 14px;
            border-radius: 9999px;
            background: #38bdf8;
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.4);
            animation: gps-pulse 1.5s infinite;
        }

        @keyframes gps-pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.8);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-50">
    <div id="app" class="min-h-screen flex flex-col max-w-md mx-auto bg-slate-950 text-slate-50">
        <!-- Header -->
        <header class="px-4 pt-4 pb-2 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-900 border-b border-slate-800 shadow-sm">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-teal-500/10 border border-teal-400/40">
                        <i class="ph-bold ph-suitcase-rolling text-teal-300 text-xl"></i>
                    </span>
                    <div>
                        <h1 class="text-base font-bold tracking-tight flex items-center gap-1.5">
                            æˆ‘çš„æ—…éŠè¨ˆç•«
                            <span
                                v-if="tripDateRange"
                                class="text-[11px] font-medium text-teal-300 bg-teal-500/10 px-1.5 py-0.5 rounded-full border border-teal-500/30"
                            >
                                {{ tripDateRange }}
                            </span>
                        </h1>
                        <p class="text-[11px] text-slate-400">
                            é¸æ“‡æ—¥æœŸã€ç·¨æ’è¡Œç¨‹ã€è¨˜å¸³èˆ‡åˆ†å¸³ï¼Œä¸€é æå®š
                        </p>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <button
                        @click="showTripMenu = !showTripMenu"
                        class="flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900/80 hover:bg-slate-800 border border-slate-700 text-[11px]"
                    >
                        <i class="ph-bold ph-map-trifold text-xs text-emerald-300"></i>
                        <span v-if="tripList.length" class="truncate max-w-[90px]">
                            {{ tripList[0]?.name || 'æ—…ç¨‹åˆ—è¡¨' }}
                        </span>
                        <span v-else>å»ºç«‹æ—…ç¨‹</span>
                        <i class="ph-bold ph-caret-down text-[10px] text-slate-400"></i>
                    </button>
                    <span
                        class="inline-flex items-center gap-1 text-[10px]"
                        :class="isOnline ? 'text-emerald-300' : 'text-amber-300'"
                    >
                        <span
                            class="w-1.5 h-1.5 rounded-full"
                            :class="isOnline ? 'bg-emerald-400' : 'bg-amber-400'"
                        ></span>
                        {{ isOnline ? 'å·²é€£ç·š' : 'é›¢ç·šæ¨¡å¼' }}
                    </span>
                </div>
            </div>

            <!-- Trip dropdown -->
            <transition name="fade">
                <div
                    v-if="showTripMenu"
                    class="mt-2 bg-slate-900/95 border border-slate-700 rounded-2xl shadow-lg p-2 max-h-60 overflow-y-auto hide-scroll"
                >
                    <div class="flex items-center justify-between mb-1 px-1">
                        <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                            <i class="ph-bold ph-map-pin-line text-teal-300"></i>
                            æˆ‘çš„æ—…ç¨‹
                        </p>
                        <button
                            @click="createNewTrip"
                            class="flex items-center gap-1 text-[11px] text-teal-300 hover:text-teal-100"
                        >
                            <i class="ph-bold ph-plus-circle text-xs"></i> æ–°å¢
                        </button>
                    </div>
                    <div v-if="!tripList.length" class="text-[11px] text-slate-400 px-1 py-2">
                        é‚„æ²’æœ‰æ—…ç¨‹ï¼Œé»å³ä¸Šè§’ã€Œæ–°å¢ã€é–‹å§‹å§ï¼
                    </div>
                    <div
                        v-for="trip in tripList"
                        :key="trip.id"
                        class="flex items-center justify-between px-2 py-1.5 rounded-xl hover:bg-slate-800 cursor-pointer group"
                    >
                        <div
                            class="flex-1 min-w-0"
                            @click="switchTrip(trip.id)"
                        >
                            <p class="text-xs font-medium truncate">
                                {{ trip.name || 'æœªå‘½åæ—…ç¨‹' }}
                            </p>
                            <p class="text-[10px] text-slate-400">
                                <span v-if="trip.startDate && trip.endDate">
                                    {{ trip.startDate }} ~ {{ trip.endDate }}
                                </span>
                                <span v-else class="italic">æœªè¨­å®šæ—¥æœŸ</span>
                            </p>
                        </div>
                        <button
                            @click.stop="deleteTrip(trip.id)"
                            class="ml-2 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-rose-400"
                        >
                            <i class="ph-bold ph-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- Day tabs -->
            <div class="mt-3 flex items-center gap-1 overflow-x-auto hide-scroll pb-1">
                <button
                    v-for="(d, idx) in days"
                    :key="idx"
                    @click="currentDayIdx = idx"
                    class="px-2 py-1 rounded-xl border text-[11px] flex flex-col items-start min-w-[64px]"
                    :class="currentDayIdx === idx
                        ? 'border-teal-400/70 bg-teal-500/10 text-teal-200'
                        : 'border-slate-700 bg-slate-900/60 text-slate-300 hover:bg-slate-800/80'"
                >
                    <span class="font-bold text-xs tracking-tight">
                        D{{ idx + 1 }}
                    </span>
                    <span class="text-[10px]">
                        {{ d.shortDate || d.date || `ç¬¬ ${idx+1} å¤©` }}
                    </span>
                </button>
                <button
                    @click="addDay"
                    class="ml-1 px-2 py-1 rounded-xl border border-dashed border-slate-600 text-[11px] flex items-center gap-1 text-slate-300 hover:border-teal-400 hover:text-teal-200"
                >
                    <i class="ph-bold ph-plus text-xs"></i>
                    æ–°å¢
                </button>
            </div>
        </header>        

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gradient-to-b from-slate-900 via-slate-900 to-slate-950 relative hide-scroll pb-24">

            <!-- è¡Œç¨‹è¡¨ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 space-y-6">
                    <!-- ä»Šæ—¥æ‘˜è¦ + å¤©æ°£ -->
                    <div class="bg-slate-800/90 p-4 rounded-2xl shadow-sm border border-slate-700 flex justify-between items-start">
                        <div class="flex-1 relative pt-0.5">
                            <!-- éš±å½¢æ—¥æœŸé¸æ“‡å™¨ -->
                            <input type="date" :value="currentDay.date?.length === 10 ? currentDay.date : ''" @change="updateDate"
                                class="absolute top-0 left-0 w-40 h-8 opacity-0 z-20 cursor-pointer">
                            <!-- æ—¥æœŸé¡¯ç¤º -->
                            <input
                                v-model="currentDay.date"
                                class="text-lg font-bold text-slate-50 bg-transparent border-none p-0 focus:ring-0 w-full relative z-10 pointer-events-none"
                                placeholder="Day 1 (é»æ“Šè¨­å®š)">
                            <input
                                v-model="currentDay.title"
                                class="text-sm text-slate-200 bg-transparent border-b border-dotted border-slate-500 focus:border-teal-400 focus:outline-none w-full mt-1"
                                placeholder="å¹«é€™ä¸€å¤©å–å€‹æ¨™é¡Œå§ï¼Œä¾‹å¦‚ï¼šä¸Šé‡ & é˜¿ç¾æ©«ç”º">
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="flex items-center gap-2 text-xs text-slate-200">
                                <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-900 text-lg">
                                    {{ weather.icon }}
                                </span>
                                <div class="flex flex-col items-end">
                                    <span class="font-bold text-sm" v-if="weather.temp !== null">
                                        {{ weather.temp }}Â°C
                                    </span>
                                    <span class="text-[10px] text-slate-400">
                                        {{ weather.location || 'å°šæœªè¨­å®šåŸå¸‚' }}
                                    </span>
                                </div>
                            </div>
                            <button
                                @click="setup.destination ? fetchWeather(setup.destination) : null"
                                class="mt-1 px-2 py-1 text-[10px] rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200 flex items-center gap-1"
                            >
                                <i class="ph-bold ph-cloud-sun text-xs"></i>
                                æ›´æ–°å¤©æ°£
                            </button>
                        </div>
                    </div>

                    <!-- å¤©æ°£é å ± -->
                    <div v-if="weatherDisplay" class="bg-slate-800/80 rounded-2xl p-3 border border-slate-700">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                                <i class="ph-bold ph-calendar-blank text-teal-300 text-sm"></i>
                                5 æ—¥å¤©æ°£é å ±
                            </p>
                            <span class="text-[10px] text-slate-400">
                                è³‡æ–™ä¾†æºï¼šOpen-Meteo
                            </span>
                        </div>
                        <div class="flex gap-2 justify-between">
                            <div
                                v-for="(d, idx) in weatherDisplay"
                                :key="idx"
                                class="flex-1 flex flex-col items-center gap-1 rounded-xl bg-slate-900/60 border border-slate-700 px-1.5 py-1.5"
                            >
                                <span class="text-[10px] text-slate-400">
                                    {{ new Date(d.date).toLocaleDateString('zh-TW', { weekday: 'short' }) }}
                                </span>
                                <span class="text-lg">
                                    {{ getWeatherIcon(d.code) }}
                                </span>
                                <span class="text-[10px] text-slate-200">
                                    {{ Math.round(d.tmin) }}Â° - {{ Math.round(d.tmax) }}Â°
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- èˆªç­å¡ç‰‡ -->
                    <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-2xl bg-gradient-to-br from-sky-500/20 to-emerald-400/30 flex items-center justify-center border border-slate-600">
                                    <i class="ph-bold ph-airplane-tilt text-sky-300 text-lg"></i>
                                </div>
                                <div>
                                    <p class="text-xs font-semibold text-slate-200">
                                        ä»Šæ—¥èˆªç­è³‡è¨Š
                                    </p>
                                    <p class="text-[10px] text-slate-400">
                                        å‡ºç™¼ / æŠµé”æ™‚é–“ã€èˆªç©ºå…¬å¸ã€å‚™è¨»
                                    </p>
                                </div>
                            </div>
                            <button
                                class="text-[11px] flex items-center gap-1 px-2 py-1 rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200"
                                @click="toggleFlightCard"
                            >
                                <i class="ph-bold ph-pencil-simple text-xs"></i>
                                {{ currentDay.flight ? 'æ”¶åˆ' : 'æ–°å¢' }}
                            </button>
                        </div>

                        <transition name="fade">
                            <div v-if="currentDay.flight" class="mt-2 space-y-2 bg-slate-900/70 rounded-xl border border-slate-700/80 p-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">å‡ºç™¼åœ°</label>
                                        <input
                                            v-model="currentDay.flight.from"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                            placeholder="å°åŒ— TPE"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">ç›®çš„åœ°</label>
                                        <input
                                            v-model="currentDay.flight.to"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                            placeholder="æ±äº¬ NRT / HND"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">èˆªç©ºå…¬å¸</label>
                                        <input
                                            v-model="currentDay.flight.airline"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                            placeholder="ä¾‹å¦‚ï¼šé•·æ¦®ã€è¯èˆªã€è™èˆª..."
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">èˆªç­ç·¨è™Ÿ</label>
                                        <input
                                            v-model="currentDay.flight.flightNo"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                            placeholder="BR198 / CI100..."
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">èµ·é£›æ™‚é–“</label>
                                        <input
                                            v-model="currentDay.flight.departTime"
                                            type="time"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                        />
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-400 mb-0.5">æŠµé”æ™‚é–“</label>
                                        <input
                                            v-model="currentDay.flight.arriveTime"
                                            type="time"
                                            class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-400 mb-0.5">å‚™è¨»</label>
                                    <textarea
                                        v-model="currentDay.flight.note"
                                        rows="2"
                                        class="w-full text-xs rounded-lg bg-slate-900 border border-slate-700 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                        placeholder="è£œå……èˆªç«™è³‡è¨Šã€è¡Œæè¨—é‹ã€è½‰æ©Ÿè³‡è¨Šç­‰"
                                    ></textarea>
                                </div>
                            </div>
                        </transition>
                        <button
                            v-if="currentDay.flight"
                            @click="toggleFlightCard"
                            class="mt-2 w-full py-2 border border-slate-700/80 rounded-xl text-[11px] text-slate-300 hover:border-rose-500/70 hover:text-rose-300 flex items-center justify-center gap-1"
                        >
                            <i class="ph-bold ph-airplane-slash text-xs"></i>
                            åˆªé™¤ç•¶æ—¥èˆªç­è³‡è¨Š
                        </button>
                        <button
                            v-else
                            @click="toggleFlightCard"
                            class="mt-1 w-full py-3 border border-dashed border-slate-700/80 rounded-xl text-[11px] text-slate-300 hover:border-teal-500/70 hover:text-teal-200 flex items-center justify-center gap-2 group"
                        >
                            <i class="ph-bold ph-airplane-tilt text-lg group-hover:scale-110 transition-transform"></i>
                            <span class="text-sm font-bold">æ–°å¢ç•¶æ—¥èˆªç­è³‡è¨Š</span>
                        </button>
                    </div>

                    <!-- è¡Œç¨‹ Timelineï¼ˆæ‹–æ›³æ’åº + Modal ç·¨è¼¯ï¼‰ -->
                    <div class="space-y-4 mt-4">
                        <!-- ä¸Šæ–¹ï¼šæ“ä½œåˆ— -->
                        <div class="flex items-center justify-between gap-2 mb-1">
                            <div class="text-xs text-slate-400">
                                æ‹–æ›³å¡ç‰‡å¯èª¿æ•´é †åºï¼Œé»ä¸€ä¸‹å¯ç·¨è¼¯è©³ç´°å…§å®¹
                            </div>
                            <div class="flex items-center gap-2">
                                <button
                                    @click="addItem"
                                    class="flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-teal-700/30 text-teal-200 border border-teal-500/60 hover:bg-teal-600/40"
                                >
                                    <i class="ph-bold ph-plus"></i>
                                    æ–°å¢è¡Œç¨‹
                                </button>
                                <button
                                    @click="removeCurrentDay"
                                    class="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-slate-800 text-slate-300 border border-slate-600 hover:border-red-400 hover:text-red-300"
                                >
                                    <i class="ph-bold ph-trash"></i>
                                    åˆªé™¤é€™ä¸€å¤©
                                </button>
                            </div>
                        </div>

                        <!-- Timeline ä¸»é«” -->
                        <div class="relative pl-4 border-l border-slate-700 space-y-3">
                            <div
                                v-for="(item, idx) in currentDay.items"
                                :key="idx"
                                class="relative group"
                                draggable="true"
                                @dragstart="onDragStart(idx)"
                                @dragover.prevent
                                @drop="onDrop(idx)"
                            >
                                <!-- ç¯€é» -->
                                <div
                                    class="absolute -left-[21px] top-1/2 -translate-y-1/2 w-3 h-3 rounded-full border-2 border-slate-900 shadow-sm"
                                    :class="getDotColor(item.type)"
                                ></div>

                                <!-- è¡Œç¨‹å¡ç‰‡ -->
                                <div
                                    class="bg-slate-800/90 hover:bg-slate-800 rounded-2xl border border-slate-700/80 hover:border-teal-400/70 shadow-sm hover:shadow-lg transition flex items-center gap-3 px-3 py-2 cursor-pointer"
                                    @click="openEditModal(idx)"
                                >
                                    <!-- å·¦ï¼šæ™‚é–“ -->
                                    <div class="flex flex-col items-center justify-center w-[3.5rem]">
                                        <div class="text-[10px] text-slate-400 mb-0.5">
                                            {{ getTimePeriod(item.time) }}
                                        </div>
                                        <div class="text-lg font-mono font-semibold text-slate-50">
                                            {{ item.time || '--:--' }}
                                        </div>
                                    </div>

                                    <!-- ä¸­ï¼šæ¨™é¡Œ + åœ°é» -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <p class="text-sm font-semibold text-slate-50 truncate">
                                                {{ item.activity || 'è¡Œç¨‹å…§å®¹' }}
                                            </p>
                                            <span
                                                v-if="item.transport"
                                                class="inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded-full bg-slate-900/70 text-slate-300 border border-slate-600"
                                            >
                                                <i class="ph-bold ph-route text-[11px]"></i>
                                                {{ item.transport }}
                                            </span>
                                        </div>
                                        <p
                                            v-if="item.location"
                                            class="text-[11px] text-slate-300 mt-0.5 truncate"
                                        >
                                            {{ item.location }}
                                        </p>
                                        <p
                                            v-if="item.note"
                                            class="text-[11px] text-slate-400 mt-0.5 overflow-hidden text-ellipsis whitespace-nowrap"
                                        >
                                            {{ item.note }}
                                        </p>
                                    </div>

                                    <!-- å³ï¼šæ“ä½œ -->
                                    <div class="flex flex-col items-end gap-1">
                                        <button
                                            class="p-1 rounded-full hover:bg-slate-700"
                                            @click.stop="openEditModal(idx)"
                                            title="ç·¨è¼¯"
                                        >
                                            <i class="ph-bold ph-note-pencil text-xs"></i>
                                        </button>
                                        <button
                                            class="p-1 rounded-full hover:bg-slate-700"
                                            @click.stop="removeItem(idx)"
                                            title="åˆªé™¤"
                                        >
                                            <i class="ph-bold ph-trash text-xs text-rose-400"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- æ²’æœ‰è¡Œç¨‹ -->
                            <div
                                v-if="currentDay.items.length === 0"
                                class="text-xs text-slate-400 text-center py-6"
                            >
                                é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸Šæ–¹ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹è¦åŠƒå§ï¼
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- ç·¨è¼¯è¡Œç¨‹ Modal -->
            <transition name="fade">
                <div
                    v-if="viewMode === 'plan' && editModalVisible'
                    class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/80 px-4"
                >
                    <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-xl p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-bold text-slate-50 flex items-center gap-1">
                                <i class="ph-bold ph-map-pin text-teal-400"></i>
                                ç·¨è¼¯è¡Œç¨‹
                            </h2>
                            <button
                                @click="closeEditModal"
                                class="text-slate-400 hover:text-slate-100"
                            >
                                <i class="ph-bold ph-x text-lg"></i>
                            </button>
                        </div>

                        <div class="space-y-3 text-sm">
                            <div>
                                <label class="block mb-1 text-slate-300 text-xs">æ™‚é–“</label>
                                <input
                                    v-model="editForm.time"
                                    type="time"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                />
                            </div>

                            <div>
                                <label class="block mb-1 text-slate-300 text-xs">è¡Œç¨‹æ¨™é¡Œ</label>
                                <input
                                    v-model="editForm.activity"
                                    type="text"
                                    placeholder="ä¾‹å¦‚ï¼šä¸Šé‡å…¬åœ’æ•£æ­¥"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                />
                            </div>

                            <div>
                                <label class="block mb-1 text-slate-300 text-xs">åœ°é»åç¨± / åœ°å€</label>
                                <input
                                    v-model="editForm.location"
                                    type="text"
                                    placeholder="è¼¸å…¥åœ°é»ï¼Œæ–¹ä¾¿ä¹‹å¾Œé–‹åœ°åœ–æˆ–æŸ¥é¤å»³"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                />
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block mb-1 text-slate-300 text-xs">é¡å‹</label>
                                    <select
                                        v-model="editForm.type"
                                        class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    >
                                        <option value="spot">ğŸ“ æ™¯é»</option>
                                        <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                        <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-1 text-slate-300 text-xs">äº¤é€šæ–¹å¼</label>
                                    <input
                                        v-model="editForm.transport"
                                        type="text"
                                        placeholder="æ­¥è¡Œ / åœ°éµ / å·´å£«..."
                                        class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    />
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 text-slate-300 text-xs">å‚™è¨»</label>
                                <textarea
                                    v-model="editForm.note"
                                    rows="3"
                                    placeholder="å¯ä»¥è£œå……é›†åˆåœ°é»ã€è¨‚ä½è³‡è¨Šã€ç¥¨åˆ¸ç·¨è™Ÿç­‰"
                                    class="w-full rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                ></textarea>
                            </div>

                            <div>
                                <label class="block mb-1 text-slate-300 text-xs">åœç•™æ™‚é–“</label>
                                <div class="flex items-center gap-2">
                                    <select
                                        v-model.number="editForm.stayHours"
                                        class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    >
                                        <option :value="h" v-for="h in [0,1,2,3,4,5]" :key="'h'+h">
                                            {{ h }} å°æ™‚
                                        </option>
                                    </select>
                                    <select
                                        v-model.number="editForm.stayMinutes"
                                        class="flex-1 rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 text-slate-100 text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/70"
                                    >
                                        <option :value="m" v-for="m in [0,15,30,45]" :key="'m'+m">
                                            {{ m }} åˆ†é˜
                                        </option>
                                    </select>
                                </div>
                                <div class="border-t border-slate-700 pt-2 mt-2 text-[11px] flex items-center justify-between text-slate-300">
                                    <span>é ä¼°é›¢é–‹æ™‚é–“</span>
                                    <span class="font-mono text-teal-300">
                                        {{ estimatedLeaveTime || '--:--' }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 flex justify-end gap-2 text-sm">
                            <button
                                @click="closeEditModal"
                                class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                @click="saveEdit"
                                class="px-3 py-1.5 rounded-full bg-teal-500 text-slate-900 font-semibold hover:bg-teal-400"
                            >
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- åœ°åœ–è¦–åœ– -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                <div id="map" class="flex-1 w-full h-full bg-slate-800 z-0"></div>
                <div v-if="isMapLoading" class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm z-10 flex flex-col items-center justify-center text-teal-200">
                    <i class="ph-duotone ph-spinner animate-spin text-4xl mb-2"></i>
                    <span class="text-xs font-bold">è®€å–ä¸­...</span>
                </div>
                <div class="absolute bottom-24 left-4 right-4 bg-slate-900/95 rounded-2xl border border-slate-700 z-10 flex justify-between items-center">
                    <div class="text-sm font-bold text-slate-100 px-3 py-2 flex items-center gap-2">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-xl bg-teal-500/10 border border-teal-400/40">
                            <i class="ph-bold ph-map-pin-line text-teal-300 text-sm"></i>
                        </span>
                        <span>ğŸ“ {{ currentDay.items.filter(i=>i.location).length }} å€‹åœ°é»</span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="initMap" class="p-2 bg-slate-900/80 text-teal-200 rounded-lg border border-slate-600 hover:bg-slate-700">
                            <i class="ph-bold ph-arrows-clockwise"></i>
                        </button>
                        <button @click="centerOnUser" class="p-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-400">
                            <i class="ph-bold ph-crosshair"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†å¸³è¦–åœ– -->
            <div v-if="viewMode === 'money'" class="p-4 space-y-4">
                <div class="bg-gradient-to-br from-teal-700 via-emerald-600 to-cyan-600 text-white rounded-2xl p-6 shadow-lg text-center relative">
                    <div class="absolute top-4 right-4 flex flex-col items-end">
                        <label class="text-[10px] text-teal-100 mb-1">åŒ¯ç‡ ({{ currencyLabel }})</label>
                        <input v-model.number="exchangeRate" type="number" step="0.01"
                            class="w-20 text-right text-xs text-teal-900 rounded px-1 py-0.5">
                    </div>
                    <p class="text-xs font-semibold text-teal-100 mb-1 flex items-center justify-center gap-1">
                        <i class="ph-bold ph-currency-circle-dollar"></i>
                        ç›®å‰æ¶ˆè²»ç¸½é¡
                    </p>
                    <p class="text-3xl font-extrabold tracking-tight mb-1">
                        {{ totalExpense.toLocaleString() }} {{ currencySymbol }}
                    </p>
                    <p class="text-xs text-teal-100">
                        ç´„ {{ convertToTwd.toLocaleString() }} æ–°å°å¹£ (ä¼°ç®—)
                    </p>
                </div>

                <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                            <i class="ph-bold ph-users-three text-emerald-300"></i>
                            åˆ†å¸³æˆå“¡èˆ‡æ”¯ä»˜æƒ…æ³
                        </p>
                        <button
                            @click="addParticipant"
                            class="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200"
                        >
                            <i class="ph-bold ph-user-plus text-xs"></i>
                            æ–°å¢æˆå“¡
                        </button>
                    </div>
                    <div class="bg-slate-900/70 rounded-xl border border-slate-700 p-2 space-y-1 max-h-40 overflow-y-auto hide-scroll">
                        <div
                            v-for="(p, idx) in participants"
                            :key="idx"
                            class="flex items-center justify-between gap-2 px-2 py-1 rounded-lg hover:bg-slate-800/80"
                        >
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-emerald-500/10 border border-emerald-400/40 flex items-center justify-center text-[11px] text-emerald-200">
                                    {{ p[0] || '?' }}
                                </div>
                                <div class="flex flex-col">
                                    <input
                                        :value="p"
                                        @change="renameParticipant(idx, $event.target.value)"
                                        class="bg-transparent border-none text-xs text-slate-100 focus:outline-none focus:ring-0"
                                    />
                                    <span class="text-[10px] text-slate-400">
                                        å·²æ”¯ä»˜ï¼š{{ (paidByPerson[p] || 0).toLocaleString() }} {{ currencySymbol }}
                                    </span>
                                </div>
                            </div>
                            <button
                                v-if="participants.length > 1"
                                @click="removeParticipant(idx)"
                                class="text-slate-500 hover:text-rose-400"
                            >
                                <i class="ph-bold ph-x text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3 space-y-3">
                    <div class="flex items-center justify-between mb-1">
                        <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                            <i class="ph-bold ph-shopping-cart-simple text-emerald-300"></i>
                            è¨˜å¸³
                        </p>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <input
                            v-model="newExpense.item"
                            class="flex-1 text-xs rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                            placeholder="æ¶ˆè²»é …ç›®ï¼Œä¾‹å¦‚ï¼šåˆé¤ã€è»Šç¥¨..."
                        />
                        <input
                            v-model.number="newExpense.amount"
                            type="number"
                            step="1"
                            class="w-20 text-xs rounded-xl bg-slate-900 border border-slate-700 px-2 py-1 text-right focus:outline-none focus:ring-1 focus:ring-teal-400"
                            placeholder="é‡‘é¡"
                        />
                        <select
                            v-model="newExpense.payer"
                            class="w-20 text-[11px] rounded-xl bg-slate-900 border border-slate-700 px-1 py-1 focus:outline-none focus:ring-1 focus:ring-teal-400"
                        >
                            <option v-for="p in participants" :key="p" :value="p">
                                {{ p }}
                            </option>
                        </select>
                        <button
                            @click="addExpense"
                            class="px-2 py-1 rounded-xl bg-teal-500 text-slate-950 text-xs font-semibold hover:bg-teal-400"
                        >
                            æ–°å¢
                        </button>
                    </div>
                    <div class="space-y-1 max-h-44 overflow-y-auto hide-scroll">
                        <div
                            v-for="(e, idx) in expenses"
                            :key="idx"
                            class="flex items-center justify-between px-2 py-1 rounded-lg bg-slate-900/70 border border-slate-700/80 text-xs"
                        >
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-slate-50 truncate">
                                    {{ e.item }}
                                </p>
                                <p class="text-[10px] text-slate-400">
                                    ç”± {{ e.payer }} æ”¯ä»˜
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="text-right">
                                    <p class="font-bold text-emerald-300">
                                        {{ e.amount.toLocaleString() }} {{ currencySymbol }}
                                    </p>
                                    <p class="text-[10px] text-slate-400">
                                        ç´„ {{ convertAmount(e.amount).toLocaleString() }} NTD
                                    </p>
                                </div>
                                <button
                                    @click="removeExpense(idx)"
                                    class="text-slate-500 hover:text-rose-400"
                                >
                                    <i class="ph-bold ph-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div v-if="!expenses.length" class="text-center text-[11px] text-slate-400 py-2">
                            é‚„æ²’æœ‰ä»»ä½•æ”¯å‡ºç´€éŒ„ï¼Œæ–°å¢ä¸€ç­†çœ‹çœ‹å§ï¼
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/90 rounded-2xl border border-slate-700 p-3">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-semibold text-slate-200 flex items-center gap-1">
                            <i class="ph-bold ph-handshake text-emerald-300"></i>
                            å»ºè­°èª°ä»˜èª°å¤šå°‘
                        </p>
                    </div>
                    <div v-if="settlementPlan.length" class="space-y-1 max-h-32 overflow-y-auto hide-scroll">
                        <div
                            v-for="(item, idx) in settlementPlan"
                            :key="idx"
                            class="flex items-center justify-between px-2 py-1 rounded-lg bg-slate-900/70 border border-slate-700/80 text-xs"
                        >
                            <div class="flex items-center gap-1">
                                <span class="font-semibold text-slate-50">{{ item.from }}</span>
                                <span class="text-[10px] text-slate-400">â†’</span>
                                <span class="font-semibold text-slate-50">{{ item.to }}</span>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-emerald-300">
                                    {{ item.amount.toLocaleString() }} {{ currencySymbol }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center text-[11px] text-slate-400 py-2">
                        ç›®å‰å°šæœªç”¢ç”Ÿåˆ†å¸³å»ºè­°ï¼Œè«‹å…ˆæ–°å¢æ”¯å‡ºèˆ‡æˆå“¡ã€‚
                    </div>
                </div>
            </div>

            <!-- æ¸…å–®è¦–åœ– -->
            <div v-if="viewMode === 'checklist'" class="p-4 space-y-4">
                <div class="bg-gradient-to-br from-emerald-600 via-teal-500 to-sky-500 text-slate-950 rounded-2xl p-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold flex items-center gap-1">
                            <i class="ph-bold ph-check-square-offset"></i>
                            è¡Œå‰æº–å‚™é€²åº¦
                        </p>
                        <p class="text-2xl font-extrabold tracking-tight mt-1">
                            {{ checklistStats.percent }}%
                        </p>
                        <p class="text-[11px] mt-0.5">
                            å·²å®Œæˆ {{ checklistStats.done }} / {{ checklistStats.total }} é …
                        </p>
                    </div>
                    <div class="w-16 h-16 rounded-full border-4 border-emerald-300/60 flex items-center justify-center bg-emerald-900/10">
                        <span class="text-lg font-bold">
                            {{ checklistStats.percent }}%
                        </span>
                    </div>
                </div>

                <div class="space-y-3">
                    <div
                        v-for="section in checklistSections"
                        :key="section.id"
                        class="bg-slate-800/90 rounded-2xl border border-slate-700 overflow-hidden"
                    >
                        <div :class="['px-3 py-2.5 flex items-center justify-between border-b border-slate-700/60 bg-gradient-to-r', section.color]">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-7 h-7 rounded-xl bg-slate-950/20 border border-white/40">
                                    <i :class="['ph-bold text-base', section.icon]"></i>
                                </span>
                                <div>
                                    <p class="text-xs font-semibold">
                                        {{ section.title }}
                                    </p>
                                    <p class="text-[10px] text-slate-900/80">
                                        å·²å®Œæˆ {{ section.items.filter(i => i.done).length }} / {{ section.items.length }} é …
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-16 h-1 rounded-full bg-slate-900/40 overflow-hidden">
                                    <div
                                        class="h-full rounded-full bg-emerald-300/80"
                                        :style="{ width: sectionProgress(section) + '%' }"
                                    ></div>
                                </div>
                                <span class="text-[10px] font-semibold">
                                    {{ sectionProgress(section) }}%
                                </span>
                            </div>
                        </div>
                        <div class="p-2">
                            <div class="space-y-1 max-h-40 overflow-y-auto hide-scroll">
                                <label
                                    v-for="item in section.items"
                                    :key="item.id"
                                    class="flex items-center justify-between gap-2 px-2 py-1 rounded-lg hover:bg-slate-800/80"
                                >
                                    <div class="flex items-center gap-2">
                                        <input
                                            type="checkbox"
                                            v-model="item.done"
                                            class="w-3.5 h-3.5 rounded border-slate-500 text-emerald-400 focus:ring-0"
                                        />
                                        <span
                                            class="text-[11px]"
                                            :class="item.done ? 'line-through text-slate-500' : 'text-slate-200'"
                                        >
                                            {{ item.text }}
                                        </span>
                                    </div>
                                    <button
                                        @click.stop="removeChecklistItem(section.id, item.id)"
                                        class="text-slate-500 hover:text-rose-400"
                                    >
                                        <i class="ph-bold ph-x text-xs"></i>
                                    </button>
                                </label>
                                <div v-if="!section.items.length" class="text-center text-[11px] text-slate-400 py-2">
                                    å°šæœªæ–°å¢é …ç›®
                                </div>
                            </div>
                            <button
                                @click="addChecklistItem(section.id)"
                                class="mt-2 w-full text-[11px] flex items-center justify-center gap-1 px-2 py-1 rounded-xl border border-slate-600 text-slate-300 hover:border-teal-400 hover:text-teal-200"
                            >
                                <i class="ph-bold ph-plus text-xs"></i>
                                æ–°å¢ä¸€é …
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-slate-950/95 border-t border-slate-800 backdrop-blur-md">
            <div class="max-w-md mx-auto flex">
                <button
                    @click="viewMode = 'plan'"
                    class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
                    :class="viewMode === 'plan' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-note-pencil mb-0.5 text-lg"></i>
                    è¡Œç¨‹
                </button>
                <button
                    @click="viewMode = 'map'"
                    class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
                    :class="viewMode === 'map' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-map-trifold mb-0.5 text-lg"></i>
                    åœ°åœ–
                </button>
                <button
                    @click="viewMode = 'money'"
                    class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
                    :class="viewMode === 'money' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-currency-circle-dollar mb-0.5 text-lg"></i>
                    åˆ†å¸³
                </button>
                <button
                    @click="viewMode = 'checklist'"
                    class="flex-1 flex flex-col items-center justify-center py-2 text-[11px]"
                    :class="viewMode === 'checklist' ? 'text-emerald-300' : 'text-slate-400 hover:text-slate-100'"
                >
                    <i class="ph-bold ph-clipboard-text mb-0.5 text-lg"></i>
                    æ¸…å–®
                </button>
            </div>
        </nav>

        <!-- Setup Modal -->
        <transition name="fade">
            <div
                v-if="showSetupModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 px-4"
            >
                <div class="w-full max-w-sm bg-slate-900 rounded-3xl border border-slate-700 shadow-2xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-2xl bg-emerald-500/10 border border-emerald-400/40">
                                <i class="ph-bold ph-map-pin-line text-emerald-300 text-lg"></i>
                            </span>
                            <div>
                                <h2 class="text-sm font-bold text-slate-50">å»ºç«‹æ–°æ—…ç¨‹</h2>
                                <p class="text-[10px] text-slate-400">
                                    å…ˆè¨­å®šç›®çš„åœ°èˆ‡æ—¥æœŸï¼Œæˆ‘æœƒå¹«ä½ ç”¢ç”ŸåŸºæœ¬è¡Œç¨‹æ¶æ§‹
                                </p>
                            </div>
                        </div>
                        <button
                            @click="showSetupModal = false"
                            class="text-slate-500 hover:text-slate-100"
                        >
                            <i class="ph-bold ph-x text-base"></i>
                        </button>
                    </div>
                    <div class="space-y-2 mt-2">
                        <div>
                            <label class="block text-[11px] text-slate-300 mb-0.5">
                                ç›®çš„åœ° / åŸå¸‚
                            </label>
                            <input
                                v-model="setup.destination"
                                class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€å¤§é˜ªã€é¦–çˆ¾..."
                            />
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[11px] text-slate-300 mb-0.5">
                                    å‡ºç™¼æ—¥
                                </label>
                                <input
                                    v-model="setup.startDate"
                                    type="date"
                                    class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                />
                            </div>
                            <div>
                                <label class="block text-[11px] text-slate-300 mb-0.5">
                                    å›ç¨‹æ—¥
                                </label>
                                <input
                                    v-model="setup.endDate"
                                    type="date"
                                    class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                />
                            </div>
                        </div>
                        <div class="grid grid-cols-[3fr,2fr] gap-2 items-end">
                            <div>
                                <label class="block text-[11px] text-slate-300 mb-0.5">
                                    é è¨ˆæ—…éŠå¤©æ•¸
                                </label>
                                <input
                                    v-model.number="setup.daysCount"
                                    type="number"
                                    min="1"
                                    class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                />
                                <p v-if="daysToTrip" class="mt-0.5 text-[10px] text-slate-400">
                                    ä¾ç…§æ—¥æœŸæ¨ç®—ï¼šç´„ {{ daysToTrip }}
                                </p>
                            </div>
                            <div>
                                <label class="block text-[11px] text-slate-300 mb-0.5">
                                    è‡ªè¨‚åŒ¯ç‡ (1 å¤–å¹£æ› NTD)
                                </label>
                                <input
                                    v-model.number="setup.rate"
                                    type="number"
                                    step="0.01"
                                    class="w-full text-xs rounded-xl bg-slate-800 border border-slate-600 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-teal-400"
                                />
                                <button
                                    @click="detectRate"
                                    class="mt-1 w-full text-[10px] px-2 py-1 rounded-lg bg-slate-800 text-slate-200 border border-slate-600 hover:border-teal-400 flex items-center justify-center gap-1"
                                >
                                    <i v-if="!isRateLoading" class="ph-bold ph-magic-wand text-xs"></i>
                                    <i v-else class="ph-bold ph-spinner text-xs animate-spin"></i>
                                    è‡ªå‹•åµæ¸¬åŒ¯ç‡
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end gap-2 text-[11px]">
                        <button
                            @click="showSetupModal = false"
                            class="px-3 py-1.5 rounded-full border border-slate-600 text-slate-200 hover:bg-slate-800"
                        >
                            å…ˆä¸ç”¨
                        </button>
                        <button
                            @click="initTrip"
                            class="px-3 py-1.5 rounded-full bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 flex items-center gap-1"
                        >
                            <i class="ph-bold ph-rocket-launch text-xs"></i>
                            å»ºç«‹æ—…ç¨‹
                        </button>
                    </div>
                </div>
            </div>
        </transition>
    </div>
</body>
</html>
